create or replace PACKAGE "XNT" AS 
--------------------------
--Version: 11
--Create by: Dao Viet Duong
--Edit: Nguyen Quang Huy: Update Gia Von GDQ
--UpdateDate: 15h20m: 13-03-2017
--------------------------
PROCEDURE XNT_CREATE_TABLE_TONKY(P_TABLENAME_KYTRUOC IN VARCHAR2,P_TABLENAME IN VARCHAR2, P_UNITCODE IN VARCHAR2, P_NAM IN NUMBER,P_KY IN NUMBER);
PROCEDURE XNT_KHOASO(P_TABLENAME_KYTRUOC IN VARCHAR2,P_TABLENAME IN VARCHAR2, P_UNITCODE IN VARCHAR2,P_NAM IN VARCHAR2,P_KY IN NUMBER);
PROCEDURE UPDATE_TONCUOIKYSL(P_TABLENAME IN VARCHAR2, P_MADONVI IN VARCHAR2,P_NAM IN VARCHAR2,P_KY IN NUMBER);
PROCEDURE XNT_TANG_TONKY(P_TABLENAME IN VARCHAR2, P_MADONVI IN VARCHAR2,P_NAM IN VARCHAR2,P_KY IN NUMBER,P_MANHOMPTNX IN VARCHAR2,P_TUNGAY DATE,P_DENNGAY DATE);
PROCEDURE XNT_GIAM_TONKY(P_TABLENAME IN VARCHAR2, P_MADONVI IN VARCHAR2,P_NAM IN VARCHAR2,P_KY IN NUMBER,P_MANHOMPTNX IN VARCHAR2,P_TUNGAY DATE,P_DENNGAY DATE);
PROCEDURE XNT_TANG_TONKY_KIEMKE(P_TABLENAME IN VARCHAR2, P_MADONVI IN VARCHAR2,P_NAM IN VARCHAR2,P_KY IN NUMBER,P_MANHOMPTNX IN VARCHAR2,P_TUNGAY DATE,P_DENNGAY DATE );
PROCEDURE XNT_GIAM_TONKY_KIEMKE(P_TABLENAME IN VARCHAR2, P_MADONVI IN VARCHAR2,P_NAM IN VARCHAR2,P_KY IN NUMBER,P_MANHOMPTNX IN VARCHAR2,P_TUNGAY DATE,P_DENNGAY DATE);
PROCEDURE XNT_TANG_PHIEU(P_TABLENAME IN VARCHAR2, P_NAM IN VARCHAR2,P_KY IN NUMBER,P_ID IN VARCHAR2);
PROCEDURE XNT_GIAM_PHIEU(P_TABLENAME IN VARCHAR2, P_NAM IN VARCHAR2,P_KY IN NUMBER,P_ID IN VARCHAR2);
PROCEDURE BAOCAO_XNT_TONGHOP(P_GROUPBY IN VARCHAR2, P_WAREHOUSE IN VARCHAR2, P_MALOAI IN VARCHAR2,  P_MANHOM IN VARCHAR2,P_MAVATTU IN VARCHAR2, P_MAKHACHHANG IN VARCHAR2,P_UNITCODE  IN VARCHAR2, P_TUNGAY IN DATE,P_DENNGAY IN DATE, XTNCOLLECTION  OUT SYS_REFCURSOR);
PROCEDURE BAOCAO_XNT_CHITIET(P_GROUPBY IN VARCHAR2, P_WAREHOUSE IN VARCHAR2, P_MALOAI IN VARCHAR2,  P_MANHOM IN VARCHAR2,P_MAVATTU IN VARCHAR2,P_MAKHACHHANG IN VARCHAR2,P_UNITCODE  IN VARCHAR2, P_TUNGAY IN DATE,P_DENNGAY IN DATE, cur  OUT SYS_REFCURSOR);  
PROCEDURE CAPNHAT_GIAVON_QUAYGIAODICH(P_TABLENAME IN VARCHAR, P_UNITCODE  IN VARCHAR2, P_NGAYPHATSINH IN DATE);
PROCEDURE XNT_TANGPHIEU_KIEMKE(P_TABLENAME IN VARCHAR2, P_NAM IN VARCHAR2,P_KY IN NUMBER,P_ID IN VARCHAR2);
PROCEDURE XNT_GIAMPHIEU_KIEMKE(P_TABLENAME IN VARCHAR2, P_NAM IN VARCHAR2,P_KY IN NUMBER,P_ID IN VARCHAR2);
PROCEDURE THONGKE_BANLE(P_NGAY IN DATE, P_UNITCODE IN VARCHAR2);
END XNT;
/
create or replace PACKAGE BODY "XNT" AS
--------------------------
--Version: 12
--Create by: Dao Viet Duong
--Edit: Nguyen Quang Huy: Update BAOCAO_XNT
--UpdateDate: PHẠM TUẤN ANH - 29-JUL-18
-- Cập nhật tính giá vốn theo giá nhập với trường hợp tăng tốn kỳ
--------------------------

PROCEDURE XNT_CREATE_TABLE_TONKY(P_TABLENAME_KYTRUOC IN VARCHAR2, P_TABLENAME  IN VARCHAR2, P_UNITCODE  IN VARCHAR2, P_NAM  IN NUMBER,P_KY  IN NUMBER) IS
   P_SQL  VARCHAR2(32767);  
   P_SQL_INSERT  VARCHAR2(32767);  
   P_SQL_DELETE VARCHAR2(32767);  
   N_COUNT NUMBER(17,4):=0;
   BEGIN
    P_SQL := 'CREATE TABLE '||P_TABLENAME||'(
    "UNITCODE" NVARCHAR2(20), "NAM" NVARCHAR2(50),"KY" NVARCHAR2(200),"MAKHO" NVARCHAR2(50),"MAVATTU" NVARCHAR2(50),
    "GIAVON" NUMBER(17,4) DEFAULT 0,
  "TONDAUKYSL" NUMBER(17,4) DEFAULT 0,
  "TONDAUKYGT" NUMBER(17,4) DEFAULT 0,
  "NHAPSL" NUMBER(17,4) DEFAULT 0,
    "NHAPGT" NUMBER(17,4) DEFAULT 0,
    "XUATSL" NUMBER(17,4) DEFAULT 0,
    "XUATGT" NUMBER(17,4) DEFAULT 0,
  "TONCUOIKYSL" NUMBER(17,4) DEFAULT 0, 
  "TONCUOIKYGT" NUMBER(17,4) DEFAULT 0
 ) SEGMENT CREATION IMMEDIATE PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 NOCOMPRESS LOGGING STORAGE
  (
    INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645 PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT
  )';

   P_SQL_INSERT :=       'INSERT INTO '||P_TABLENAME||' a
(a.UNITCODE, a.NAM, a.KY, a.MAKHO, a.MAVATTU, a.GIAVON, a.TONCUOIKYGT, a.TONCUOIKYSL, a.TONDAUKYGT, a.TONDAUKYSL)
SELECT UNITCODE, '||P_NAM||', '||P_KY||', MAKHO, MAVATTU, GIAVON, TONCUOIKYGT, TONCUOIKYSL, TONCUOIKYGT, TONCUOIKYSL FROM '||P_TABLENAME_KYTRUOC||' b WHERE b.UNITCODE = '''|| P_UNITCODE ||'''';
IF TRIM(P_TABLENAME_KYTRUOC) IS NULL THEN

 P_SQL_INSERT := 'DECLARE CURSOR KHO_Table IS SELECT MAKHO FROM DM_KHO WHERE UNITCODE=''' || P_UNITCODE || ''';
        BEGIN FOR KHO_Entiy IN KHO_Table LOOP
         BEGIN 
            INSERT INTO '|| P_TABLENAME ||'(UNITCODE,NAM,KY,MAKHO,MAVATTU) 
             SELECT '''|| P_UNITCODE ||''' AS UNITCODE,'||P_NAM||' AS NAM,'||P_KY||' AS KY,KHO_Entiy.MAKHO AS MAKHO,MAVATTU FROM DM_VATTU;
          END;
         END LOOP;
        END;';
        END IF;
  BEGIN
    SELECT COUNT(*)  INTO N_COUNT  FROM ALL_TAB_COLUMNS  WHERE TABLE_NAME = UPPER(P_TABLENAME);
    EXCEPTION WHEN OTHERS THEN N_COUNT:=0;
  END;
  IF(N_COUNT IS NULL OR N_COUNT<=0) THEN
    BEGIN
        DBMS_OUTPUT.PUT_LINE(P_SQL_INSERT);
        EXECUTE IMMEDIATE P_SQL;    
    END;
    END IF;  
	BEGIN
	P_SQL_DELETE:='DELETE FROM '||P_TABLENAME||' WHERE UNITCODE=''' || P_UNITCODE || '''';
	EXECUTE IMMEDIATE P_SQL_DELETE;   
	EXECUTE IMMEDIATE P_SQL_INSERT;   
	END;

END XNT_CREATE_TABLE_TONKY;


PROCEDURE XNT_TANG_TONKY(P_TABLENAME IN VARCHAR2, P_MADONVI IN VARCHAR2,P_NAM IN VARCHAR2,P_KY IN NUMBER,P_MANHOMPTNX IN VARCHAR2,P_TUNGAY DATE,P_DENNGAY DATE ) IS
    N_SQL_INSERT VARCHAR(32767);
	STR_IF_REFUND VARCHAR(32767);
BEGIN
	STR_IF_REFUND := 'SELECT MAVATTU,MAKHONHAP,UNITCODE,SUM(SOLUONG) AS SOLUONG,SUM(SOLUONG*DONGIA) AS NHAPGT FROM VIEW_VATTUGD_XNT V WHERE 
    UNITCODE = '''||P_MADONVI||''' 
    AND LOAICHUNGTU='''||P_MANHOMPTNX||''' AND TRANGTHAI=10
    AND NGAYCHUNGTU <=TO_DATE('''|| P_DENNGAY ||''',''DD/MM/YY'')
    AND NGAYCHUNGTU >=TO_DATE('''|| P_TUNGAY ||''',''DD/MM/YY'')
    GROUP BY MAVATTU,MAKHONHAP,UNITCODE ;';
	IF P_MANHOMPTNX = '2' THEN
	BEGIN
	STR_IF_REFUND := 'SELECT B.MAVATTU, B.MAKHONHAP, B.UNITCODE,B.SOLUONG AS SOLUONG, 
	CASE  WHEN P.GIAVON IS NULL OR P.GIAVON = 0 THEN NVL(G.GIAMUA, 0)*B.SOLUONG 
	ELSE P.GIAVON*B.SOLUONG END AS NHAPGT FROM
    (SELECT MAVATTU, MAKHONHAP, UNITCODE, SUM(SOLUONG) AS SOLUONG, SUM(DONGIA*SOLUONG) AS NHAPGT FROM
    VIEW_VATTUGD_XNT WHERE 
    LOAICHUNGTU='''||P_MANHOMPTNX||''' AND TRANGTHAI=10
    AND UNITCODE = '''||P_MADONVI||'''
    AND NGAYCHUNGTU <=TO_DATE('''|| P_DENNGAY ||''',''DD/MM/YY'')
    AND NGAYCHUNGTU >=TO_DATE('''|| P_TUNGAY ||''',''DD/MM/YY'')
    GROUP BY MAVATTU,MAKHONHAP,UNITCODE) B
    LEFT JOIN '||P_TABLENAME||' P  ON  B.MAVATTU = P.MAVATTU AND B.MAKHONHAP = P.MAKHO 
	LEFT JOIN DM_VATTU_GIACA G ON B.MAVATTU = G.MAVATTU AND B.UNITCODE = G.MADONVI AND B.UNITCODE = P.UNITCODE;
	';
	END;
	END IF;
  N_SQL_INSERT:='DECLARE 
    N_COUNT NUMBER :=0; P_TONDAUKYSL NUMBER :=0; P_TONDAUKYGT NUMBER :=0;T_NHAPSL NUMBER :=0;
    CURSOR NHAP_VATTUGD IS 
	'||STR_IF_REFUND||'

  BEGIN FOR VT_INDEX IN NHAP_VATTUGD LOOP
    N_COUNT :=0;
      BEGIN 
        SELECT COUNT(*) INTO N_COUNT FROM '||P_TABLENAME||' WHERE 
        MAVATTU=VT_INDEX.MAVATTU AND  MAKHO=VT_INDEX.MAKHONHAP AND UNITCODE=VT_INDEX.UNITCODE;      
        EXCEPTION WHEN OTHERS THEN N_COUNT:=0;
      END;
    BEGIN
      IF(N_COUNT=0) THEN 
        BEGIN 
      INSERT INTO '||P_TABLENAME||' (UNITCODE,NAM,KY,MAKHO,MAVATTU) 
      SELECT VT_INDEX.UNITCODE AS UNITCODE,'|| P_NAM ||' AS NAM,'|| P_KY ||' AS KY,VT_INDEX.MAKHONHAP AS MAKHO,VT_INDEX.MAVATTU AS MAVATTU FROM DM_VATTU WHERE UNITCODE = VT_INDEX.UNITCODE || '''' AND MAVATTU=VT_INDEX.MAVATTU;
      COMMIT;
        END;
       END IF;
     END;
    BEGIN 
     -----------------
     IF VT_INDEX.MAVATTU = ''X001632'' THEN
        UPDATE '||P_TABLENAME||' SET
                  NHAPSL=NHAPSL+VT_INDEX.SOLUONG, 
                  NHAPGT=NHAPGT+VT_INDEX.NHAPGT, 
                  TONCUOIKYSL=TONCUOIKYSL+VT_INDEX.SOLUONG, 
                  TONCUOIKYGT=TONCUOIKYGT+VT_INDEX.NHAPGT,
                  GIAVON = CASE (VT_INDEX.NHAPGT/VT_INDEX.SOLUONG) WHEN 0 THEN NVL((SELECT GIAMUA FROM DM_VATTU_GIACA WHERE MAVATTU = VT_INDEX.MAVATTU AND MADONVI = VT_INDEX.UNITCODE), 0) ELSE (NVL(VT_INDEX.NHAPGT/VT_INDEX.SOLUONG, 0)) END
                  WHERE UNITCODE = VT_INDEX.UNITCODE AND  MAVATTU = VT_INDEX.MAVATTU AND MAKHO= VT_INDEX.MAKHONHAP; 
                    COMMIT;   
     ELSE
        UPDATE '||P_TABLENAME||' SET
                  NHAPSL=NHAPSL+VT_INDEX.SOLUONG, 
                  NHAPGT=NHAPGT+VT_INDEX.NHAPGT, 
                  TONCUOIKYSL=TONCUOIKYSL+VT_INDEX.SOLUONG, 
                  TONCUOIKYGT=TONCUOIKYGT+VT_INDEX.NHAPGT,
                  GIAVON = CASE (TONCUOIKYSL+VT_INDEX.SOLUONG) WHEN 0 THEN NVL((SELECT GIAMUA FROM DM_VATTU_GIACA WHERE MAVATTU = VT_INDEX.MAVATTU AND MADONVI = VT_INDEX.UNITCODE), 0) ELSE ( ABS(NVL(TONCUOIKYGT, 0))+ ABS(NVL(VT_INDEX.NHAPGT, 0)) )/( ABS(NVL(TONCUOIKYSL, 0)) + ABS(NVL(VT_INDEX.SOLUONG, 0)) ) END
                  WHERE UNITCODE = VT_INDEX.UNITCODE AND  MAVATTU = VT_INDEX.MAVATTU AND MAKHO= VT_INDEX.MAKHONHAP; 
                    COMMIT;   
     END IF;
        
       -----------------
    END;
    END LOOP; 
    END;';
--    DBMS_OUTPUT.PUT_LINE('TANGTONKY' || N_SQL_INSERT);        
      EXECUTE IMMEDIATE N_SQL_INSERT;
        EXCEPTION WHEN OTHERS THEN DBMS_OUTPUT.PUT_LINE('ERROR:'|| N_SQL_INSERT);
END XNT_TANG_TONKY;
---------------------------------------------------

---------------------------------------------------
PROCEDURE XNT_GIAM_TONKY(P_TABLENAME IN VARCHAR2, P_MADONVI IN VARCHAR2,P_NAM IN VARCHAR2,P_KY IN NUMBER,P_MANHOMPTNX IN VARCHAR2,P_TUNGAY DATE,P_DENNGAY DATE ) IS
    N_SQL_INSERT VARCHAR(32767);
  BEGIN
    N_SQL_INSERT:='
    DECLARE 
    N_COUNT NUMBER :=0; P_TONDAUKYSL NUMBER :=0; P_TONDAUKYGT NUMBER := 0; GIAVON_KHOASO NUMBER := 0; TONDAUKY_KHOASO NUMBER := 0; GIAMUA NUMBER := 0;
    CURSOR NHAP_VATTUGD IS    
	 SELECT B.MAVATTU, B.MAKHOXUAT, B.UNITCODE,B.SOLUONG AS SOLUONG,
	 CASE  WHEN P.GIAVON = 0 OR P.GIAVON IS NULL THEN NVL(G.GIAMUA, 0)*B.SOLUONG 
	 ELSE P.GIAVON*B.SOLUONG END AS XUATGT FROM
    (SELECT MAVATTU, MAKHOXUAT, UNITCODE, SUM(SOLUONG) AS SOLUONG, SUM(DONGIA*SOLUONG) AS XUATGT FROM
    VIEW_VATTUGD_XNT WHERE 
    LOAICHUNGTU='''||P_MANHOMPTNX||''' AND TRANGTHAI=10
    AND UNITCODE = '''||P_MADONVI||'''
    AND NGAYCHUNGTU <=TO_DATE('''|| P_DENNGAY ||''',''DD/MM/YY'')
    AND NGAYCHUNGTU >=TO_DATE('''|| P_TUNGAY ||''',''DD/MM/YY'')
    GROUP BY MAVATTU,MAKHOXUAT,UNITCODE) B
    LEFT JOIN '||P_TABLENAME||' P  ON  B.MAVATTU = P.MAVATTU AND B.MAKHOXUAT = P.MAKHO AND B.UNITCODE = P.UNITCODE 
	LEFT JOIN DM_VATTU_GIACA G ON B.MAVATTU = G.MAVATTU AND B.UNITCODE = G.MADONVI;
  BEGIN FOR VT_INDEX IN NHAP_VATTUGD LOOP
    N_COUNT :=0;
      BEGIN 
        SELECT COUNT(*) INTO N_COUNT FROM '||P_TABLENAME||' WHERE 
        MAVATTU=VT_INDEX.MAVATTU AND  MAKHO=VT_INDEX.MAKHOXUAT AND UNITCODE=VT_INDEX.UNITCODE;      
        EXCEPTION WHEN OTHERS THEN N_COUNT:=0;
      END;
    BEGIN
      IF(N_COUNT=0) THEN 
        BEGIN 
      INSERT INTO '||P_TABLENAME||' (UNITCODE,NAM,KY,MAKHO,MAVATTU,XUATSL,XUATGT,TONCUOIKYSL,TONCUOIKYGT) 
      SELECT VT_INDEX.UNITCODE AS UNITCODE,'|| P_NAM ||' AS NAM,'|| P_KY ||' AS KY,VT_INDEX.MAKHOXUAT AS MAKHO,VT_INDEX.MAVATTU AS MAVATTU, 0 AS XUATSL, 0 AS XUATGT, 0 AS TONCUOIKYSL, 0 AS TONCUOIKYGT FROM DM_VATTU WHERE UNITCODE = VT_INDEX.UNITCODE AND MAVATTU=VT_INDEX.MAVATTU;
      COMMIT;
        END;
       END IF;
     END;
     
    BEGIN   
    --------
      UPDATE '||P_TABLENAME||' SET XUATSL=NVL(XUATSL,0)+NVL(VT_INDEX.SOLUONG,0), 
          XUATGT=NVL(XUATGT,0)+NVL(VT_INDEX.XUATGT,0), 
          TONCUOIKYSL=NVL(TONCUOIKYSL,0)-NVL(VT_INDEX.SOLUONG,0) ,
          TONCUOIKYGT=NVL(TONCUOIKYGT,0)-NVL(VT_INDEX.XUATGT,0)
          WHERE UNITCODE =VT_INDEX.UNITCODE AND  MAVATTU=VT_INDEX.MAVATTU AND MAKHO=VT_INDEX.MAKHOXUAT;      
            COMMIT;
     --------  
    END;
    
    BEGIN
      SELECT GIAVON,TONDAUKYSL INTO GIAVON_KHOASO,TONDAUKY_KHOASO FROM '||P_TABLENAME||' WHERE MAVATTU = VT_INDEX.MAVATTU AND  MAKHO = VT_INDEX.MAKHOXUAT AND UNITCODE = VT_INDEX.UNITCODE; 
      IF GIAVON_KHOASO = 0 AND TONDAUKY_KHOASO < 0 THEN
        SELECT NVL(GIAMUA,0) INTO GIAMUA FROM DM_VATTU_GIACA WHERE MAVATTU = VT_INDEX.MAVATTU AND MADONVI = VT_INDEX.UNITCODE;
          UPDATE '||P_TABLENAME||' SET GIAVON = GIAMUA WHERE UNITCODE = VT_INDEX.UNITCODE  AND MAVATTU = VT_INDEX.MAVATTU AND MAKHO=VT_INDEX.MAKHOXUAT;      
          COMMIT;
      END IF;
    END;
    
    END LOOP; 
    END;';
--        DBMS_OUTPUT.PUT_LINE('GIAMTONKY' || N_SQL_INSERT);        
      EXECUTE IMMEDIATE N_SQL_INSERT;
        EXCEPTION WHEN OTHERS THEN COMMIT;
  END XNT_GIAM_TONKY;

   PROCEDURE XNT_TANG_TONKY_KIEMKE(P_TABLENAME IN VARCHAR2, P_MADONVI IN VARCHAR2,P_NAM IN VARCHAR2,P_KY IN NUMBER,P_MANHOMPTNX IN VARCHAR2,P_TUNGAY DATE,P_DENNGAY DATE ) IS
    N_SQL_INSERT VARCHAR(32767);
	STR_IF_REFUND VARCHAR(32767);
BEGIN
	STR_IF_REFUND := 'SELECT MAVATTU,MAKHONHAP,UNITCODE,SUM(ABS(SOLUONG)) AS SOLUONG,SUM(ABS(SOLUONG)*DONGIA) AS NHAPGT FROM VIEW_VATTUGD_XNT V WHERE 
    UNITCODE='''||P_MADONVI||''' AND 
    LOAICHUNGTU='''||P_MANHOMPTNX||''' AND TRANGTHAI=10
    AND SOLUONG < 0 AND NGAYCHUNGTU <=TO_DATE('''|| P_DENNGAY ||''',''DD/MM/YY'')
    AND NGAYCHUNGTU >=TO_DATE('''|| P_TUNGAY ||''',''DD/MM/YY'')
    GROUP BY MAVATTU,MAKHONHAP,UNITCODE ;';

  N_SQL_INSERT:='DECLARE 
    N_COUNT NUMBER :=0; P_TONDAUKYSL NUMBER :=0; P_TONDAUKYGT NUMBER :=0;
    CURSOR NHAP_VATTUGD IS 
	'||STR_IF_REFUND||'

  BEGIN FOR VT_INDEX IN NHAP_VATTUGD LOOP
    N_COUNT :=0;
      BEGIN 
        SELECT COUNT(*) INTO N_COUNT FROM '||P_TABLENAME||' WHERE 
        MAVATTU=VT_INDEX.MAVATTU AND  MAKHO=VT_INDEX.MAKHONHAP AND UNITCODE=VT_INDEX.UNITCODE;      
        EXCEPTION WHEN OTHERS THEN N_COUNT:=0;
      END;
    BEGIN
      IF(N_COUNT=0) THEN 
        BEGIN 
      INSERT INTO '||P_TABLENAME||' (UNITCODE,NAM,KY,MAKHO,MAVATTU) 
      SELECT VT_INDEX.UNITCODE AS UNITCODE,'|| P_NAM ||' AS NAM,'|| P_KY ||' AS KY,VT_INDEX.MAKHONHAP AS MAKHO,VT_INDEX.MAVATTU FROM DM_VATTU WHERE UNITCODE=VT_INDEX.UNITCODE AND MAVATTU=VT_INDEX.MAVATTU;
      COMMIT;
        END;
       END IF;
     END;


    BEGIN     
      UPDATE '||P_TABLENAME||' SET
      NHAPSL=NHAPSL+VT_INDEX.SOLUONG, 
	  NHAPGT=NHAPGT+VT_INDEX.NHAPGT, 
	  TONCUOIKYSL=TONCUOIKYSL+VT_INDEX.SOLUONG, 
	  TONCUOIKYGT=TONCUOIKYGT+VT_INDEX.NHAPGT,
	  GIAVON = 
    CASE (TONCUOIKYSL+VT_INDEX.SOLUONG) 
    WHEN 0 THEN NVL((SELECT GIAMUA FROM DM_VATTU_GIACA WHERE MAVATTU = VT_INDEX.MAVATTU AND MADONVI =VT_INDEX.UNITCODE), 0)
    ELSE ( ABS(NVL(TONCUOIKYGT, 0))+ ABS(NVL(VT_INDEX.NHAPGT, 0)) )/( ABS(NVL(TONCUOIKYSL, 0)) + ABS(NVL(VT_INDEX.SOLUONG, 0)) ) END
      WHERE UNITCODE =VT_INDEX.UNITCODE AND  MAVATTU=VT_INDEX.MAVATTU AND MAKHO=VT_INDEX.MAKHONHAP; 
        COMMIT;
    END;
    END LOOP; 
    END;';
        --DBMS_OUTPUT.PUT_LINE(N_SQL_INSERT);        
      EXECUTE IMMEDIATE N_SQL_INSERT;
        EXCEPTION WHEN OTHERS THEN DBMS_OUTPUT.PUT_LINE(N_SQL_INSERT);
END XNT_TANG_TONKY_KIEMKE;


PROCEDURE XNT_GIAM_TONKY_KIEMKE(P_TABLENAME IN VARCHAR2, P_MADONVI IN VARCHAR2,P_NAM IN VARCHAR2,P_KY IN NUMBER,P_MANHOMPTNX IN VARCHAR2,P_TUNGAY DATE,P_DENNGAY DATE ) IS
    N_SQL_INSERT VARCHAR(32767);
  BEGIN
    N_SQL_INSERT:='DECLARE 
    N_COUNT NUMBER :=0; P_TONDAUKYSL NUMBER :=0; P_TONDAUKYGT NUMBER :=0;
    CURSOR NHAP_VATTUGD IS    
	 SELECT B.MAVATTU, B.MAKHOXUAT, B.UNITCODE,ABS(B.SOLUONG) AS SOLUONG,
	 CASE  WHEN P.GIAVON =  0 THEN NVL(G.GIAMUA, 0)*ABS(B.SOLUONG) 
	 ELSE P.GIAVON*ABS(B.SOLUONG) END AS XUATGT FROM
    (SELECT MAVATTU, MAKHOXUAT, UNITCODE, SUM(ABS(SOLUONG)) AS SOLUONG, SUM(DONGIA*ABS(SOLUONG)) AS XUATGT FROM
    VIEW_VATTUGD_XNT WHERE 
    LOAICHUNGTU='''||P_MANHOMPTNX||''' AND TRANGTHAI=10
    AND UNITCODE = '''||P_MADONVI||''' 
    AND SOLUONG > 0 AND NGAYCHUNGTU <=TO_DATE('''|| P_DENNGAY ||''',''DD/MM/YY'')
    AND NGAYCHUNGTU >=TO_DATE('''|| P_TUNGAY ||''',''DD/MM/YY'')
    GROUP BY MAVATTU,MAKHOXUAT,UNITCODE) B
    LEFT JOIN '||P_TABLENAME||' P  ON  B.MAVATTU = P.MAVATTU AND B.MAKHOXUAT = P.MAKHO AND B.UNITCODE = P.UNITCODE 
	LEFT JOIN DM_VATTU_GIACA G ON B.MAVATTU = G.MAVATTU AND B.UNITCODE = G.MADONVI;
  BEGIN FOR VT_INDEX IN NHAP_VATTUGD LOOP
    N_COUNT :=0;
      BEGIN 
        SELECT COUNT(*) INTO N_COUNT FROM '||P_TABLENAME||' WHERE 
        MAVATTU=VT_INDEX.MAVATTU AND  MAKHO=VT_INDEX.MAKHOXUAT AND UNITCODE=VT_INDEX.UNITCODE;      
        EXCEPTION WHEN OTHERS THEN N_COUNT:=0;
      END;
    BEGIN
      IF(N_COUNT=0) THEN 
        BEGIN 
      INSERT INTO '||P_TABLENAME||' (UNITCODE,NAM,KY,MAKHO,MAVATTU) 
      SELECT VT_INDEX.UNITCODE AS UNITCODE,'|| P_NAM ||' AS NAM,'|| P_KY ||' AS KY,VT_INDEX.MAKHOXUAT AS MAKHO,VT_INDEX.MAVATTU FROM DM_VATTU WHERE UNITCODE=VT_INDEX.UNITCODE AND MAVATTU=VT_INDEX.MAVATTU;
      COMMIT;
        END;
       END IF;
     END;

    BEGIN     
      UPDATE '||P_TABLENAME||' SET
      XUATSL=XUATSL+VT_INDEX.SOLUONG, XUATGT=XUATGT+VT_INDEX.XUATGT, TONCUOIKYSL=TONCUOIKYSL-VT_INDEX.SOLUONG,TONCUOIKYGT=TONCUOIKYGT-VT_INDEX.XUATGT
      WHERE UNITCODE =VT_INDEX.UNITCODE AND  MAVATTU=VT_INDEX.MAVATTU AND MAKHO=VT_INDEX.MAKHOXUAT;      
        COMMIT;
    END;
    END LOOP; 
    END;';
        --DBMS_OUTPUT.PUT_LINE(N_SQL_INSERT);        
      EXECUTE IMMEDIATE N_SQL_INSERT;
        EXCEPTION WHEN OTHERS THEN COMMIT;
  END XNT_GIAM_TONKY_KIEMKE;

  PROCEDURE XNT_KHOASO(P_TABLENAME_KYTRUOC IN VARCHAR2,P_TABLENAME IN VARCHAR2, P_UNITCODE IN VARCHAR2,P_NAM IN VARCHAR2,P_KY IN NUMBER)IS
    P_TUNGAY DATE;
    P_TUNGAY_KYTRUOC DATE;
    P_DENNGAY DATE;
    N_COUNT NUMBER;
    BEGIN
      SELECT TO_DATE(TUNGAY,'DD/MM/YY') AS TUNGAY,TO_DATE(DENNGAY,'DD/MM/YY') AS DENNGAY  INTO P_TUNGAY,P_DENNGAY FROM DM_KYKETOAN WHERE KY=P_KY AND NAM=P_NAM AND UNITCODE=P_UNITCODE;
      SELECT COUNT(*) INTO N_COUNT FROM DM_THEODOITIENTRINH WHERE PROCESSCODE = 'KHOASO' AND UNITCODE = P_UNITCODE;
      IF N_COUNT = 0 THEN
      INSERT INTO DM_THEODOITIENTRINH (ID, PROCESSCODE, DESCRIPTION, STATE, UNITCODE) VALUES (SYS_GUID(), 'KHOASO', 'TIáº¾N TRÃŒNH KHÃ“A Sá»”', 0, P_UNITCODE);
      END IF;
      UPDATE DM_THEODOITIENTRINH SET
      STATE = 20 -- IS RUNNING
      WHERE PROCESSCODE = 'KHOASO' AND UNITCODE = P_UNITCODE;
      BEGIN
        XNT_CREATE_TABLE_TONKY(P_TABLENAME_KYTRUOC,P_TABLENAME, P_UNITCODE, P_NAM, P_KY);     
        XNT_TANG_TONKY(P_TABLENAME, P_UNITCODE, P_NAM, P_KY, '2',P_TUNGAY,P_DENNGAY);
        XNT_TANG_TONKY(P_TABLENAME, P_UNITCODE, P_NAM, P_KY, 'NMUA',P_TUNGAY,P_DENNGAY);
        XNT_TANG_TONKY(P_TABLENAME, P_UNITCODE, P_NAM, P_KY, 'NHBANTL',P_TUNGAY,P_DENNGAY);
        XNT_TANG_TONKY(P_TABLENAME, P_UNITCODE, P_NAM, P_KY, 'DCN',P_TUNGAY,P_DENNGAY);
        XNT_TANG_TONKY(P_TABLENAME, P_UNITCODE, P_NAM, P_KY, 'NKHAC',P_TUNGAY,P_DENNGAY);
        XNT_TANG_TONKY(P_TABLENAME, P_UNITCODE, P_NAM, P_KY, 'TDK',P_TUNGAY,P_DENNGAY);
        XNT_TANG_TONKY_KIEMKE(P_TABLENAME, P_UNITCODE, P_NAM, P_KY, 'N_KK',P_TUNGAY,P_DENNGAY);
        --update gia von am by PHAMTUANANH
        -- xuat
        XNT_GIAM_TONKY(P_TABLENAME, P_UNITCODE, P_NAM, P_KY, '1',P_TUNGAY,P_DENNGAY);
        XNT_GIAM_TONKY(P_TABLENAME, P_UNITCODE, P_NAM, P_KY, '3',P_TUNGAY,P_DENNGAY);
        XNT_GIAM_TONKY(P_TABLENAME, P_UNITCODE, P_NAM, P_KY, 'XBAN',P_TUNGAY,P_DENNGAY);
		    XNT_GIAM_TONKY(P_TABLENAME, P_UNITCODE, P_NAM, P_KY, 'XBANLE',P_TUNGAY,P_DENNGAY);
		    XNT_GIAM_TONKY(P_TABLENAME, P_UNITCODE, P_NAM, P_KY, 'XKHAC',P_TUNGAY,P_DENNGAY);
        XNT_GIAM_TONKY(P_TABLENAME, P_UNITCODE, P_NAM, P_KY, 'DCX',P_TUNGAY,P_DENNGAY);
        XNT_GIAM_TONKY_KIEMKE(P_TABLENAME, P_UNITCODE, P_NAM, P_KY, 'N_KK',P_TUNGAY,P_DENNGAY);

        UPDATE_TONCUOIKYSL(P_TABLENAME,P_UNITCODE,P_NAM,P_KY);
        THONGKE_BANLE(P_TUNGAY, P_UNITCODE);
      UPDATE DM_THEODOITIENTRINH SET
      STATE = 0 -- IS COMPLETE
      WHERE PROCESSCODE = 'KHOASO' AND UNITCODE = P_UNITCODE;   
      END;

      END XNT_KHOASO;

---------------------------------------------
PROCEDURE UPDATE_TONCUOIKYSL(P_TABLENAME IN VARCHAR2, P_MADONVI IN VARCHAR2,P_NAM IN VARCHAR2,P_KY IN NUMBER) IS
  N_SQL_UPDATE VARCHAR(32767);
	STR_IF_REFUND VARCHAR(32767);
BEGIN
	STR_IF_REFUND := 'SELECT UNITCODE,NAM,KY,MAKHO,MAVATTU,GIAVON,TONDAUKYSL,TONDAUKYGT,NHAPSL
  ,NHAPGT,XUATSL,XUATGT,TONCUOIKYSL,TONCUOIKYGT FROM '||P_TABLENAME||' WHERE 
    UNITCODE='''||P_MADONVI||'''
    AND KY = '''||P_KY||'''
    AND TONCUOIKYSL = 0 AND TONCUOIKYGT <> 0
    GROUP BY UNITCODE,NAM,KY,MAKHO,MAVATTU,GIAVON,TONDAUKYSL,TONDAUKYGT,NHAPSL,NHAPGT,XUATSL,XUATGT,TONCUOIKYSL,TONCUOIKYGT;';
    N_SQL_UPDATE:='DECLARE 
    N_COUNT NUMBER :=0; P_TONDAUKYSL NUMBER :=0; P_TONDAUKYGT NUMBER :=0;
    CURSOR TONCUOIBANG0 IS '||STR_IF_REFUND||'
  BEGIN FOR VT_INDEX IN TONCUOIBANG0 LOOP  
    BEGIN     
      UPDATE '||P_TABLENAME||' SET
        TONCUOIKYGT = 0 WHERE UNITCODE =VT_INDEX.UNITCODE AND MAVATTU=VT_INDEX.MAVATTU AND MAKHO=VT_INDEX.MAKHO;
            COMMIT;
        END;
    END LOOP; 
    END;';
        DBMS_OUTPUT.PUT_LINE(N_SQL_UPDATE);        
      EXECUTE IMMEDIATE N_SQL_UPDATE;
        EXCEPTION WHEN OTHERS THEN DBMS_OUTPUT.PUT_LINE(SQLERRM);
END UPDATE_TONCUOIKYSL;
---------------------------------------------

PROCEDURE BAOCAO_XNT_TONGHOP(P_GROUPBY IN VARCHAR2, P_WAREHOUSE IN VARCHAR2, P_MALOAI IN VARCHAR2,  P_MANHOM IN VARCHAR2,P_MAVATTU IN VARCHAR2, P_MAKHACHHANG IN VARCHAR2,P_UNITCODE  IN VARCHAR2, P_TUNGAY IN DATE,P_DENNGAY IN DATE, XTNCOLLECTION  OUT SYS_REFCURSOR) IS
QUERY_STR VARCHAR(32767);
KY_KETTHUC NUMBER;
NAM_KETTHUC NUMBER;
P_SELECT_COLUMNS_GROUPBY VARCHAR(32767);
P_TABLE_GROUPBY VARCHAR(32767);
P_COLUMNS_GROUPBY VARCHAR(32767);
P_EXPRESSION VARCHAR(3232);
P_SQL_INSERT VARCHAR(32767);
N NUMBER:= 0;
BEGIN
FOR cur_period in (SELECT to_date(P_TUNGAY, 'dd/MM/yyyy') + LEVEL - 1 AS today
                    FROM dual CONNECT BY LEVEL <= to_date(P_DENNGAY, 'dd/MM/yyyy') - to_date(P_TUNGAY, 'dd/MM/yyyy') + 1) 
    LOOP
BEGIN

BEGIN--TÃ¬m ká»³
SELECT KY, NAM INTO KY_KETTHUC, NAM_KETTHUC FROM DM_KYKETOAN WHERE to_date(DENNGAY, 'dd/MM/yyyy') = to_date(cur_period.today, 'dd/MM/yyyy') AND UNITCODE = ''||P_UNITCODE||'' AND TRANGTHAI = 10 AND rownum =1;
   EXCEPTION
            WHEN NO_DATA_FOUND THEN
               goto end_loop;
END;--End TÃ¬m ky

BEGIN --Báº¯t Ä‘áº§u thá»±c thi nhiá»‡m vu
N:=N+1;
IF (N = 1) THEN
BEGIN -- Báº£n ghi Ä‘áº§u tiÃªn
 P_SQL_INSERT := 'INSERT INTO TMP_XTN_NGAY
         (UNITCODE, MAKHO, MAVATTU, GIAVON, TONDAUKYSL, TONDAUKYGT, NHAPSL, NHAPGT, XUATSL, XUATGT)
         SELECT a.UNITCODE, a.MAKHO, a.MAVATTU, a.GIAVON, a.TONDAUKYSL, a.TONDAUKYGT, a.NHAPSL, a.NHAPGT, a.XUATSL, a.XUATGT
         FROM XNT_'|| NAM_KETTHUC ||'_KY_'||KY_KETTHUC||' a left join DM_VATTU b on a.Mavattu = b.mavattu  AND B.UNITCODE = SUBSTR(a.UNITCODE,0,3)
         WHERE 1=1 AND a.UNITCODE = '''||P_UNITCODE||'''
         ';
         --
IF TRIM(P_WAREHOUSE) IS NOT NULL THEN
P_SQL_INSERT := P_SQL_INSERT||' AND a.MAKHO IN ('||P_WAREHOUSE||')';
END IF;
IF TRIM(P_MALOAI) IS NOT NULL THEN
P_SQL_INSERT := P_SQL_INSERT||' AND b.MALOAIVATTU IN ('||P_MALOAI||')';
END IF;
IF TRIM(P_MANHOM) IS NOT NULL THEN
P_SQL_INSERT := P_SQL_INSERT||' AND b.MANHOMVATTU IN ('||P_MANHOM||')';
END IF;
IF TRIM(P_MAVATTU) IS NOT NULL THEN
P_SQL_INSERT := P_SQL_INSERT||' AND a.MAVATTU IN ('||P_MAVATTU||')';
END IF;    
IF TRIM(P_MAKHACHHANG) IS NOT NULL THEN
P_SQL_INSERT := P_SQL_INSERT||' AND b.MAKHACHHANG IN ('||P_MAKHACHHANG||')';
END IF;   
DBMS_OUTPUT.put_line (P_SQL_INSERT);
execute IMMEDIATE P_SQL_INSERT;

EXCEPTION
            WHEN NO_DATA_FOUND THEN
               goto end_loop;
               WHEN OTHERS THEN
               goto end_loop;
END;
ELSE
BEGIN --VÃ²ng thá»© 2 trá»Ÿ Ä‘i
 P_SQL_INSERT := 'INSERT INTO TMP_XTN_NGAY
         (UNITCODE, MAKHO, MAVATTU, GIAVON,NHAPSL, NHAPGT, XUATSL, XUATGT)
         SELECT a.UNITCODE, a.MAKHO, a.MAVATTU, a.GIAVON, a.NHAPSL, a.NHAPGT, a.XUATSL, a.XUATGT
         FROM XNT_'|| NAM_KETTHUC ||'_KY_'||KY_KETTHUC||' a left join DM_VATTU b on a.Mavattu = b.mavattu  AND B.UNITCODE = SUBSTR(a.UNITCODE,0,3)
         WHERE 1=1 AND a.UNITCODE = '''||P_UNITCODE||'''
         ';
         --
IF TRIM(P_WAREHOUSE) IS NOT NULL THEN
P_SQL_INSERT := P_SQL_INSERT||' AND a.MAKHO IN ('||P_WAREHOUSE||')';
END IF;
IF TRIM(P_MALOAI) IS NOT NULL THEN
P_SQL_INSERT := P_SQL_INSERT||' AND b.MALOAIVATTU IN ('||P_MALOAI||')';
END IF;
IF TRIM(P_MANHOM) IS NOT NULL THEN
P_SQL_INSERT := P_SQL_INSERT||' AND b.MANHOMVATTU IN ('||P_MANHOM||')';
END IF;
IF TRIM(P_MAVATTU) IS NOT NULL THEN
P_SQL_INSERT := P_SQL_INSERT||' AND a.MAVATTU IN ('||P_MAVATTU||')';
END IF;     
IF TRIM(P_MAKHACHHANG) IS NOT NULL THEN
P_SQL_INSERT := P_SQL_INSERT||' AND b.MAKHACHHANG IN ('||P_MAKHACHHANG||')';
END IF;           
execute IMMEDIATE P_SQL_INSERT;
EXCEPTION
            WHEN NO_DATA_FOUND THEN
               goto end_loop;
               WHEN OTHERS THEN
               goto end_loop;
END;--Káº¿t thÃºc vong 2 trá»Ÿ Ä‘i;
END IF;
END; -- Káº¿t thÃºc thá»±c thi nhiá»‡m vá»¥

END;
        <<end_loop>>
        null;      
END LOOP;
IF P_GROUPBY = 'MADONVI' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'c.MADONVI, c.TENDONVI,a.UNITCODE';
P_SELECT_COLUMNS_GROUPBY:= ' c.MADONVI AS Code, c.TENDONVI AS Ten,a.UNITCODE AS MADONVI';
P_TABLE_GROUPBY:= ' left join AU_DONVI c ON c.MADONVI = a.UNITCODE ';
END;
ELSIF P_GROUPBY = 'MAKHO' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'c.MAKHO, c.TENKHO,a.UNITCODE';
P_SELECT_COLUMNS_GROUPBY:= ' c.MAKHO AS Code, c.TENKHO AS Ten,a.UNITCODE AS MADONVI';
P_TABLE_GROUPBY:= ' left join DM_KHO c ON a.MAKHO = c.MAKHO AND SUBSTR(c.UNITCODE,0,3) = SUBSTR(a.UNITCODE,0,3)';
END;
ELSIF P_GROUPBY = 'MANHOMVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'c.MANHOMVTU, c.TENNHOMVT,a.UNITCODE';
P_SELECT_COLUMNS_GROUPBY:= ' c.MANHOMVTU AS Code, c.TENNHOMVT AS Ten,a.UNITCODE  AS MADONVI';
P_TABLE_GROUPBY:= ' left join DM_NHOMVATTU c ON b.MANHOMVATTU = c.MANHOMVTU AND SUBSTR(c.UNITCODE,0,3) = SUBSTR(a.UNITCODE,0,3)';
END;
ELSIF P_GROUPBY = 'MALOAIVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'c.MALOAIVATTU, c.TENLOAIVT,a.UNITCODE';
P_SELECT_COLUMNS_GROUPBY:= ' c.MALOAIVATTU AS Code, c.TENLOAIVT AS Ten,a.UNITCODE  AS MADONVI';
P_TABLE_GROUPBY:= ' left join DM_LOAIVATTU c ON b.MALOAIVATTU = c.MALOAIVATTU AND SUBSTR(c.UNITCODE,0,3) = SUBSTR(a.UNITCODE,0,3)';
END;
ELSIF P_GROUPBY = 'MAKHACHHANG' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'c.MANCC, c.TENNCC,a.UNITCODE';
P_SELECT_COLUMNS_GROUPBY:= ' c.MANCC AS Code, c.TENNCC AS Ten,a.UNITCODE  AS MADONVI';
P_TABLE_GROUPBY:= ' left join DM_NHACUNGCAP c ON b.MAKHACHHANG = c.MANCC AND SUBSTR(c.UNITCODE,0,3) = SUBSTR(a.UNITCODE,0,3)';
P_EXPRESSION:= '';
END;
ELSE --ELSIF P_GROUPBY = 'MAVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU,a.UNITCODE';
P_SELECT_COLUMNS_GROUPBY:= ' b.MAVATTU AS Code, b.TENVATTU AS Ten,a.UNITCODE  AS MADONVI';
P_TABLE_GROUPBY:= '';
END;
END IF;
QUERY_STR:= 'select '||P_SELECT_COLUMNS_GROUPBY||', 
                                    SUM(a.tondaukysl)  as OpeningBalanceQuantity,
                                    SUM(a.tondaukygt) as OpeningBalanceValue,
                                    SUM(a.nhapsl) as IncreaseQuantity, SUM(a.nhapgt) as IncreaseValue,
                                    SUM(a.xuatsl) as DecreaseQuantity, SUM(a.xuatgt) as DecreaseValue,
                                    SUM(a.tondaukysl - a.xuatsl + a.nhapsl) as ClosingQuantity, 
                                    SUM(a.tondaukygt - a.xuatgt + a.nhapgt) as ClosingValue
                                    from TMP_XTN_NGAY a 
                                    left join DM_VATTU b on a.Mavattu = b.mavattu AND B.UNITCODE = SUBSTR(a.UNITCODE,0,3)
                                    '||P_TABLE_GROUPBY||'
                                    WHERE 1=1 
									'||P_EXPRESSION||'
									and (a.tondaukysl * a.tondaukysl) + (a.nhapsl * a.nhapsl) + (a.xuatsl * a.xuatsl) + (a.toncuoikysl* a.toncuoikysl) > 0 ';
QUERY_STR := QUERY_STR||' GROUP BY '||P_COLUMNS_GROUPBY;
--QUERY_STR := ' select distinct MAKHO from TMP_XTN_NGAY';
BEGIN
DBMS_OUTPUT.put_line ('SQL     ' || QUERY_STR);
OPEN XTNCOLLECTION FOR QUERY_STR;
EXCEPTION
   WHEN NO_DATA_FOUND
   THEN
      DBMS_OUTPUT.put_line ('<your message>' || SQLERRM);
   WHEN OTHERS
   THEN
      DBMS_OUTPUT.put_line (QUERY_STR  || SQLERRM);
END;
END BAOCAO_XNT_TONGHOP;


PROCEDURE BAOCAO_XNT_CHITIET(P_GROUPBY IN VARCHAR2, P_WAREHOUSE IN VARCHAR2, P_MALOAI IN VARCHAR2,  P_MANHOM IN VARCHAR2,P_MAVATTU IN VARCHAR2,P_MAKHACHHANG IN VARCHAR2,P_UNITCODE  IN VARCHAR2, P_TUNGAY IN DATE,P_DENNGAY IN DATE, cur  OUT SYS_REFCURSOR) IS
QUERY_STR VARCHAR(32767);
KY_KETTHUC NUMBER;
NAM_KETTHUC NUMBER;
P_SELECT_COLUMNS_GROUPBY VARCHAR(32767);
P_TABLE_GROUPBY VARCHAR(32767);
P_COLUMNS_GROUPBY VARCHAR(32767);
P_EXPRESSION VARCHAR(3232);
P_SQL_INSERT VARCHAR(32767);
N NUMBER:=0;
BEGIN
FOR cur_period in (SELECT to_date(P_TUNGAY, 'dd/MM/yyyy') + LEVEL - 1 AS today
FROM dual
CONNECT BY LEVEL <= to_date(P_DENNGAY, 'dd/MM/yyyy') - to_date(P_TUNGAY, 'dd/MM/yyyy') + 1) LOOP
BEGIN

BEGIN--TÃ¬m ká»³
SELECT KY, NAM INTO KY_KETTHUC, NAM_KETTHUC FROM DM_KYKETOAN WHERE to_date(DENNGAY, 'dd/MM/yyyy') = to_date(cur_period.today, 'dd/MM/yyyy') AND UNITCODE = ''||P_UNITCODE||'' AND TRANGTHAI = 10 AND rownum =1;
   EXCEPTION
            WHEN NO_DATA_FOUND THEN
               goto end_loop;
END;--End TÃ¬m ky

BEGIN --Báº¯t Ä‘áº§u thá»±c thi nhiá»‡m vu
N:=N+1;
IF (N = 1) THEN
BEGIN -- Báº£n ghi Ä‘áº§u tiÃªn
 P_SQL_INSERT := 'INSERT INTO TMP_XTN_NGAY
         (UNITCODE, MAKHO, MAVATTU, GIAVON, TONDAUKYSL, TONDAUKYGT, NHAPSL, NHAPGT, XUATSL, XUATGT)
         SELECT a.UNITCODE, a.MAKHO, a.MAVATTU, a.GIAVON, a.TONDAUKYSL, a.TONDAUKYGT, a.NHAPSL, a.NHAPGT, a.XUATSL, a.XUATGT
         FROM XNT_'|| NAM_KETTHUC ||'_KY_'||KY_KETTHUC||' a left join DM_VATTU b on a.Mavattu = b.mavattu  AND B.UNITCODE = SUBSTR(a.UNITCODE,0,3)
         WHERE 1=1 AND a.UNITCODE = '''||P_UNITCODE||'''
         ';
         --
IF TRIM(P_WAREHOUSE) IS NOT NULL THEN
P_SQL_INSERT := P_SQL_INSERT||' AND a.MAKHO IN ('||P_WAREHOUSE||')';
END IF;
IF TRIM(P_MALOAI) IS NOT NULL THEN
P_SQL_INSERT := P_SQL_INSERT||' AND b.MALOAIVATTU IN ('||P_MALOAI||')';
END IF;
IF TRIM(P_MANHOM) IS NOT NULL THEN
P_SQL_INSERT := P_SQL_INSERT||' AND b.MANHOMVATTU IN ('||P_MANHOM||')';
END IF;
IF TRIM(P_MAVATTU) IS NOT NULL THEN
P_SQL_INSERT := P_SQL_INSERT||' AND a.MAVATTU IN ('||P_MAVATTU||')';
END IF;    
IF TRIM(P_MAKHACHHANG) IS NOT NULL THEN
P_SQL_INSERT := P_SQL_INSERT||' AND b.MAKHACHHANG IN ('||P_MAKHACHHANG||')';
END IF;   
execute IMMEDIATE P_SQL_INSERT;

EXCEPTION
            WHEN NO_DATA_FOUND THEN
               goto end_loop;
               WHEN OTHERS THEN
               goto end_loop;
END;
ELSE
BEGIN --VÃ²ng thá»© 2 trá»Ÿ Ä‘i
 P_SQL_INSERT := 'INSERT INTO TMP_XTN_NGAY
         (UNITCODE, MAKHO, MAVATTU, GIAVON,NHAPSL, NHAPGT, XUATSL, XUATGT)
         SELECT a.UNITCODE, a.MAKHO, a.MAVATTU, a.GIAVON, a.NHAPSL, a.NHAPGT, a.XUATSL, a.XUATGT
         FROM XNT_'|| NAM_KETTHUC ||'_KY_'||KY_KETTHUC||' a left join DM_VATTU b on a.Mavattu = b.mavattu  AND B.UNITCODE = SUBSTR(a.UNITCODE,0,3)
         WHERE 1=1 AND a.UNITCODE = '''||P_UNITCODE||'''
         ';
         --
IF TRIM(P_WAREHOUSE) IS NOT NULL THEN
P_SQL_INSERT := P_SQL_INSERT||' AND a.MAKHO IN ('||P_WAREHOUSE||')';
END IF;
IF TRIM(P_MALOAI) IS NOT NULL THEN
P_SQL_INSERT := P_SQL_INSERT||' AND b.MALOAIVATTU IN ('||P_MALOAI||')';
END IF;
IF TRIM(P_MANHOM) IS NOT NULL THEN
P_SQL_INSERT := P_SQL_INSERT||' AND b.MANHOMVATTU IN ('||P_MANHOM||')';
END IF;
IF TRIM(P_MAVATTU) IS NOT NULL THEN
P_SQL_INSERT := P_SQL_INSERT||' AND a.MAVATTU IN ('||P_MAVATTU||')';
END IF;     
IF TRIM(P_MAKHACHHANG) IS NOT NULL THEN
P_SQL_INSERT := P_SQL_INSERT||' AND b.MAKHACHHANG IN ('||P_MAKHACHHANG||')';
END IF;           
execute IMMEDIATE P_SQL_INSERT;
EXCEPTION
            WHEN NO_DATA_FOUND THEN
               goto end_loop;
               WHEN OTHERS THEN
               goto end_loop;
END;--Káº¿t thÃºc vong 2 trá»Ÿ Ä‘i;
END IF;
END; -- Káº¿t thÃºc thá»±c thi nhiá»‡m vá»¥

END;
        <<end_loop>>
        null;      
END LOOP;

IF P_GROUPBY = 'MADONVI' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'c.MADONVI, c.TENDONVI, b.MAVATTU, b.TENVATTU,b.BARCODE, a.UNITCODE ';
P_SELECT_COLUMNS_GROUPBY:= ' b.MAVATTU AS Code, b.TENVATTU as TenVT,b.BARCODE as BARCODE, c.MADONVI as CodeNCC, c.TENDONVI AS Ten, a.UNITCODE AS MADONVI ';
P_TABLE_GROUPBY:= ' left join AU_DONVI c ON a.UNITCODE = c.MADONVI';
END;
ELSIF P_GROUPBY = 'MAKHO' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'c.MAKHO, c.TENKHO, b.MAVATTU, b.TENVATTU,b.BARCODE, a.UNITCODE ';
P_SELECT_COLUMNS_GROUPBY:= ' b.MAVATTU AS Code, b.TENVATTU as TenVT,b.BARCODE as BARCODE, c.MAKHO as CodeNCC, c.TENKHO AS Ten, a.UNITCODE AS MADONVI ';
P_TABLE_GROUPBY:= ' left join DM_KHO c ON a.MAKHO = c.MAKHO AND SUBSTR(c.UNITCODE,0,3) = SUBSTR(a.UNITCODE,0,3)';
END;
ELSIF P_GROUPBY = 'MANHOMVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'c.MANHOMVTU, c.TENNHOMVT, b.MAVATTU, b.TENVATTU,b.BARCODE, a.UNITCODE ';
P_SELECT_COLUMNS_GROUPBY:= ' b.MAVATTU AS Code, b.TENVATTU as TenVT,b.BARCODE as BARCODE, c.MANHOMVTU as CodeNCC, c.TENNHOMVT AS Ten, a.UNITCODE AS MADONVI  ';
P_TABLE_GROUPBY:= ' left join DM_NHOMVATTU c ON b.MANHOMVATTU = c.MANHOMVTU AND SUBSTR(c.UNITCODE,0,3) = SUBSTR(a.UNITCODE,0,3)';
END;
ELSIF P_GROUPBY = 'MALOAIVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'c.MALOAIVATTU, c.TENLOAIVT, b.MAVATTU, b.TENVATTU,b.BARCODE, a.UNITCODE';
P_SELECT_COLUMNS_GROUPBY:= ' b.MAVATTU AS Code, b.TENVATTU as TenVT,b.BARCODE as BARCODE, c.MALOAIVATTU as CodeNCC, c.TENLOAIVT AS Ten, a.UNITCODE AS MADONVI ';
P_TABLE_GROUPBY:= ' left join DM_LOAIVATTU c ON b.MALOAIVATTU = c.MALOAIVATTU AND SUBSTR(c.UNITCODE,0,3) = SUBSTR(a.UNITCODE,0,3)';
END;
ELSIF P_GROUPBY = 'MAKHACHHANG' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'c.MANCC, c.TENNCC, b.MAVATTU, b.TENVATTU,b.BARCODE, a.UNITCODE';
P_SELECT_COLUMNS_GROUPBY := ' b.MAVATTU AS Code, b.TENVATTU as TenVT,b.BARCODE as BARCODE,c.MANCC as CodeNCC, c.TENNCC AS Ten, a.UNITCODE AS MADONVI';
P_TABLE_GROUPBY:= ' left join DM_NHACUNGCAP c ON b.MAKHACHHANG = c.MANCC AND SUBSTR(c.UNITCODE,0,3) = SUBSTR(a.UNITCODE,0,3)';
P_EXPRESSION:= '';
END;
ELSE --ELSIF P_GROUPBY = 'MAVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU,b.BARCODE, a.UNITCODE';
P_SELECT_COLUMNS_GROUPBY:= ' b.MAVATTU AS Code, b.TENVATTU AS TenVT,b.BARCODE AS BARCODE,b.MAVATTU AS CodeNCC, b.TENVATTU AS Ten, a.UNITCODE AS MADONVI';
P_TABLE_GROUPBY:= '';
END;
END IF;

QUERY_STR:= 'select '||P_SELECT_COLUMNS_GROUPBY||',
                                    SUM(a.tondaukysl)  as OpeningBalanceQuantity,
                                    SUM(a.tondaukygt) as OpeningBalanceValue,
                                    SUM(a.nhapsl) as IncreaseQuantity, SUM(a.nhapgt) as IncreaseValue,
                                    SUM(a.xuatsl) as DecreaseQuantity, SUM(a.xuatgt) as DecreaseValue,
                                    SUM(a.tondaukysl - a.xuatsl + a.nhapsl) as ClosingQuantity, 
                                    SUM(a.tondaukygt - a.xuatgt + a.nhapgt) as ClosingValue
                                    from TMP_XTN_NGAY a 
                                    left join DM_VATTU b on a.Mavattu = b.mavattu AND B.UNITCODE = SUBSTR(a.UNITCODE,0,3) 
                                    '||P_TABLE_GROUPBY||'
                                    WHERE 1=1  
                                    and (a.tondaukysl * a.tondaukysl) + (a.nhapsl * a.nhapsl) + (a.xuatsl * a.xuatsl) + (a.toncuoikysl* a.toncuoikysl)  > 0 
									'||P_EXPRESSION||'
                                    GROUP BY '||P_COLUMNS_GROUPBY;
DBMS_OUTPUT.put_line (QUERY_STR);
BEGIN
OPEN cur FOR QUERY_STR;
 --DBMS_OUTPUT.put_line (QUERY_STR);
EXCEPTION
   WHEN NO_DATA_FOUND
   THEN
      DBMS_OUTPUT.put_line ('<your message>' || SQLERRM);
   WHEN OTHERS
   THEN
      DBMS_OUTPUT.put_line (QUERY_STR  || SQLERRM); 
END;
END BAOCAO_XNT_CHITIET;


PROCEDURE XNT_GIAM_PHIEU(P_TABLENAME IN VARCHAR2,P_NAM IN VARCHAR2,P_KY IN NUMBER,P_ID IN VARCHAR2 ) IS
    N_SQL_INSERT VARCHAR(32767);
  BEGIN
  N_SQL_INSERT:='DECLARE 
    N_COUNT NUMBER :=0; P_TONDAUKYSL NUMBER :=0; P_TONDAUKYGT NUMBER :=0;
    CURSOR NHAP_VATTUGD IS 
	SELECT B.MAVATTU, B.MAKHOXUAT, B.UNITCODE, B.SOLUONG, 
	CASE  WHEN P.GIAVON IS NULL OR P.GIAVON = 0 THEN NVL(G.GIAMUA, 0)*B.SOLUONG 
	ELSE P.GIAVON*B.SOLUONG END AS XUATGT from 
    (SELECT MAVATTU, MAKHOXUAT, UNITCODE, SUM(SOLUONG) AS SOLUONG, SUM(DONGIA*SOLUONG) AS XUATGT 
    FROM VIEW_VATTUGD_XNT WHERE  
    ID='''||P_ID||''' GROUP BY MAVATTU, MAKHOXUAT, UNITCODE)  B 
    LEFT JOIN '||P_TABLENAME||' P  ON  B.MAVATTU = P.MAVATTU AND B.MAKHOXUAT = P.MAKHO AND B.UNITCODE = P.UNITCODE 
   	LEFT JOIN DM_VATTU_GIACA G ON B.MAVATTU = G.MAVATTU AND B.UNITCODE = G.MADONVI ;
  BEGIN FOR VT_INDEX IN NHAP_VATTUGD LOOP
    N_COUNT :=0;
      BEGIN 
        SELECT COUNT(*) INTO N_COUNT FROM '||P_TABLENAME||' WHERE 
        MAVATTU=VT_INDEX.MAVATTU AND  MAKHO=VT_INDEX.MAKHOXUAT AND UNITCODE=VT_INDEX.UNITCODE;      
        EXCEPTION WHEN OTHERS THEN N_COUNT:=0;
      END;
    BEGIN
      IF(N_COUNT=0) THEN 
        BEGIN 
      INSERT INTO '||P_TABLENAME||' (UNITCODE,NAM,KY,MAKHO,MAVATTU,XUATSL, XUATGT, TONCUOIKYSL, TONCUOIKYGT) 
      SELECT VT_INDEX.UNITCODE AS UNITCODE,'|| P_NAM ||' AS NAM,'|| P_KY ||' AS KY,VT_INDEX.MAKHOXUAT AS MAKHO,VT_INDEX.MAVATTU AS MAVATTU,0 AS XUATSL, 0 AS XUATGT,0 AS TONCUOIKYSL,0 AS TONCUOIKYGT FROM DM_VATTU WHERE UNITCODE = VT_INDEX.UNITCODE || '''' AND MAVATTU=VT_INDEX.MAVATTU;
      COMMIT;
        END;
       END IF;
     END;

    BEGIN     
      UPDATE '||P_TABLENAME||' SET
      XUATSL=NVL(XUATSL,0)+NVL(VT_INDEX.SOLUONG,0), 
      XUATGT=NVL(XUATGT,0)+NVL(VT_INDEX.XUATGT,0), 
      TONCUOIKYSL=NVL(TONCUOIKYSL,0)-NVL(VT_INDEX.SOLUONG,0),
      TONCUOIKYGT=NVL(TONCUOIKYGT,0)-NVL(VT_INDEX.XUATGT,0)
      WHERE UNITCODE =VT_INDEX.UNITCODE AND  MAVATTU=VT_INDEX.MAVATTU AND MAKHO=VT_INDEX.MAKHOXUAT;      
        COMMIT;
    END;

    END LOOP; 
    END;';
    DBMS_OUTPUT.PUT_LINE(N_SQL_INSERT);
      EXECUTE IMMEDIATE N_SQL_INSERT;
        EXCEPTION WHEN OTHERS THEN  DBMS_OUTPUT.PUT_LINE(SQLERRM);        
  END XNT_GIAM_PHIEU;
  PROCEDURE XNT_TANG_PHIEU(P_TABLENAME IN VARCHAR2, P_NAM IN VARCHAR2,P_KY IN NUMBER,P_ID IN VARCHAR2 ) IS
    N_SQL_INSERT VARCHAR(32767);    
	N_LOAICHUNGTU VARCHAR(100);  
	STR_IF_REFUND VARCHAR(32767);
BEGIN
SELECT LOAICHUNGTU INTO N_LOAICHUNGTU FROM VIEW_VATTUGD_XNT WHERE ID = P_ID AND ROWNUM = 1;
	STR_IF_REFUND:= 'SELECT MAVATTU,MAKHONHAP,UNITCODE,SUM(SOLUONG) AS SOLUONG,SUM(SOLUONG*DONGIA) AS NHAPGT FROM VIEW_VATTUGD_XNT V WHERE 
    ID='''||P_ID||'''     
    GROUP BY MAVATTU,MAKHONHAP,UNITCODE;';
	IF N_LOAICHUNGTU = '2' THEN
	BEGIN
	STR_IF_REFUND := 'SELECT B.MAVATTU, B.MAKHONHAP, B.UNITCODE, B.SOLUONG, CASE  WHEN P.TONCUOIKYSL =  0 THEN NVL(G.GIAMUA, 0)*B.SOLUONG  WHEN (P.TONDAUKYSL + P.NHAPSL) IS NULL THEN NVL(G.GIAMUA, 0)*B.SOLUONG  ELSE ABS(B.SOLUONG*((P.TONDAUKYGT + P.NHAPGT)/(P.TONDAUKYSL + P.NHAPSL))) END AS NHAPGT from 
    (SELECT MAVATTU, MAKHONHAP, UNITCODE, SUM(SOLUONG) AS SOLUONG, SUM(DONGIA*SOLUONG) AS NHAPGT 
    FROM VIEW_VATTUGD_XNT WHERE  
    ID='''||P_ID||''' GROUP BY MAVATTU, MAKHONHAP, UNITCODE)  B 
    LEFT JOIN '||P_TABLENAME||' P  ON  B.MAVATTU = P.MAVATTU AND B.MAKHONHAP = P.MAKHO AND B.UNITCODE = P.UNITCODE 
		LEFT JOIN DM_VATTU_GIACA G ON B.MAVATTU = G.MAVATTU AND B.UNITCODE = G.MADONVI ;';
	END;
	END IF;
    N_SQL_INSERT :='DECLARE 
    N_COUNT NUMBER :=0; P_TONDAUKYSL NUMBER :=0; P_TONDAUKYGT NUMBER :=0;
    CURSOR NHAP_VATTUGD IS '||STR_IF_REFUND||'

  BEGIN FOR VT_INDEX IN NHAP_VATTUGD LOOP
    N_COUNT :=0;
      BEGIN 
        SELECT COUNT(*) INTO N_COUNT FROM '||P_TABLENAME||' WHERE 
        MAVATTU=VT_INDEX.MAVATTU AND  MAKHO=VT_INDEX.MAKHONHAP AND UNITCODE=VT_INDEX.UNITCODE;      
        EXCEPTION WHEN OTHERS THEN N_COUNT:=0;
      END;
    BEGIN
      IF(N_COUNT=0) THEN 
        BEGIN 
      INSERT INTO '||P_TABLENAME||' (UNITCODE,NAM,KY,MAKHO,MAVATTU) 
      SELECT VT_INDEX.UNITCODE AS UNITCODE,'|| P_NAM ||' AS NAM,'|| P_KY ||' AS KY,VT_INDEX.MAKHONHAP AS MAKHO,VT_INDEX.MAVATTU AS MAVATTU FROM DM_VATTU WHERE UNITCODE = VT_INDEX.UNITCODE || '''' AND MAVATTU=VT_INDEX.MAVATTU;
      COMMIT;
        END;
       END IF;
     END;


    BEGIN     
      UPDATE '||P_TABLENAME||' SET
      NHAPSL=NHAPSL+VT_INDEX.SOLUONG, 
	  NHAPGT=NHAPGT+VT_INDEX.NHAPGT, 
	  TONCUOIKYSL= TONCUOIKYSL+VT_INDEX.SOLUONG, 
	  TONCUOIKYGT=TONCUOIKYGT+VT_INDEX.NHAPGT,
	  GIAVON = 
    CASE (TONCUOIKYSL+VT_INDEX.SOLUONG) 
    WHEN 0 THEN 
    NVL((SELECT GIAMUA FROM DM_VATTU_GIACA 
    WHERE MAVATTU = VT_INDEX.MAVATTU AND MADONVI =VT_INDEX.UNITCODE), 0) 
	ELSE ABS((NVL(TONCUOIKYGT, 0) + NVL(VT_INDEX.NHAPGT, 0))/(NVL(TONCUOIKYSL, 0)+NVL(VT_INDEX.SOLUONG, 0))) END
      WHERE UNITCODE =VT_INDEX.UNITCODE AND  MAVATTU=VT_INDEX.MAVATTU AND MAKHO=VT_INDEX.MAKHONHAP; 
        COMMIT;
    END;

    END LOOP; 
    END;';

        DBMS_OUTPUT.PUT_LINE(N_SQL_INSERT);        
      EXECUTE IMMEDIATE N_SQL_INSERT;
        EXCEPTION WHEN OTHERS THEN DBMS_OUTPUT.PUT_LINE(SQLERRM);
END XNT_TANG_PHIEU;


PROCEDURE CAPNHAT_GIAVON_QUAYGIAODICH(P_TABLENAME IN VARCHAR, P_UNITCODE  IN VARCHAR2, P_NGAYPHATSINH IN DATE) IS
P_UPDATE_STR VARCHAR(3232);
P_UPDATE_GV_XNT VARCHAR(3232);
P_UPDATE_GV_VTCT VARCHAR(3232);
N_COUNT NUMBER:=0;
BEGIN
SELECT COUNT(*) INTO N_COUNT FROM DM_THEODOITIENTRINH WHERE PROCESSCODE = 'CAPNHATGIAVON' AND UNITCODE = P_UNITCODE;
      IF N_COUNT = 0 THEN
      INSERT INTO DM_THEODOITIENTRINH (ID, PROCESSCODE, DESCRIPTION, STATE, UNITCODE) VALUES (SYS_GUID(), 'CAPNHATGIAVON', 'TIáº¾N TRÃŒNH Cáº¬P NHáº¬T GIÃ� Vá»�N', 0, P_UNITCODE);
      END IF;
      UPDATE DM_THEODOITIENTRINH SET
      STATE = 20 -- IS RUNNING
      WHERE PROCESSCODE = 'CAPNHATGIAVON' AND UNITCODE = P_UNITCODE;
P_UPDATE_GV_XNT:= 
'MERGE INTO NVHANGGDQUAY_ASYNCCLIENT  a  USING
(select X.UNITCODE as UNITCODE, X.MAKHO as MAKHO, X.MAVATTU AS MAVATTU, 
AVG(X.GIAVON)  as DONGIA from '||P_TABLENAME||' X
group by X.UNITCODE, X.MAKHO, X.MAVATTU) b
ON (a.MAKHOHANG = b.MAKHO and a.MAVATTU = b.MAVATTU and a.NGAYPHATSINH = TO_DATE('''|| P_NGAYPHATSINH ||''',''DD/MM/YY'') and b.UNITCODE = '''||P_UNITCODE||''')
WHEN MATCHED THEN
  UPDATE SET a.GIAVON = CASE b.DONGIA WHEN 0 THEN 
  NVL((SELECT C.GIAMUA FROM DM_VATTU_GIACA C WHERE  C.MAVATTU = b.MAVATTU AND C.MADONVI = b.UNITCODE), 0) 
  ELSE b.DONGIA END';
P_UPDATE_GV_VTCT:=
'MERGE INTO VATTUCHUNGTUCHITIET  a  USING
(select X.UNITCODE as UNITCODE, X.MAKHO as MAKHO, X.MAVATTU AS MAVATTU, 
AVG(X.GIAVON)  as DONGIA from '||P_TABLENAME||' X
group by X.UNITCODE, X.MAKHO, X.MAVATTU) b
ON (b.MAKHO= ''DV1-CH2-K2'' 
and a.MAHANG = b.MAVATTU 
and (select t.NGAYDUYETPHIEU from VATTUCHUNGTU t where t.MACHUNGTUPK = a.MACHUNGTUPK) = TO_DATE('''|| P_NGAYPHATSINH ||''',''DD/MM/YY'') 
and b.UNITCODE = '''||P_UNITCODE||''')
WHEN MATCHED THEN
  UPDATE SET a.GIAVON = CASE b.DONGIA WHEN 0 THEN 
  NVL((SELECT C.GIAMUA FROM DM_VATTU_GIACA C WHERE  C.MAVATTU = b.MAVATTU AND C.MADONVI = b.UNITCODE), 0) 
  ELSE b.DONGIA END';
BEGIN
execute IMMEDIATE P_UPDATE_GV_XNT;
execute IMMEDIATE P_UPDATE_GV_VTCT;
DBMS_OUTPUT.put_line (P_UPDATE_STR || '---');
      UPDATE DM_THEODOITIENTRINH SET
      STATE = 0 -- IS COMPLETE
      WHERE PROCESSCODE = 'CAPNHATGIAVON' AND UNITCODE = P_UNITCODE;   
      commit;
EXCEPTION WHEN OTHERS THEN
      UPDATE DM_THEODOITIENTRINH SET
      STATE = 30 -- IS ERROR
      WHERE PROCESSCODE = 'CAPNHATGIAVON' AND UNITCODE = P_UNITCODE;  
DBMS_OUTPUT.put_line (P_UPDATE_STR);
END;

END CAPNHAT_GIAVON_QUAYGIAODICH;


PROCEDURE XNT_TANGPHIEU_KIEMKE(P_TABLENAME IN VARCHAR2, P_NAM IN VARCHAR2,P_KY IN NUMBER,P_ID IN VARCHAR2 ) IS
 N_LOAICHUNGTU VARCHAR(100);
 N_SQL_INSERT VARCHAR(32767);
 N_SELECT VARCHAR(32767);
  BEGIN
  SELECT LOAICHUNGTU INTO N_LOAICHUNGTU FROM VIEW_VATTUGD_XNT WHERE ID = P_ID; --N_KK
  IF N_LOAICHUNGTU = 'N_KK' THEN
    BEGIN
    N_SELECT:= 'SELECT V.MAVATTU,V.MAKHONHAP,V.UNITCODE,V.SOLUONG AS SOLUONG,V.SOLUONG*P.GIAVON AS NHAPGT 
    FROM VIEW_VATTUGD_XNT V LEFT JOIN '||P_TABLENAME||' P ON V.UNITCODE = P.UNITCODE 
    WHERE V.ID='''||P_ID||''' AND V.MAVATTU = P.MAVATTU AND V.MAKHOXUAT = P.MAKHO AND V.UNITCODE = P.UNITCODE;';
    END;
  END IF;
   N_SQL_INSERT :='DECLARE N_COUNT NUMBER :=0; P_TONDAUKYSL NUMBER :=0; P_TONDAUKYGT NUMBER :=0;
    CURSOR NHAP_KIEMKE IS '||N_SELECT||'
    BEGIN FOR KK_INDEX IN NHAP_KIEMKE LOOP
    N_COUNT :=0;
      BEGIN 
        SELECT COUNT(*) INTO N_COUNT FROM '||P_TABLENAME||' WHERE 
        MAVATTU = KK_INDEX.MAVATTU AND MAKHO=KK_INDEX.MAKHONHAP AND UNITCODE = KK_INDEX.UNITCODE;      
        EXCEPTION WHEN OTHERS THEN N_COUNT:=0;
      END;
    BEGIN
      IF(N_COUNT=0) THEN 
        BEGIN 
      INSERT INTO '||P_TABLENAME||' (UNITCODE,NAM,KY,MAKHO,MAVATTU) 
      SELECT KK_INDEX.UNITCODE AS UNITCODE,'|| P_NAM ||' AS NAM,'|| P_KY ||' AS KY,KK_INDEX.MAKHONHAP AS MAKHO,KK_INDEX.MAVATTU FROM DM_VATTU WHERE UNITCODE=KK_INDEX.UNITCODE AND MAVATTU=KK_INDEX.MAVATTU;
      COMMIT;
        END;
       END IF;
     END;
    BEGIN     
      UPDATE '||P_TABLENAME||' SET
      NHAPSL=NHAPSL+ABS(KK_INDEX.SOLUONG), 
	  NHAPGT=NHAPGT+ABS(KK_INDEX.NHAPGT), 
	  TONCUOIKYSL= TONCUOIKYSL+ABS(KK_INDEX.SOLUONG), 
	  TONCUOIKYGT=TONCUOIKYGT+ABS(KK_INDEX.NHAPGT),
	  GIAVON = 
    CASE (TONCUOIKYSL + ABS(KK_INDEX.SOLUONG)) 
    WHEN 0 THEN 
    NVL((SELECT GIAMUA FROM DM_VATTU_GIACA 
    WHERE MAVATTU = KK_INDEX.MAVATTU AND MADONVI = KK_INDEX.UNITCODE), 0)
    ELSE ( ABS(NVL(TONCUOIKYGT, 0))+ ABS(NVL(KK_INDEX.NHAPGT, 0)) )/( ABS(NVL(TONCUOIKYSL, 0)) + ABS(NVL(KK_INDEX.SOLUONG, 0)) ) END
      WHERE UNITCODE = KK_INDEX.UNITCODE AND  MAVATTU = KK_INDEX.MAVATTU AND MAKHO=KK_INDEX.MAKHONHAP; 
        COMMIT;
    END; 
    END LOOP; 
    END;'; 
        DBMS_OUTPUT.PUT_LINE(N_SQL_INSERT);        
      EXECUTE IMMEDIATE N_SQL_INSERT;
        EXCEPTION WHEN OTHERS THEN DBMS_OUTPUT.PUT_LINE(N_SQL_INSERT);
  END XNT_TANGPHIEU_KIEMKE;


  PROCEDURE XNT_GIAMPHIEU_KIEMKE(P_TABLENAME IN VARCHAR2,P_NAM IN VARCHAR2,P_KY IN NUMBER,P_ID IN VARCHAR2 ) IS
    N_SQL_INSERT VARCHAR(32767);
  BEGIN
  N_SQL_INSERT:='DECLARE 
    N_COUNT NUMBER :=0; P_TONDAUKYSL NUMBER :=0; P_TONDAUKYGT NUMBER :=0;
    CURSOR XUAT_KIEMKE IS 
	SELECT B.MAVATTU, B.MAKHOXUAT, B.UNITCODE, B.SOLUONG,NVL(P.GIAVON, 0)*B.SOLUONG AS XUATGT FROM 
    (SELECT MAVATTU, MAKHOXUAT, UNITCODE, SUM(SOLUONG) AS SOLUONG, SUM(DONGIA*SOLUONG) AS XUATGT 
    FROM VIEW_VATTUGD_XNT WHERE ID='''||P_ID||''' GROUP BY MAVATTU, MAKHOXUAT, UNITCODE)  B 
    LEFT JOIN '||P_TABLENAME||' P  ON  B.MAVATTU = P.MAVATTU AND B.MAKHOXUAT = P.MAKHO AND B.UNITCODE = P.UNITCODE;
  BEGIN FOR KK_INDEX IN XUAT_KIEMKE LOOP
    N_COUNT :=0;
      BEGIN 
        SELECT COUNT(*) INTO N_COUNT FROM '||P_TABLENAME||' WHERE MAVATTU=KK_INDEX.MAVATTU AND MAKHO=KK_INDEX.MAKHOXUAT AND UNITCODE=KK_INDEX.UNITCODE;      
        EXCEPTION WHEN OTHERS THEN N_COUNT:=0;
      END;
    BEGIN
      IF(N_COUNT=0) THEN 
        BEGIN 
      INSERT INTO '||P_TABLENAME||' (UNITCODE,NAM,KY,MAKHO,MAVATTU) 
      SELECT KK_INDEX.UNITCODE AS UNITCODE,'|| P_NAM ||' AS NAM,'|| P_KY ||' AS KY,KK_INDEX.MAKHOXUAT AS MAKHO,KK_INDEX.MAVATTU FROM DM_VATTU WHERE UNITCODE=KK_INDEX.UNITCODE AND MAVATTU=KK_INDEX.MAVATTU;
      COMMIT;
        END;
       END IF;
     END;

    BEGIN     
      UPDATE '||P_TABLENAME||' SET
      XUATSL=XUATSL+ABS(KK_INDEX.SOLUONG), XUATGT=XUATGT+ABS(KK_INDEX.XUATGT), TONCUOIKYSL=TONCUOIKYSL-ABS(KK_INDEX.SOLUONG),TONCUOIKYGT=TONCUOIKYGT-ABS(KK_INDEX.XUATGT)
      WHERE UNITCODE =KK_INDEX.UNITCODE AND  MAVATTU=KK_INDEX.MAVATTU AND MAKHO=KK_INDEX.MAKHOXUAT;      
        COMMIT;
    END;

    END LOOP; 
    END;';

      EXECUTE IMMEDIATE N_SQL_INSERT;
        EXCEPTION WHEN OTHERS THEN  DBMS_OUTPUT.PUT_LINE(N_SQL_INSERT);        
  END XNT_GIAMPHIEU_KIEMKE;
  ------------------------------------
  PROCEDURE THONGKE_BANLE(P_NGAY IN DATE, P_UNITCODE IN VARCHAR2) IS
  AMMOUNT NUMBER(18,2);
  N_COUNT NUMBER(18,2);
  INSERT_STR VARCHAR2(1000);
  P_TUNGAY_KYTRUOC DATE;
  BEGIN
   P_TUNGAY_KYTRUOC := P_NGAY - 1;     
      EXECUTE IMMEDIATE 'SELECT SUM(CASE WHEN LOAIGIAODICH = 1 THEN TTIENCOVAT ELSE (-1 * TTIENCOVAT) END) AS THANHTIEN FROM NVGDQUAY_ASYNCCLIENT WHERE LOAIGIAODICH = 1 AND MADONVI = '''||P_UNITCODE||''' AND TO_DATE(NGAYPHATSINH,''DD/MM/YY'') = TO_DATE('''||P_TUNGAY_KYTRUOC||''',''DD/MM/YY'')' INTO AMMOUNT;
      IF AMMOUNT IS NULL THEN AMMOUNT:=0;
      END IF;
      SELECT COUNT(*) INTO N_COUNT FROM THONGKE WHERE UNITCODE = P_UNITCODE AND LOAI = 'XBANLE' AND TO_DATE(TUNGAY,'DD/MM/YY') = TO_DATE(P_TUNGAY_KYTRUOC,'DD/MM/YY');
    IF N_COUNT = 0 THEN
      INSERT_STR:= 'INSERT INTO THONGKE (ID,LOAI,MA,TUNGAY,GIATRI,UNITCODE) VALUES (SYS_GUID(), ''XBANLE'',''XBANLE'','''||P_TUNGAY_KYTRUOC||''', TO_NUMBER('''||AMMOUNT||'''),'''||P_UNITCODE||''')';
    ELSE
      INSERT_STR:= 'UPDATE THONGKE SET GIATRI = TO_NUMBER('''||AMMOUNT||''') WHERE UNITCODE = '''||P_UNITCODE||''' AND LOAI = ''XBANLE'' AND TO_DATE(TUNGAY,''DD/MM/YY'') = TO_DATE('''||P_TUNGAY_KYTRUOC||''',''DD/MM/YY'')';
    END IF;
      EXECUTE IMMEDIATE INSERT_STR;
  END THONGKE_BANLE;
END XNT;
/
create or replace PROCEDURE "NHAPMUATONGHOP" (P_LOAICHUNGTU IN VARCHAR2,P_GROUPBY IN VARCHAR2, 
	P_WAREHOUSE IN VARCHAR2, P_MALOAI IN VARCHAR2,  P_MANHOM IN VARCHAR2,P_MAVATTU IN VARCHAR2,
	P_NHACUNGCAP IN VARCHAR2,P_UNITCODE  IN VARCHAR2, P_MATHUE IN VARCHAR2, P_NGUOIDUNG IN VARCHAR2,
	P_TUNGAY IN DATE,P_DENNGAY IN DATE, cur  OUT SYS_REFCURSOR) AS
	P_EXPRESSION VARCHAR(3000);
	QUERY_STR VARCHAR(3000);
	P_TABLE_GROUPBY VARCHAR(2000);
	P_COLUMNS_GROUPBY VARCHAR(2000);
	P_SELECT_COLUMNS_GROUPBY VARCHAR(2000);
	P_SELECT VARCHAR(2000);
	P_SELECT2 VARCHAR(2000);
BEGIN
		IF TRIM(P_WAREHOUSE) IS NOT NULL THEN
		P_EXPRESSION := P_EXPRESSION||' AND t.MAKHONHAP IN ('||P_WAREHOUSE||')';
		END IF;
		IF TRIM(P_NGUOIDUNG) IS NOT NULL THEN
		P_EXPRESSION := P_EXPRESSION||' AND t.I_CREATE_BY IN ('||P_NGUOIDUNG||')';
		END IF;
		IF TRIM(P_MALOAI) IS NOT NULL THEN
		P_EXPRESSION := P_EXPRESSION||' AND b.MALOAIVATTU IN ('||P_MALOAI||')';
		END IF;
		IF TRIM(P_MANHOM) IS NOT NULL THEN
		P_EXPRESSION := P_EXPRESSION||' AND b.MANHOMVATTU IN ('||P_MANHOM||')';
		END IF;
		IF TRIM(P_MAVATTU) IS NOT NULL THEN
		P_EXPRESSION := P_EXPRESSION||' AND ct.MAHANG IN ('||P_MAVATTU||')';
		END IF;    
		IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
		P_EXPRESSION := P_EXPRESSION||' AND t.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
		END IF;
		IF TRIM(P_MATHUE) IS NOT NULL THEN
		P_EXPRESSION := P_EXPRESSION||' AND ct.VAT IN ('||P_MATHUE||')';
		END IF; 

		IF P_GROUPBY = 'MADONVI' THEN
		BEGIN
		P_COLUMNS_GROUPBY:= 't.UNITCODE, c.TENDONVI';
		P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MADONVI, ''NULL'')  as MaCha, NVL(a.TENDONVI, ''NULL'') as TenCha ';
		P_TABLE_GROUPBY:= ' INNER JOIN AU_DONVI c ON t.UNITCODE = c.MADONVI AND c.UNITCODE = '''||P_UNITCODE||'''';
		P_SELECT2:='t.UNITCODE AS MADONVI,c.TENDONVI AS TENDONVI';
		P_SELECT:= ' ';
		END;
		ELSIF P_GROUPBY = 'MAKHO' THEN
		BEGIN
			P_COLUMNS_GROUPBY:= 't.MAKHONHAP, c.TENKHO';
			P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MAKHO, ''NULL'')  as MaCha, NVL(a.TENKHO, ''NULL'') as TenCha ';
			P_TABLE_GROUPBY:= ' INNER JOIN DM_KHO c ON t.MAKHONHAP = c.MAKHO AND c.UNITCODE = '''||P_UNITCODE||'''';
			P_SELECT2:='t.MAKHONHAP AS MAKHO,c.TENKHO AS TENKHO';
			P_SELECT:= ' ';
		END;
		ELSIF P_GROUPBY = 'MANHOMVATTU' THEN
		BEGIN
			P_COLUMNS_GROUPBY:= 'b.MANHOMVATTU,kh.TENNHOMVT';
			P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MANHOMVATTU, ''NULL'')  as MaCha, NVL(a.TENNHOMVT, ''NULL'') as TenCha ';
			P_TABLE_GROUPBY:= ' INNER JOIN DM_NHOMVATTU kh on b.MANHOMVATTU = kh.MANHOMVTU AND kh.UNITCODE = '''||P_UNITCODE||'''';
			P_SELECT2:='b.MANHOMVATTU AS MANHOMVATTU,kh.TENNHOMVT as TENNHOMVT';
			P_SELECT:= ' ';
		END;
		ELSIF P_GROUPBY = 'MALOAIVATTU' THEN
			BEGIN
			P_COLUMNS_GROUPBY:= 'b.MALOAIVATTU,kh.TENLOAIVT';
			P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MALOAIVATTU, ''NULL'')  as MaCha, NVL(a.TENLOAIVT, ''NULL'') as TenCha ';
			P_TABLE_GROUPBY:= ' INNER JOIN DM_LOAIVATTU kh ON b.MALOAIVATTU = kh.MALOAIVATTU AND kh.UNITCODE = '''||P_UNITCODE||'''';
			P_SELECT2:=' b.MALOAIVATTU AS MALOAIVATTU,kh.TENLOAIVT as TENLOAIVT';
			P_SELECT:= ' ';
		END;
		ELSIF P_GROUPBY = 'MANHACUNGCAP' THEN
		BEGIN
			P_COLUMNS_GROUPBY:= 't.MAKHACHHANG , kh.TENNCC';
			P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MAKHACHHANG, ''NULL'')  as MaCha, NVL(a.TENKH, ''NULL'') as TenCha ';
			P_TABLE_GROUPBY:= ' INNER JOIN DM_NHACUNGCAP kh on t.MAKHACHHANG = kh.MANCC  AND kh.UNITCODE = '''||P_UNITCODE||'''';
			P_SELECT2:=' t.MAKHACHHANG AS MAKHACHHANG,kh.TENNCC as TENKH';
			P_SELECT:= ' ';
		END;
		ELSIF P_GROUPBY = 'NGUOIDUNG' THEN
		BEGIN
			P_COLUMNS_GROUPBY:= 't.I_CREATE_BY, c.TENNHANVIEN';
			P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.Ma, ''NULL'')  as MaCha, NVL(a.Ten, ''NULL'') as TenCha ';
			P_TABLE_GROUPBY:= ' INNER JOIN AU_NGUOIDUNG c ON t.I_CREATE_BY = c.USERNAME AND c.UNITCODE = '''||P_UNITCODE||'''';
			P_SELECT2:=' t.I_CREATE_BY AS Ma, c.TENNHANVIEN AS Ten ';
		END;
		ELSIF P_GROUPBY = 'PHIEU' THEN
		BEGIN
			P_COLUMNS_GROUPBY:= 't.MACHUNGTU , t.MACHUNGTUPK';
			P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MACHUNGTU, ''NULL'')  as MaCha, NVL(a.MACHUNGTUPK, ''NULL'') as TenCha ';
			P_TABLE_GROUPBY:= ' AND t.UNITCODE = '''||P_UNITCODE||'''';
			P_SELECT2:=' t.MACHUNGTU AS MACHUNGTU,t.MACHUNGTUPK as MACHUNGTUPK';
			P_SELECT:= ' ';
		END;
		ELSIF P_GROUPBY = 'MAVATTU' THEN
		BEGIN
			P_COLUMNS_GROUPBY:= 'b.MAVATTU,b.TENVATTU,b.GIAMUA,b.GiaBanLeVat';
			P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MAVATTU, ''NULL'')  as MaCha, NVL(a.TENVATTU, ''NULL'') as TenCha,a.MAVATTU as MaCon,a.TENVATTU as TenCon ';
			P_TABLE_GROUPBY:= ' AND b.UNITCODE = '''||P_UNITCODE||''' ';
			P_SELECT2:=' b.MAVATTU as MAVATTU,b.TENVATTU as TENVATTU';
			P_SELECT:= ' ,b.GIAMUA as DONGIANHAP,b.GiaBanLeVat as GiaBanLeVat';
		END;
		ELSIF P_GROUPBY ='MALOAITHUE' THEN
		BEGIN
			P_COLUMNS_GROUPBY:= ' lt.MALOAITHUE ,lt.LOAITHUE';
			P_SELECT_COLUMNS_GROUPBY:= 'a.MaCha , a.TenCha';
			P_TABLE_GROUPBY:= ' ';
			P_SELECT2:='lt.MALOAITHUE as MaCha , lt.LOAITHUE as TenCha';
			P_SELECT:= '';
		END;
		END IF;
		QUERY_STR:= 'SELECT (a.SOLUONG) as SoLuong, (a.TIENHANG) as TIENHANG, (a.TIENVAT) as TIENVAT, (a.TIENCHIETKHAU) as TIENCHIETKHAU, (a.TIENHANG - a.TIENCHIETKHAU + a.TIENVAT) AS TONGTIEN ,'||P_SELECT_COLUMNS_GROUPBY||'
		FROM (
		SELECT   '||P_SELECT2||',SUM(ct.SOLUONG) as SOLUONG, 
				  SUM( ct.SOLUONG * ROUND(NVL(ct.DONGIA,0),2)) AS TIENHANG '||P_SELECT||' ,
				  SUM( ROUND(NVL(ct.DONGIA,0),2) * ROUND(NVL(lt.TYGIA / 100,0),2) * ROUND(ct.SOLUONG,2) ) AS TIENVAT, 
				  SUM(CASE WHEN NVL(t.TIENCHIETKHAU,0) > 0 AND NVL(t.THANHTIENTRUOCVAT,0) > 0 THEN ct.THANHTIEN *(NVL(t.TIENCHIETKHAU,0)/t.THANHTIENTRUOCVAT) ELSE 0 END) as TIENCHIETKHAU  '||P_SELECT||' 
		from VATTUCHUNGTUCHITIET ct 
		INNER JOIN VATTUCHUNGTU t on t.MACHUNGTUPK = ct.MACHUNGTUPK 
		LEFT JOIN DM_LOAITHUE lt ON lt.MALOAITHUE = ct.VAT
		INNER JOIN V_VATTU_GIABAN b on b.MAVATTU = ct.MAHANG AND b.UNITCODE = '''||P_UNITCODE||'''
		'||P_TABLE_GROUPBY||'
		WHERE t.TRANGTHAI = 10
			AND TO_DATE(t.NGAYDUYETPHIEU,''DD/MM/YY'') <= TO_DATE('''||P_DENNGAY||''',''DD/MM/YY'')
			AND TO_DATE(t.NGAYDUYETPHIEU,''DD/MM/YY'') >= TO_DATE('''||P_TUNGAY||''',''DD/MM/YY'') AND t.UNITCODE = '''||P_UNITCODE||''' AND t.LOAICHUNGTU ='''||P_LOAICHUNGTU||''' '||P_EXPRESSION||' group by '||P_COLUMNS_GROUPBY||' ORDER BY '||P_COLUMNS_GROUPBY||') a';
			 DBMS_OUTPUT.put_line (QUERY_STR);  
		OPEN CUR FOR QUERY_STR;
		  EXCEPTION
		   WHEN NO_DATA_FOUND
		   THEN
			  DBMS_OUTPUT.put_line ('<your message>' || SQLERRM);
		   WHEN OTHERS
		   THEN
				 DBMS_OUTPUT.put_line (SQLERRM);     
END NHAPMUATONGHOP;
--------------------------------------------------------
--  DDL for Procedure NHAPMUATONGHOP
--------------------------------------------------------

/
create or replace PROCEDURE "NHAPMUACHITIET" (P_LOAICHUNGTU IN VARCHAR2, P_GROUPBY IN VARCHAR2,P_WAREHOUSE IN VARCHAR2, 
P_MALOAI IN VARCHAR2,  P_MANHOM IN VARCHAR2,P_MAVATTU IN VARCHAR2,P_NHACUNGCAP IN VARCHAR2,
P_UNITCODE  IN VARCHAR2, P_NGUOIDUNG IN VARCHAR2,
P_TUNGAY IN DATE,P_DENNGAY IN DATE,
P_MATHUE IN VARCHAR2,
cur  OUT SYS_REFCURSOR) AS
P_EXPRESSION VARCHAR(3232);
QUERY_STR VARCHAR(32767);
P_TABLE_GROUPBY VARCHAR(32767);
P_COLUMNS_GROUPBY VARCHAR(32767);
P_SELECT_COLUMNS_GROUPBY VARCHAR(32767);
P_SELECT VARCHAR(3232);
P_SELECT2 VARCHAR(3232);
BEGIN
IF TRIM(P_WAREHOUSE) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND t.MAKHONHAP IN ('||P_WAREHOUSE||')';
END IF;
IF TRIM(P_MALOAI) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MALOAIVATTU IN ('||P_MALOAI||')';
END IF;
IF TRIM(P_MANHOM) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MANHOMVATTU IN ('||P_MANHOM||')';
END IF;
IF TRIM(P_NGUOIDUNG) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND t.I_CREATE_BY IN ('||P_NGUOIDUNG||')';
END IF;
IF TRIM(P_MAVATTU) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND ct.MAHANG IN ('||P_MAVATTU||')';
END IF;    
IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND t.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
END IF;
IF TRIM(P_MATHUE) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND ct.VAT IN ('||P_MATHUE||')';
END IF;   
IF P_GROUPBY = 'MADONVI' THEN
BEGIN
P_COLUMNS_GROUPBY:= 't.UNITCODE, c.TENDONVI,b.MAVATTU,b.TENVATTU,ct.DONGIA,b.GiaBanLeVat,t.NGAYCHUNGTU,b.TENNHACUNGCAP';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MADONVI, ''NULL'')  as MaCha, NVL(a.TENDONVI, ''NULL'') as TenCha,a.MAVATTU as MaCon,a.TENVATTU as TenCon,a.NGAYCHUNGTU as NGAYCHUNGTU  ';
P_TABLE_GROUPBY:= ' INNER JOIN AU_DONVI c ON t.UNITCODE = c.MADONVI AND c.UNITCODE = '''||P_UNITCODE||'''';
P_SELECT2:='b.TENNHACUNGCAP as TENNHACUNGCAP,t.NGAYCHUNGTU as NGAYCHUNGTU,t.UNITCODE AS MADONVI,c.TENDONVI AS TENDONVI,b.MAVATTU as MAVATTU,b.TENVATTU as TENVATTU';
P_SELECT:= ' ';
END;
ELSIF P_GROUPBY = 'MAKHO' THEN
BEGIN
P_COLUMNS_GROUPBY:= 't.MAKHONHAP, c.TENKHO,b.MAVATTU,b.TENVATTU,ct.DONGIA,b.GiaBanLeVat,t.NGAYCHUNGTU,b.TENNHACUNGCAP';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MAKHO, ''NULL'')  as MaCha, NVL(a.TENKHO, ''NULL'') as TenCha,a.MAVATTU as MaCon,a.TENVATTU as TenCon,a.NGAYCHUNGTU as NGAYCHUNGTU  ';
P_TABLE_GROUPBY:= ' INNER JOIN DM_KHO c ON t.MAKHONHAP = c.MAKHO AND c.UNITCODE = '''||P_UNITCODE||'''';
P_SELECT2:='b.TENNHACUNGCAP as TENNHACUNGCAP,t.NGAYCHUNGTU as NGAYCHUNGTU,t.MAKHONHAP AS MAKHO,c.TENKHO AS TENKHO,b.MAVATTU as MAVATTU,b.TENVATTU as TENVATTU';
P_SELECT:= ' ';
END;
ELSIF P_GROUPBY = 'MANHOMVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MANHOMVATTU,kh.TENNHOMVT,b.MAVATTU,b.TENVATTU,ct.DONGIA,b.GiaBanLeVat,t.NGAYCHUNGTU ,b.TENNHACUNGCAP';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MANHOMVATTU, ''NULL'')  as MaCha, NVL(a.TENNHOMVT, ''NULL'') as TenCha,a.MAVATTU as MaCon,a.TENVATTU as TenCon,a.NGAYCHUNGTU as NGAYCHUNGTU ';
P_TABLE_GROUPBY:= ' INNER JOIN DM_NHOMVATTU kh on b.MANHOMVATTU = kh.MANHOMVTU AND kh.UNITCODE = '''||P_UNITCODE||'''';
P_SELECT2:='b.TENNHACUNGCAP as TENNHACUNGCAP,t.NGAYCHUNGTU as NGAYCHUNGTU, b.MANHOMVATTU AS MANHOMVATTU,kh.TENNHOMVT as TENNHOMVT,b.MAVATTU as MAVATTU,b.TENVATTU as TENVATTU';
P_SELECT:= ' ';
END;
ELSIF P_GROUPBY = 'MALOAIVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MALOAIVATTU,kh.TENLOAIVT,b.MAVATTU,b.TENVATTU,ct.DONGIA,b.GiaBanLeVat,t.NGAYCHUNGTU,b.TENNHACUNGCAP ';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MALOAIVATTU, ''NULL'')  as MaCha, NVL(a.TENLOAIVT, ''NULL'') as TenCha,a.MAVATTU as MaCon,a.TENVATTU as TenCon,a.NGAYCHUNGTU as NgayChungTu ';
P_TABLE_GROUPBY:= ' INNER JOIN DM_LOAIVATTU kh ON b.MALOAIVATTU = kh.MALOAIVATTU AND kh.UNITCODE = '''||P_UNITCODE||'''';
P_SELECT2:='b.TENNHACUNGCAP as TENNHACUNGCAP, t.NGAYCHUNGTU as NGAYCHUNGTU,b.MALOAIVATTU AS MALOAIVATTU,kh.TENLOAIVT as TENLOAIVT,b.MAVATTU as MAVATTU,b.TENVATTU as TENVATTU';

P_SELECT:= ' ';

END;
ELSIF P_GROUPBY = 'MANHACUNGCAP' THEN
BEGIN
P_COLUMNS_GROUPBY:= 't.MAKHACHHANG,kh.TENNCC,b.MAVATTU,b.TENVATTU,ct.DONGIA,b.GiaBanLeVat,t.NGAYCHUNGTU,b.TENNHACUNGCAP';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MAKHACHHANG, ''NULL'')  as MaCha, NVL(a.TENKH, ''NULL'') as TenCha,a.MAVATTU as MaCon,a.TENVATTU as TenCon,a.NGAYCHUNGTU as NgayChungTu ';
P_TABLE_GROUPBY:= ' INNER JOIN DM_NHACUNGCAP kh on t.MAKHACHHANG = kh.MANCC  AND kh.UNITCODE = '''||P_UNITCODE||'''';
P_SELECT2:='b.TENNHACUNGCAP as TENNHACUNGCAP, t.NGAYCHUNGTU as NGAYCHUNGTU ,t.MAKHACHHANG AS MAKHACHHANG,kh.TENNCC as TENKH,b.MAVATTU as MAVATTU,b.TENVATTU as TENVATTU';
P_SELECT:= ' ';
END;
ELSIF P_GROUPBY = 'PHIEU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 't.MACHUNGTUPK,t.MACHUNGTU,b.MAVATTU,b.TENVATTU,ct.DONGIA,b.GiaBanLeVat,t.NGAYCHUNGTU,b.TENNHACUNGCAP';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MACHUNGTU, ''NULL'')  as MaCha, NVL(a.MACHUNGTUPK, ''NULL'') as TenCha,a.MAVATTU as MaCon,a.TENVATTU as TenCon,a.NGAYCHUNGTU as NgayChungTu ';
P_TABLE_GROUPBY:= ' AND t.UNITCODE = '''||P_UNITCODE||''' ';
P_SELECT2:='b.TENNHACUNGCAP as TENNHACUNGCAP, t.NGAYCHUNGTU as NGAYCHUNGTU ,t.MACHUNGTUPK AS MACHUNGTUPK,t.MACHUNGTU AS MACHUNGTU,b.MAVATTU as MAVATTU,b.TENVATTU as TENVATTU';
P_SELECT:= ' ';
END;
ELSIF P_GROUPBY ='MALOAITHUE' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'ct.VAT, lt.LOAITHUE,b.MAVATTU,b.TENVATTU,ct.DONGIA,b.GiaBanLeVat,t.NGAYCHUNGTU,b.TENNHACUNGCAP';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MALOAITHUE, ''NULL'')  as MaCha, NVL(a.LOAITHUE, ''NULL'') as TenCha,a.MAVATTU as MaCon,a.TENVATTU as TenCon,a.NGAYCHUNGTU as NGAYCHUNGTU  ';
P_TABLE_GROUPBY:= ' ';
P_SELECT2:='b.TENNHACUNGCAP as TENNHACUNGCAP,t.NGAYCHUNGTU as NGAYCHUNGTU,ct.VAT AS MALOAITHUE,lt.LOAITHUE AS LOAITHUE,b.MAVATTU as MAVATTU,b.TENVATTU as TENVATTU';
P_SELECT:= ' ';
END;
ELSIF P_GROUPBY = 'NGUOIDUNG' THEN
BEGIN
P_COLUMNS_GROUPBY:= 't.I_CREATE_BY, c.TENNHANVIEN,b.MAVATTU,b.TENVATTU,ct.DONGIA,b.GiaBanLeVat,t.NGAYCHUNGTU,b.TENNHACUNGCAP';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.USERNAME, ''NULL'')  as MaCha, NVL(a.TENNHANVIEN, ''NULL'') as TenCha,a.MAVATTU as MaCon,a.TENVATTU as TenCon,a.NGAYCHUNGTU as NGAYCHUNGTU  ';
P_TABLE_GROUPBY:= ' INNER JOIN AU_NGUOIDUNG c ON t.I_CREATE_BY = c.USERNAME AND c.UNITCODE = '''||P_UNITCODE||'''';
P_SELECT2:='b.TENNHACUNGCAP as TENNHACUNGCAP,t.NGAYCHUNGTU as NGAYCHUNGTU,t.I_CREATE_BY AS USERNAME,c.TENNHANVIEN AS TENNHANVIEN,b.MAVATTU as MAVATTU,b.TENVATTU as TENVATTU';
P_SELECT:= ' ';
END;
ELSE --ELSIF P_GROUPBY = 'MAVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU,b.TENVATTU,ct.DONGIA,b.GiaBanLeVat,t.NGAYCHUNGTU,b.TENNHACUNGCAP';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MAVATTU, ''NULL'')  as MaCha, NVL(a.TENVATTU, ''NULL'') as TenCha,a.MAVATTU as MaCon,a.TENVATTU as TenCon,a.NGAYCHUNGTU AS NgayChungTu ';
P_TABLE_GROUPBY:= ' AND b.UNITCODE = '''||P_UNITCODE||''' ';
P_SELECT2:='b.TENNHACUNGCAP as TENNHACUNGCAP, t.NGAYCHUNGTU as NGAYCHUNGTU,b.MAVATTU as MAVATTU,b.TENVATTU as TENVATTU';
P_SELECT:= ' ';
END;
END IF;
QUERY_STR:= 'select a.BARCODE,(a.SOLUONG) as SoLuong,(a.DONGIANHAP) as DonGiaNhap,a.GiaBanLeVat as GiaBan, (a.TIENHANG) as TienHang, (a.TIENVAT) as TienVat, (a.TIENCHIETKHAU) as TienChietKhau, (a.TIENHANG - a.TIENCHIETKHAU + a.TIENVAT) AS TongTien ,a.TENNHACUNGCAP,'||P_SELECT_COLUMNS_GROUPBY||'
FROM (
SELECT '||P_SELECT2||',
SUM(ct.SOLUONG) as SOLUONG, 
SUM(ct.SOLUONG * ROUND(NVL(ct.DONGIA,0),2)) AS TIENHANG ,
SUM(ROUND(NVL(ct.DONGIA,0),2) * ROUND(NVL(lt.TYGIA/100,0),2) * ROUND(ct.SOLUONG,2)) AS TIENVAT, 
SUM(CASE WHEN NVL(t.TIENCHIETKHAU,0) > 0 AND NVL(t.THANHTIENTRUOCVAT,0) > 0 THEN ct.THANHTIEN *(NVL(t.TIENCHIETKHAU,0)/t.THANHTIENTRUOCVAT) ELSE 0 END) as TIENCHIETKHAU,
ROUND(NVL(ct.DONGIA,0),2) as DONGIANHAP,
ROUND(NVL(b.GiaBanLeVat,0),2) as GiaBanLeVat,
b.BARCODE AS BARCODE
FROM VATTUCHUNGTUCHITIET ct 
INNER JOIN VATTUCHUNGTU t on t.MACHUNGTUPK = ct.MACHUNGTUPK 
LEFT JOIN DM_LOAITHUE lt ON lt.MALOAITHUE = ct.VAT
INNER JOIN V_VATTU_GIABAN b on b.MAVATTU = ct.MAHANG AND b.UNITCODE = '''||P_UNITCODE||'''
'||P_TABLE_GROUPBY||'
WHERE
    t.TRANGTHAI = 10
    AND TO_DATE(t.NGAYDUYETPHIEU,''DD/MM/YY'') <= TO_DATE('''||P_DENNGAY||''',''DD/MM/YY'')
    AND TO_DATE(t.NGAYDUYETPHIEU,''DD/MM/YY'') >= TO_DATE('''||P_TUNGAY||''',''DD/MM/YY'') AND t.UNITCODE = '''||P_UNITCODE||''' AND t.LOAICHUNGTU ='''||P_LOAICHUNGTU||''' '||P_EXPRESSION||' GROUP BY '||P_COLUMNS_GROUPBY||',b.BARCODE
    ORDER BY '||P_COLUMNS_GROUPBY||' ) a';
 DBMS_OUTPUT.put_line (QUERY_STR);     
OPEN CUR FOR QUERY_STR;
  EXCEPTION
   WHEN NO_DATA_FOUND
   THEN
      DBMS_OUTPUT.put_line ('<your message>' || SQLERRM);
   WHEN OTHERS
   THEN
         DBMS_OUTPUT.put_line (QUERY_STR  || SQLERRM);     
END NHAPMUACHITIET;
--------------------------------------------------------
--  DDL for Procedure NHAPMUACHITIET
--------------------------------------------------------

/
create or replace PROCEDURE "BAOCAO_DCX_TONGHOP" (P_GROUPBY IN VARCHAR2, P_NGUOIDUNG IN VARCHAR2, P_PTHUCXUAT IN VARCHAR2,P_UNITUSER IN VARCHAR2, P_TAX IN VARCHAR2, P_MAKHO IN VARCHAR2, P_MALOAI IN VARCHAR2,  P_MANHOM IN VARCHAR2,P_MAVATTU IN VARCHAR2, P_NHACUNGCAP IN VARCHAR2, P_MAKHACHHANG IN VARCHAR2, P_UNITCODE IN VARCHAR2, P_TUNGAY IN DATE, P_DENNGAY IN DATE, CUR  OUT SYS_REFCURSOR) IS
    QUERY_STR VARCHAR(32767);
    P_SELECT_COLUMNS_IN_GROUPBY VARCHAR(32767);
    P_SELECT_COLUMNS_OUT_GROUPBY VARCHAR(32767);
    P_TABLE_GROUPBY VARCHAR(32767);
    P_COLUMNS_GROUPBY VARCHAR(32767);
    P_EXPRESSION  VARCHAR(32767):= '';
    P_DCX VARCHAR(32767);
BEGIN
    IF TRIM(P_MAKHO) IS NOT NULL THEN
    P_EXPRESSION := P_EXPRESSION||' AND t.MAKHOXUAT IN ('||P_MAKHO||')';
    END IF;
    IF TRIM(P_MALOAI) IS NOT NULL THEN
    P_EXPRESSION := P_EXPRESSION||' AND b.MALOAIVATTU IN ('||P_MALOAI||')';
    END IF;
    IF TRIM(P_MANHOM) IS NOT NULL THEN
    P_EXPRESSION := P_EXPRESSION||' AND b.MANHOMVATTU IN ('||P_MANHOM||')';
    END IF;
    IF TRIM(P_MAVATTU) IS NOT NULL THEN
    P_EXPRESSION := P_EXPRESSION||' AND b.MAVATTU IN ('||P_MAVATTU||')';
    END IF;    
    IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
    P_EXPRESSION := P_EXPRESSION||' AND b.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
    END IF;  
    IF TRIM(P_MAKHACHHANG) IS NOT NULL THEN
    P_EXPRESSION := P_EXPRESSION||' AND t.MAKHACHHANG IN ('||P_MAKHACHHANG||')';
    END IF;
    IF TRIM(P_NGUOIDUNG) IS NOT NULL THEN
    P_EXPRESSION := P_EXPRESSION||' AND t.I_CREATE_BY IN ('||P_NGUOIDUNG||')';
    END IF;
    IF TRIM(P_UNITUSER) IS NOT NULL THEN
    P_EXPRESSION := P_EXPRESSION||' AND t.MADONVINHAN IN ('||P_UNITUSER||')';
    END IF;  
    IF TRIM(P_TAX) IS NOT NULL THEN
    P_EXPRESSION := P_EXPRESSION||' AND ct.VAT IN ('||P_TAX||')';
    END IF;
    IF P_GROUPBY = 'MADONVIXUAT' THEN
BEGIN
P_COLUMNS_GROUPBY:= 't.UNITCODE,t.MAKHONHAP';
P_SELECT_COLUMNS_OUT_GROUPBY:= ' c.MADONVI AS Ma, c.TENDONVI AS Ten,a.MA AS MADONVIXUAT , a.KHONHAN MAKHONHAN ';
P_SELECT_COLUMNS_IN_GROUPBY:= 't.MAKHONHAP KHONHAN, t.UNITCODE AS MA ';
P_TABLE_GROUPBY:= ' INNER JOIN AU_DONVI c ON a.MA = c.MADONVI';
END;
ELSIF P_GROUPBY = 'MADONVINHAN' THEN
BEGIN
P_COLUMNS_GROUPBY:= 't.MADONVINHAN, t.UNITCODE,t.MAKHONHAP';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'c.MADONVI AS Ma, c.TENDONVI AS Ten,a.UNITCODE AS MADONVIXUAT  ,a.KHONHAN MAKHONHAN ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' t.MADONVINHAN AS MA ,t.MAKHONHAP KHONHAN,t.UNITCODE ';
P_TABLE_GROUPBY:= ' INNER JOIN AU_DONVI c ON a.MA = c.MADONVI';
END;
ELSIF P_GROUPBY = 'MALOAITHUE' THEN
BEGIN
    P_COLUMNS_GROUPBY:= 'g.MALOAITHUE, t.UNITCODE,t.MAKHONHAP';
    P_SELECT_COLUMNS_OUT_GROUPBY:= 'c.MALOAITHUE AS Ma, c.LOAITHUE AS Ten,a.UNITCODE AS MADONVIXUAT, a.KHONHAN MAKHONHAN  ';
    P_SELECT_COLUMNS_IN_GROUPBY:= ' g.MALOAITHUE AS MA ,t.MAKHONHAP KHONHAN, t.UNITCODE ';
    P_TABLE_GROUPBY:= ' LEFT JOIN DM_LOAITHUE c ON a.MA = c.MALOAITHUE';
END;
ELSIF P_GROUPBY = 'MAKHO' THEN
BEGIN
    P_COLUMNS_GROUPBY:= 't.MAKHOXUAT, t.UNITCODE,t.MAKHONHAP';
    P_SELECT_COLUMNS_OUT_GROUPBY:= ' c.MAKHO AS Ma, c.TENKHO AS Ten,a.UNITCODE AS MADONVIXUAT  ,a.KHONHAN MAKHONHAN';
    P_SELECT_COLUMNS_IN_GROUPBY:= ' t.MAKHOXUAT AS MA ,t.MAKHONHAP KHONHAN, t.UNITCODE ';
    P_TABLE_GROUPBY:= ' INNER JOIN DM_KHO c ON a.MA = c.MAKHO AND c.UNITCODE = a.UNITCODE';
END;
ELSIF P_GROUPBY = 'MANHOMVATTU' THEN
BEGIN
    P_COLUMNS_GROUPBY:= 'b.MANHOMVATTU, t.UNITCODE,t.MAKHONHAP';
    P_SELECT_COLUMNS_OUT_GROUPBY:= ' c.MANHOMVTU AS Ma, c.TENNHOMVT AS Ten,a.UNITCODE AS MADONVIXUAT  ,a.KHONHAN MAKHONHAN ';
    P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MANHOMVATTU AS MA ,t.MAKHONHAP KHONHAN, t.UNITCODE ';
    P_TABLE_GROUPBY:= ' INNER JOIN DM_NHOMVATTU c ON a.MA = c.MANHOMVTU AND c.UNITCODE = a.UNITCODE';
END;
ELSIF P_GROUPBY = 'MALOAIVATTU' THEN
BEGIN
    P_COLUMNS_GROUPBY:= 'b.MALOAIVATTU, t.UNITCODE,t.MAKHONHAP';
    P_SELECT_COLUMNS_OUT_GROUPBY:= 'c.MALOAIVATTU AS Ma, c.TENLOAIVT AS Ten,a.UNITCODE AS MADONVIXUAT  ,a.KHONHAN MAKHONHAN ';
    P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MALOAIVATTU AS MA ,t.MAKHONHAP KHONHAN, t.UNITCODE ';
    P_TABLE_GROUPBY:= ' INNER JOIN DM_LOAIVATTU c ON a.MA = c.MALOAIVATTU AND c.UNITCODE = a.UNITCODE';
END;
ELSIF P_GROUPBY = 'MANHACUNGCAP' THEN
BEGIN
    P_COLUMNS_GROUPBY:= 'b.MAKHACHHANG, t.UNITCODE,t.MAKHONHAP';
    P_SELECT_COLUMNS_OUT_GROUPBY:= 'c.MANCC AS Ma, c.TENNCC AS Ten,a.UNITCODE AS MADONVIXUAT  ,a.KHONHAN MAKHONHAN ';
    P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MAKHACHHANG AS MA ,t.MAKHONHAP KHONHAN, t.UNITCODE ';
    P_TABLE_GROUPBY:= ' INNER JOIN DM_NHACUNGCAP c ON a.MA = c.MANCC AND c.UNITCODE = a.UNITCODE';
END;
ELSIF P_GROUPBY = 'MAKHACHHANG' THEN
BEGIN
    P_COLUMNS_GROUPBY:= 't.MAKHACHHANG, t.UNITCODE,t.MAKHONHAP';
    P_SELECT_COLUMNS_OUT_GROUPBY:= 'c.MAKH AS Ma, c.TENKH AS Ten,a.UNITCODE AS MADONVIXUAT  ,a.KHONHAN MAKHONHAN ';
    P_SELECT_COLUMNS_IN_GROUPBY:= ' t.MAKHACHHANG AS MA,t.MAKHONHAP KHONHAN , t.UNITCODE ';
    P_TABLE_GROUPBY:= ' INNER JOIN DM_KHACHHANG c ON a.MA = c.MAKH AND c.UNITCODE = a.UNITCODE';
END;
ELSIF P_GROUPBY = 'NGUOIDUNG' THEN
BEGIN
    P_COLUMNS_GROUPBY:= 't.I_CREATE_BY, t.UNITCODE,t.MAKHONHAP';
    P_SELECT_COLUMNS_OUT_GROUPBY:= 'c.USERNAME AS Ma, c.TENNHANVIEN AS Ten,a.UNITCODE AS MADONVIXUAT  ,a.KHONHAN MAKHONHAN ';
    P_SELECT_COLUMNS_IN_GROUPBY:= ' t.I_CREATE_BY AS MA ,t.MAKHONHAP KHONHAN, t.UNITCODE ';
    P_TABLE_GROUPBY:= ' INNER JOIN AU_NGUOIDUNG c ON a.MA = c.USERNAME AND c.UNITCODE = a.UNITCODE';
END;
ELSIF P_GROUPBY = 'MAGIAODICH' THEN
BEGIN
    P_COLUMNS_GROUPBY:= 't.NOIDUNG, t.UNITCODE, t.MACHUNGTUPK,t.MAKHONHAP';
    P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS Ma, a.TEN AS Ten,a.UNITCODE AS MADONVIXUAT ,a.KHONHAN MAKHONHAN';
    P_SELECT_COLUMNS_IN_GROUPBY:= ' t.MACHUNGTUPK AS MA,t.MAKHONHAP KHONHAN , t.NOIDUNG AS TEN, t.UNITCODE ';
    P_TABLE_GROUPBY:= ' ';
END;
ELSE --ELSIF P_GROUPBY = 'MAVATTU' THEN
BEGIN
    P_COLUMNS_GROUPBY:= 'b.MAVATTU,b.TENVATTU, t.UNITCODE ,t.MAKHONHAP';
    P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS Ma, a.TEN AS Ten,a.UNITCODE AS MADONVIXUAT ,a.KHONHAN MAKHONHAN ';
    P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MAVATTU AS MA,t.MAKHONHAP KHONHAN, b.TENVATTU AS TEN, t.UNITCODE ';
    P_TABLE_GROUPBY:= '  ';
END;
END IF;

IF P_PTHUCXUAT = '0' then
BEGIN
    P_DCX := 'AND NVL(t.UNITCODE,'''') = NVL(t.MADONVINHAN,'''')';
END;
ELSE
BEGIN
    P_DCX := 'AND NVL(t.UNITCODE,'''') <> NVL(t.MADONVINHAN,'''')';
END;
END IF;

QUERY_STR := 'SELECT (a.SOLUONGBAN) AS SOLUONGBAN, a.DONGIANHAP, (a.TIENTHUE) AS TIENTHUE,(a.DOANHTHU) AS DOANHTHU,
                    (a.DOANHTHU + a.TIENTHUE) AS TONGBAN, (a.TIENCHIETKHAU) AS TIENCHIETKHAU, 
                    '||P_SELECT_COLUMNS_OUT_GROUPBY||'
                    FROM (
                    SELECT  '||P_SELECT_COLUMNS_IN_GROUPBY||'
                                              ,SUM(ct.SOLUONG) AS SOLUONGBAN
                                              ,ROUND(SUM(ct.DONGIA),2) AS DONGIANHAP
                                              ,ROUND(SUM(CASE WHEN NVL(t.TIENCHIETKHAU,0) > 0 AND NVL(t.THANHTIENTRUOCVAT,0) > 0 
                                                    THEN ct.THANHTIEN *(NVL(t.TIENCHIETKHAU,0)/t.THANHTIENTRUOCVAT) ELSE 0 END),2) AS TIENCHIETKHAU
                                              ,ROUND(SUM(ct.SOLUONG * ct.DONGIA),2) AS DOANHTHU 
                                              ,ROUND(SUM((NVL(g.TYGIA,0) / 100)*(ct.SOLUONG *ct.DONGIA)),2) AS TIENTHUE
                    FROM VATTUCHUNGTUCHITIET ct 
                    INNER JOIN VATTUCHUNGTU t on t.MACHUNGTUPK = ct.MACHUNGTUPK AND t.LOAICHUNGTU = ''DCX'' '||P_DCX||'
                    INNER JOIN V_VATTU_GIABAN b on b.MAVATTU = ct.MAHANG AND b.MADONVI= t.UNITCODE
                    LEFT JOIN DM_LOAITHUE g on g.MALOAITHUE = ct.VAT
                    WHERE
                    t.TRANGTHAI = 10
                    AND t.UNITCODE = '''||P_UNITCODE||'''
                    AND TO_DATE(t.NGAYDUYETPHIEU,''DD/MM/YY'') <= TO_DATE('''||P_DENNGAY||''',''DD/MM/YY'')
                    AND TO_DATE(t.NGAYDUYETPHIEU,''DD/MM/YY'') >= TO_DATE('''||P_TUNGAY||''',''DD/MM/YY'')
                    '||P_EXPRESSION||' GROUP BY  '||P_COLUMNS_GROUPBY||') a ' || P_TABLE_GROUPBY;
BEGIN
DBMS_OUTPUT.put_line (QUERY_STR);  
OPEN CUR FOR QUERY_STR;
EXCEPTION
            WHEN NO_DATA_FOUND THEN
             NULL;
               WHEN OTHERS THEN
      NULL;
END;
END BAOCAO_DCX_TONGHOP;
--------------------------------------------------------
--  DDL for Procedure BAOCAO_DCX_TONGHOP
--------------------------------------------------------
/
     create or replace PROCEDURE   "BAOCAO_DCN_TONGHOP" (P_TABLE_NAME IN VARCHAR2,P_GROUPBY IN VARCHAR2, P_PTHUCNHAN IN VARCHAR2, 
    P_MAKHO IN VARCHAR2, P_MALOAI IN VARCHAR2,  P_MANHOM IN VARCHAR2,P_MAVATTU IN VARCHAR2, 
    P_NHACUNGCAP IN VARCHAR2, P_UNITCODE IN VARCHAR2, P_MATHUE IN VARCHAR2, P_NGUOIDUNG IN VARCHAR2,P_UNITUSER IN VARCHAR2,
    P_TUNGAY IN DATE, P_DENNGAY IN DATE, CUR  OUT SYS_REFCURSOR) AS
    
    QUERY_STR VARCHAR(3000);
    P_SELECT_COLUMNS_IN_GROUPBY VARCHAR(3000);
    P_SELECT_COLUMNS_OUT_GROUPBY VARCHAR(3000);
    P_TABLE_GROUPBY VARCHAR(3000);
    P_COLUMNS_GROUPBY VARCHAR(3000);
    P_EXPRESSION  VARCHAR(3000):= '';
    P_WHERE_PTNHAN VARCHAR(3000):= '';
    P_NOTNULL VARCHAR(1000):= '';
    BEGIN
    IF P_PTHUCNHAN = 'NHANCHUYENKHO' THEN
        P_WHERE_PTNHAN := ' AND NVL(t.MADONVIXUAT,'''') = NVL(t.UNITCODE,'''') ';
    ELSE 
        P_WHERE_PTNHAN := ' AND NVL(t.MADONVIXUAT,'''') <> NVL(t.UNITCODE,'''') ';
    END IF;
    IF TRIM(P_MAKHO) IS NOT NULL THEN
    P_EXPRESSION := P_EXPRESSION||' AND t.MAKHOXUAT IN ('||P_MAKHO||')';
    END IF;
    IF TRIM(P_MALOAI) IS NOT NULL THEN
    P_EXPRESSION := P_EXPRESSION||' AND b.MALOAIVATTU IN ('||P_MALOAI||')';
    END IF;
    IF TRIM(P_NGUOIDUNG) IS NOT NULL THEN
    P_EXPRESSION := P_EXPRESSION||' AND t.I_CREATE_BY IN ('||P_NGUOIDUNG||')';
    END IF;
    IF TRIM(P_MANHOM) IS NOT NULL THEN
    P_EXPRESSION := P_EXPRESSION||' AND b.MANHOMVATTU IN ('||P_MANHOM||')';
    END IF;
    IF TRIM(P_MAVATTU) IS NOT NULL THEN
    P_EXPRESSION := P_EXPRESSION||' AND b.MAVATTU IN ('||P_MAVATTU||')';
    END IF;    
    IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
    P_EXPRESSION := P_EXPRESSION||' AND b.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
    END IF;  
    IF TRIM(P_MATHUE) IS NOT NULL THEN
    P_EXPRESSION := P_EXPRESSION||' AND ct.VAT IN ('||P_MATHUE||')';
    END IF;
    IF TRIM(P_UNITUSER) IS NOT NULL THEN
    P_EXPRESSION := P_EXPRESSION||' AND t.MADONVIXUAT IN (Select Regexp_Substr('''||P_UNITUSER||''',''[^,]+'',1,Level) Emp_Name From  DUAL Connect By Regexp_Substr('''||P_UNITUSER||''',''[^,]+'' ,1,Level) Is Not Null)';
    END IF;
    IF P_GROUPBY = 'MAKHO' THEN
    BEGIN
        P_COLUMNS_GROUPBY:= 't.MAKHONHAP,t.MAKHOXUAT';
        P_SELECT_COLUMNS_OUT_GROUPBY:= ' c.MAKHO AS Ma, c.TENKHO AS Ten , a.MAKHOXUAT';
        P_SELECT_COLUMNS_IN_GROUPBY:= ' t.MAKHOXUAT AS MA ';
        P_TABLE_GROUPBY:= ' INNER JOIN DM_KHO c ON a.MA = c.MAKHO AND c.UNITCODE = '''||P_UNITCODE||'''';
        P_NOTNULL := ' AND t.MAKHOXUAT IS NOT NULL ';
    END;
    ELSIF P_GROUPBY = 'MADONVI' THEN
    BEGIN
        P_COLUMNS_GROUPBY:= 't.UNITCODE,t.MAKHONHAP,t.MAKHOXUAT';
        P_SELECT_COLUMNS_OUT_GROUPBY:= ' c.MADONVI AS Ma, c.TENDONVI AS Ten,a.MAKHOXUAT';
        P_SELECT_COLUMNS_IN_GROUPBY:= ' t.UNITCODE AS MA ';
        P_TABLE_GROUPBY:= ' INNER JOIN AU_DONVI c ON a.MA = c.MADONVI AND c.MADONVI = '''||P_UNITCODE||'''';
        P_NOTNULL := ' AND t.UNITCODE IS NOT NULL ';
    END;
    ELSIF P_GROUPBY = 'MANHOMVATTU' THEN
    BEGIN
        P_COLUMNS_GROUPBY:= 'b.MANHOMVATTU,t.MAKHONHAP,t.MAKHOXUAT';
        P_SELECT_COLUMNS_OUT_GROUPBY:= ' c.MANHOMVTU AS Ma, c.TENNHOMVT AS Ten, a.MAKHOXUAT';
        P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MANHOMVATTU AS MA ';
        P_TABLE_GROUPBY:= ' INNER JOIN DM_NHOMVATTU c ON a.MA = c.MANHOMVTU AND c.UNITCODE = '''||P_UNITCODE||'''';
        P_NOTNULL := ' AND b.MANHOMVATTU IS NOT NULL ';
    END;
    ELSIF P_GROUPBY = 'MALOAIVATTU' THEN
    BEGIN
        P_COLUMNS_GROUPBY:= 'b.MALOAIVATTU,t.MAKHONHAP,t.MAKHOXUAT';
        P_SELECT_COLUMNS_OUT_GROUPBY:= 'c.MALOAIVATTU AS Ma, c.TENLOAIVT AS Ten, a.MAKHOXUAT';
        P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MALOAIVATTU AS MA ';
        P_TABLE_GROUPBY:= ' INNER JOIN DM_LOAIVATTU c ON a.MA = c.MALOAIVATTU AND c.UNITCODE = '''||P_UNITCODE||'''';
        P_NOTNULL := ' AND b.MALOAIVATTU IS NOT NULL ';
    END;
    ELSIF P_GROUPBY = 'MANHACUNGCAP' THEN
    BEGIN
        P_COLUMNS_GROUPBY:= 'b.MAKHACHHANG,t.MAKHONHAP,t.MAKHOXUAT';
        P_SELECT_COLUMNS_OUT_GROUPBY:= 'c.MANCC AS Ma, c.TENNCC AS Ten , a.MAKHOXUAT';
        P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MAKHACHHANG AS MA ';
        P_TABLE_GROUPBY:= ' INNER JOIN DM_NHACUNGCAP c ON a.MA = c.MANCC AND c.UNITCODE = '''||P_UNITCODE||'''';
        P_NOTNULL := ' AND b.MAKHACHHANG IS NOT NULL ';
    END;
    ELSIF P_GROUPBY = 'NGUOIDUNG' THEN
    BEGIN
        P_COLUMNS_GROUPBY:= 't.I_CREATE_BY,t.MAKHONHAP,t.MAKHOXUAT';
        P_SELECT_COLUMNS_OUT_GROUPBY:= 'c.USERNAME AS Ma, c.TENNHANVIEN AS Ten, a.MAKHOXUAT';
        P_SELECT_COLUMNS_IN_GROUPBY:= ' t.I_CREATE_BY AS MA ';
        P_TABLE_GROUPBY:= ' INNER JOIN AU_NGUOIDUNG c ON a.MA = c.USERNAME AND c.UNITCODE = '''||P_UNITCODE||'''';
    END;
    ELSIF P_GROUPBY = 'MALOAITHUE' THEN
    BEGIN
        P_COLUMNS_GROUPBY:= 'ct.VAT ,t.MAKHONHAP,t.MAKHOXUAT';
        P_SELECT_COLUMNS_OUT_GROUPBY:= 'c.MALOAITHUE AS Ma, c.LOAITHUE AS Ten, a.MAKHOXUAT';
        P_SELECT_COLUMNS_IN_GROUPBY:= ' ct.VAT AS MA ';
        P_TABLE_GROUPBY:= ' LEFT JOIN DM_LOAITHUE c ON a.MA = c.MALOAITHUE AND c.UNITCODE = '''||P_UNITCODE||'''';
        P_NOTNULL := ' AND ct.VAT IS NOT NULL ';
    END;
    ELSIF P_GROUPBY = 'PHIEU' THEN
    BEGIN
        P_COLUMNS_GROUPBY:= 't.MACHUNGTUPK, t.UNITCODE, t.NOIDUNG,t.MAKHONHAP,t.MAKHOXUAT';
        P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS Ma, a.TEN AS Ten,a.UNITCODE AS MADONVI , a.MAKHOXUAT';
        P_SELECT_COLUMNS_IN_GROUPBY:= ' t.MACHUNGTUPK AS MA , t.NOIDUNG AS TEN, t.UNITCODE ';
        P_TABLE_GROUPBY:= ' ';
    END;
    ELSIF P_GROUPBY = 'MADONVIXUAT' THEN
    BEGIN
        P_COLUMNS_GROUPBY:= 't.MADONVIXUAT,t.MAKHOXUAT,t.UNITCODE';
        P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS MA,a.TEN AS Ten, a.MAKHOXUAT';
        P_SELECT_COLUMNS_IN_GROUPBY:= ' t.MADONVIXUAT AS MA, (SELECT TENKHO FROM DM_KHO WHERE MAKHO = t.MAKHOXUAT) AS TEN,t.UNITCODE ';
        P_TABLE_GROUPBY:= '';
        P_NOTNULL := ' AND t.MADONVIXUAT IS NOT NULL ';
    END;
    ELSE --ELSIF P_GROUPBY = 'MAVATTU' THEN
    BEGIN
            P_COLUMNS_GROUPBY:= 'b.MAVATTU,b.TENVATTU,t.MAKHONHAP,t.MAKHOXUAT';
        P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS Ma, a.TEN AS Ten, a.MAKHOXUAT';
        P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MAVATTU AS MA, b.TENVATTU AS TEN ';
        P_TABLE_GROUPBY:= '';
        P_NOTNULL := ' AND b.MAVATTU IS NOT NULL ';
    END;
    END IF;
    
    QUERY_STR := 'select ROUND(a.SOLUONGBAN,2) AS SOLUONGBAN, a.DONGIANHAP, ROUND(a.TIENTHUE,2) AS TIENTHUE,ROUND(a.DOANHTHU,2) AS DOANHTHU,
    (a.DOANHTHU + a.TIENTHUE) AS TONGBAN, a.TIENCHIETKHAU, 
    '||P_SELECT_COLUMNS_OUT_GROUPBY||'
    FROM (
    SELECT  '||P_SELECT_COLUMNS_IN_GROUPBY||'
                              ,SUM(ct.SOLUONG) AS SOLUONGBAN
                              ,ROUND(SUM(ct.DONGIA),2) AS DONGIANHAP
                              ,ROUND(SUM(CASE WHEN NVL(t.TIENCHIETKHAU,0) > 0 AND 
                               NVL(t.THANHTIENTRUOCVAT,0) > 0 
                                THEN ct.THANHTIEN *(NVL(t.TIENCHIETKHAU,0)/t.THANHTIENTRUOCVAT) 
                                ELSE 0 END),2) AS TIENCHIETKHAU
                              ,ROUND(SUM(ct.SOLUONG * ct.DONGIA),2) AS DOANHTHU 
                              ,(SUM(ROUND((NVL(g.TYGIA,0) / 100)*(ct.SOLUONG *ct.DONGIA)))) AS TIENTHUE
                              ,t.MAKHOXUAT AS MAKHOXUAT
    FROM VATTUCHUNGTUCHITIET ct 
    INNER JOIN VATTUCHUNGTU t ON t.MACHUNGTUPK = ct.MACHUNGTUPK AND t.LOAICHUNGTU = ''DCN'' '||P_WHERE_PTNHAN||'
    INNER JOIN DM_VATTU b ON b.MAVATTU = ct.MAHANG
    LEFT JOIN DM_LOAITHUE g ON g.MALOAITHUE = ct.VAT
    WHERE
        t.TRANGTHAI = 10
        AND t.UNITCODE = '''||P_UNITCODE||'''
        AND t.NGAYDUYETPHIEU <=TO_DATE('''||P_DENNGAY||''',''DD/MM/YY'')
        AND t.NGAYDUYETPHIEU >=TO_DATE('''||P_TUNGAY||''',''DD/MM/YY'')
        '||P_EXPRESSION||' '||P_NOTNULL||' GROUP BY  '||P_COLUMNS_GROUPBY||' ORDER BY '||P_COLUMNS_GROUPBY||' ) a 
     '||P_TABLE_GROUPBY ||'';
    BEGIN
    DBMS_OUTPUT.put_line (QUERY_STR);  
    OPEN CUR FOR QUERY_STR;
    EXCEPTION
                WHEN NO_DATA_FOUND THEN
                 NULL;
                   WHEN OTHERS THEN
          NULL;
    END;
    END BAOCAO_DCN_TONGHOP;
    --------------------------------------------------------
    --BAOCAO_DCN_TONGHOP---
    --------------------------------------------------------
/
create or replace PROCEDURE BAOCAO_DCN_CHITIET(P_TABLE_NAME IN VARCHAR2,P_GROUPBY IN VARCHAR2, P_PTHUCNHAN IN VARCHAR2, P_MAKHO IN VARCHAR2, 
P_MALOAI IN VARCHAR2,  P_MANHOM IN VARCHAR2,P_MAVATTU IN VARCHAR2,P_NHACUNGCAP IN VARCHAR2,P_UNITCODE  IN VARCHAR2, P_MATHUE IN VARCHAR2,
P_UNITUSER IN VARCHAR2,P_TUNGAY IN DATE,P_DENNGAY IN DATE, P_NGUOIDUNG IN VARCHAR2, cur  OUT SYS_REFCURSOR) IS

  P_EXPRESSION VARCHAR(3000);
  QUERY_STR VARCHAR(3000);
  P_SELECT_COLUMNS_IN_GROUPBY VARCHAR(3000);
  P_SELECT_COLUMNS_OUT_GROUPBY VARCHAR(3000);
  P_TABLE_GROUPBY VARCHAR(3000);
  P_COLUMNS_GROUPBY VARCHAR(3000);
  P_WHERE_PTNHAN VARCHAR(500):= '';
BEGIN
IF P_PTHUCNHAN = 'NHANCHUYENKHO' THEN
    P_WHERE_PTNHAN := ' AND NVL(t.MADONVIXUAT,'''') = NVL(t.UNITCODE,'''') ';
ELSE 
    P_WHERE_PTNHAN := ' AND NVL(t.MADONVIXUAT,'''') <> NVL(t.UNITCODE,'''') ';
END IF;
IF TRIM(P_MAKHO) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND t.MAKHOXUAT IN ('||P_MAKHO||')';
END IF;
IF TRIM(P_MALOAI) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MALOAIVATTU IN ('||P_MALOAI||')';
END IF;
IF TRIM(P_MANHOM) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MANHOMVATTU IN ('||P_MANHOM||')';
END IF;
IF TRIM(P_NGUOIDUNG) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND t.I_CREATE_BY IN ('||P_NGUOIDUNG||')';
END IF;
IF TRIM(P_MAVATTU) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MAVATTU IN ('||P_MAVATTU||')';
END IF;    
IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
END IF;  
IF TRIM(P_MATHUE) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND ct.VAT IN ('||P_MATHUE||')';
END IF;
IF TRIM(P_UNITUSER) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND t.MADONVIXUAT IN (Select Regexp_Substr('''||P_UNITUSER||''',''[^,]+'',1,Level) Emp_Name From  DUAL Connect By Regexp_Substr('''||P_UNITUSER||''',''[^,]+'' ,1,Level) Is Not Null)';
END IF;
IF P_GROUPBY = 'MADONVI' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU,b.BARCODE, t.MADONVIXUAT,t.NGAYCHUNGTU';
P_SELECT_COLUMNS_OUT_GROUPBY:= ' a.MA AS MaCon, a.TEN AS TenCon,a.BARCODE AS BARCODE, c.MADONVI AS MaCha, c.TENDONVI AS TenCha,a.NGAYCHUNGTU AS NgayGiaoDich ';
P_SELECT_COLUMNS_IN_GROUPBY:= 'b.MAVATTU AS MA, b.TENVATTU AS TEN, b.BARCODE AS BARCODE , t.MAKHOXUAT AS GROUPCODE,t.NGAYCHUNGTU AS NGAYCHUNGTU ';
P_TABLE_GROUPBY:= ' INNER JOIN AU_DONVI c ON a.MADONVI = c.MADONVI AND c.MADONVI = '''||P_UNITCODE||'''';
END;
ELSIF P_GROUPBY = 'MAKHO' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU,b.BARCODE, t.MAKHOXUAT,t.NGAYCHUNGTU';
P_SELECT_COLUMNS_OUT_GROUPBY:= ' a.MA AS MaCon, a.TEN AS TenCon,a.BARCODE AS BARCODE, c.MAKHO AS MaCha, c.TENKHO AS TenCha,a.NGAYCHUNGTU AS NgayGiaoDich ';
P_SELECT_COLUMNS_IN_GROUPBY:= 'b.MAVATTU AS MA, b.TENVATTU AS TEN, b.BARCODE AS BARCODE , t.MAKHOXUAT AS GROUPCODE,t.NGAYCHUNGTU AS NGAYCHUNGTU ';
P_TABLE_GROUPBY:= ' INNER JOIN DM_KHO c ON a.GROUPCODE = c.MAKHO AND c.UNITCODE = '''||P_UNITCODE||'''';
END;
ELSIF P_GROUPBY = 'MANHOMVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU, b.BARCODE,b.MANHOMVATTU,t.NGAYCHUNGTU';
P_SELECT_COLUMNS_OUT_GROUPBY:= ' a.MA AS MaCon, a.TEN AS TenCon, a.BARCODE AS BARCODE,c.MANHOMVTU AS MaCha, c.TENNHOMVT AS TenCha,a.NGAYCHUNGTU AS NgayGiaoDich ';
P_SELECT_COLUMNS_IN_GROUPBY:= 'b.MAVATTU AS MA, b.TENVATTU AS TEN , b.BARCODE AS BARCODE, b.MANHOMVATTU AS GROUPCODE,t.NGAYCHUNGTU AS NGAYCHUNGTU';
P_TABLE_GROUPBY:= ' INNER JOIN DM_NHOMVATTU c ON a.GROUPCODE = c.MANHOMVTU AND c.UNITCODE = '''||P_UNITCODE||'''';
END;
ELSIF P_GROUPBY = 'MALOAIVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU, b.BARCODE, b.MALOAIVATTU,t.NGAYCHUNGTU';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS MaCon, a.TEN AS TenCon, a.BARCODE AS BARCODE,c.MALOAIVATTU AS MaCha, c.TENLOAIVT AS TenCha,a.NGAYCHUNGTU AS NgayGiaoDich ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MAVATTU AS MA, b.TENVATTU AS TEN, b.BARCODE AS BARCODE, b.MALOAIVATTU AS GROUPCODE,t.NGAYCHUNGTU AS NGAYCHUNGTU ';
P_TABLE_GROUPBY:= ' INNER JOIN DM_LOAIVATTU c ON a.GROUPCODE = c.MALOAIVATTU AND c.UNITCODE = '''||P_UNITCODE||'''';
END;
ELSIF P_GROUPBY = 'MANHACUNGCAP' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU, b.BARCODE,  b.MAKHACHHANG,t.NGAYCHUNGTU';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS MaCon, a.TEN AS TenCon, a.BARCODE AS BARCODE, c.MANCC AS MaCha, c.TENNCC AS TenCha,a.NGAYCHUNGTU AS NgayGiaoDich ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MAVATTU AS MA, b.TENVATTU AS TEN, b.BARCODE AS BARCODE, b.MAKHACHHANG AS GROUPCODE,t.NGAYCHUNGTU';
P_TABLE_GROUPBY:= ' INNER JOIN DM_NHACUNGCAP c ON a.GROUPCODE = c.MANCC AND c.UNITCODE = '''||P_UNITCODE||'''';
END;
ELSIF P_GROUPBY = 'NGUOIDUNG' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU, b.BARCODE,  t.I_CREATE_BY, t.NGAYCHUNGTU';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS MaCon, a.TEN AS TenCon, a.BARCODE AS BARCODE, c.USERNAME AS MaCha, c.TENNHANVIEN AS TenCha,a.NGAYCHUNGTU AS NgayGiaoDich ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MAVATTU AS MA, b.TENVATTU AS TEN, b.BARCODE AS BARCODE, t.I_CREATE_BY AS GROUPCODE,t.NGAYCHUNGTU';
P_TABLE_GROUPBY:= ' INNER JOIN AU_NGUOIDUNG c ON a.GROUPCODE = c.USERNAME AND c.UNITCODE = '''||P_UNITCODE||'''';
END;
ELSIF P_GROUPBY = 'MALOAITHUE' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU, b.BARCODE, ct.VAT,t.NGAYCHUNGTU';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS MaCon, a.TEN AS TenCon, a.BARCODE AS BARCODE,a.GROUPCODE AS MaCha, c.LOAITHUE AS TenCha,a.NGAYCHUNGTU AS NgayGiaoDich ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MAVATTU AS MA, b.TENVATTU AS TEN, b.BARCODE AS BARCODE, ct.VAT AS GROUPCODE,t.NGAYCHUNGTU';
P_TABLE_GROUPBY:= ' LEFT JOIN DM_LOAITHUE c ON a.GROUPCODE = c.MALOAITHUE AND c.UNITCODE = '''||P_UNITCODE||'''';
END;
ELSIF P_GROUPBY = 'PHIEU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU,b.BARCODE,t.MACHUNGTUPK,t.NOIDUNG, t.NGAYCHUNGTU';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS MaCon, a.TEN AS TenCon,a.BARCODE AS BARCODE, a.MACHUNGTUPK AS MaCha, a.NOIDUNG AS TenCha,a.NGAYCHUNGTU AS NgayGiaoDich ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MAVATTU AS MA, b.TENVATTU AS TEN,b.BARCODE AS BARCODE, t.MACHUNGTUPK AS MACHUNGTUPK,t.NOIDUNG AS NOIDUNG ,t.NGAYCHUNGTU';
P_TABLE_GROUPBY:= ' ';
END;
ELSIF P_GROUPBY = 'MADONVIXUAT' THEN
    BEGIN
        P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU, b.BARCODE,t.MADONVIXUAT,t.MAKHOXUAT,t.UNITCODE,t.NGAYCHUNGTU';
        P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS MACHA, a.TEN AS TENCHA,a.MAVATTU AS MACON,a.TENVATTU AS TENCON, a.NGAYCHUNGTU AS NGAYGIAODICH,a.MAKHOXUAT';
        P_SELECT_COLUMNS_IN_GROUPBY:= ' t.MADONVIXUAT AS MA, (SELECT TENDONVI FROM AU_DONVI WHERE MADONVI = t.MADONVIXUAT) AS TEN,b.MAVATTU,b.TENVATTU,t.NGAYCHUNGTU ,t.UNITCODE ';
        P_TABLE_GROUPBY:= '';
    END;
ELSE --ELSIF P_GROUPBY = 'MAVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU, b.BARCODE,t.NGAYCHUNGTU';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS MaCon, a.TEN AS TenCon, a.BARCODE AS BARCODE,  a.MA AS MaCha, a.TEN AS TenCha,a.NGAYCHUNGTU AS NgayGiaoDich';
P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MAVATTU AS MA, b.TENVATTU AS TEN , b.BARCODE AS BARCODE,t.NGAYCHUNGTU';
P_TABLE_GROUPBY:= ' ';
END;
END IF;
  QUERY_STR:= 'select ROUND(a.SOLUONGBAN,2) as SOLUONGBAN,
                     a.DONGIANHAP,
                     ROUND(a.TIENTHUE) AS TIENTHUE,
                     ROUND(a.DOANHTHU) AS DOANHTHU,
                     ROUND(a.DOANHTHU + a.TIENTHUE) AS TONGBAN,
                     a.TIENCHIETKHAU,
  '||P_SELECT_COLUMNS_OUT_GROUPBY||'
  from (
  SELECT  '||P_SELECT_COLUMNS_IN_GROUPBY||'
                          ,SUM(ct.SOLUONG) as SOLUONGBAN
                          ,ROUND(SUM(ct.DONGIA),2) as DONGIANHAP
                          ,t.UNITCODE AS MADONVI
                          ,t.MAKHOXUAT AS MAKHOXUAT
                          ,ROUND(SUM(CASE WHEN NVL(t.TIENCHIETKHAU,0) >0 AND NVL(t.THANHTIENTRUOCVAT,0)>0 THEN ct.THANHTIEN *(NVL(t.TIENCHIETKHAU,0)/t.THANHTIENTRUOCVAT) ELSE 0 END),2) as TIENCHIETKHAU
                          ,SUM(ct.SOLUONG * ct.DONGIA) as DOANHTHU 
                          ,SUM((NVL(g.TYGIA,0) / 100)*(ct.SOLUONG *ct.DONGIA)) as TIENTHUE
                      from VATTUCHUNGTUCHITIET ct 
INNER JOIN VATTUCHUNGTU t on t.MACHUNGTUPK = ct.MACHUNGTUPK AND t.LOAICHUNGTU = ''DCN'' '||P_WHERE_PTNHAN||'
INNER JOIN DM_VATTU b on b.MAVATTU = ct.MAHANG
LEFT JOIN DM_LOAITHUE g on g.MALOAITHUE = ct.VAT
WHERE
    t.TRANGTHAI = 10
        AND t.UNITCODE = '''||P_UNITCODE||'''
    AND TO_DATE(t.NGAYDUYETPHIEU,''DD/MM/YY'') <= TO_DATE('''||P_DENNGAY||''',''DD/MM/YY'')
    AND TO_DATE(t.NGAYDUYETPHIEU,''DD/MM/YY'') >= TO_DATE('''||P_TUNGAY||''',''DD/MM/YY'')
	'||P_EXPRESSION||'
	group by  t.UNITCODE,t.MAKHOXUAT,'||P_COLUMNS_GROUPBY||'
  ORDER BY '||P_COLUMNS_GROUPBY||') a '||P_TABLE_GROUPBY;
 DBMS_OUTPUT.put_line (QUERY_STR );    
  OPEN cur FOR QUERY_STR;
  EXCEPTION
   WHEN NO_DATA_FOUND
   THEN
      DBMS_OUTPUT.put_line ('<your message>' || SQLERRM);
   WHEN OTHERS
   THEN
         DBMS_OUTPUT.put_line (SQLERRM);     
  END BAOCAO_DCN_CHITIET;
/
create or replace PROCEDURE            "BAOCAO_XKHAC_CHITIET" (P_GROUPBY IN VARCHAR2,P_PTHUCXUAT IN VARCHAR2, P_NGUOIDUNG IN VARCHAR2, P_UNITUSER IN VARCHAR2, P_TAX IN VARCHAR2, P_MAKHO IN VARCHAR2, P_MALOAI IN VARCHAR2,  P_MANHOM IN VARCHAR2,P_MAVATTU IN VARCHAR2,P_NHACUNGCAP IN VARCHAR2, P_MAKHACHHANG IN VARCHAR2,P_UNITCODE  IN VARCHAR2, P_TUNGAY IN DATE,P_DENNGAY IN DATE, cur  OUT SYS_REFCURSOR) IS
  P_EXPRESSION VARCHAR(3232);
  QUERY_STR VARCHAR(32767);
  P_SELECT_COLUMNS_IN_GROUPBY VARCHAR(32767);
P_SELECT_COLUMNS_OUT_GROUPBY VARCHAR(32767);
P_TABLE_GROUPBY VARCHAR(32767);
P_COLUMNS_GROUPBY VARCHAR(32767);
  BEGIN
IF TRIM(P_MAKHO) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND t.MAKHOXUAT IN ('||P_MAKHO||')';
END IF;
IF TRIM(P_MALOAI) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MALOAIVATTU IN ('||P_MALOAI||')';
END IF;
IF TRIM(P_MANHOM) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MANHOMVATTU IN ('||P_MANHOM||')';
END IF;
IF TRIM(P_MAVATTU) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MAVATTU IN ('||P_MAVATTU||')';
END IF;    
IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
END IF;
IF TRIM(P_NGUOIDUNG) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND t.I_CREATE_BY IN ('||P_NGUOIDUNG||')';
END IF;
IF TRIM(P_MAKHACHHANG) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND t.MAKHACHHANG IN ('||P_MAKHACHHANG||')';
END IF;  
IF TRIM(P_UNITUSER) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND t.MADONVINHAN IN ('||P_UNITUSER||')';
END IF;  
IF TRIM(P_TAX) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND ct.VAT IN ('||P_TAX||')';
END IF;  
IF P_GROUPBY = 'MADONVIXUAT' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU,b.BARCODE, t.UNITCODE,t.NGAYCHUNGTU';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS MaCon, a.TEN AS TenCon,a.BARCODE AS BARCODE, c.MADONVI AS MaCha,  c.TENDONVI  AS TenCha,a.NGAYCHUNGTU AS NgayGiaoDich, a.GROUPCODE AS MADONVIXUAT ';
P_SELECT_COLUMNS_IN_GROUPBY:= 'b.MAVATTU AS MA, b.TENVATTU AS TEN,b.BARCODE AS BARCODE , t.UNITCODE AS GROUPCODE,t.NGAYCHUNGTU AS NGAYCHUNGTU ';
P_TABLE_GROUPBY:= ' INNER JOIN AU_DONVI c ON a.GROUPCODE = c.MADONVI';
END;
ELSIF P_GROUPBY = 'MADONVINHAN' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU,b.BARCODE, t.MADONVINHAN,t.NGAYCHUNGTU, t.UNITCODE';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS MaCon, a.TEN AS TenCon,a.BARCODE AS BARCODE, c.MADONVI AS MaCha,  c.TENDONVI  AS TenCha,a.NGAYCHUNGTU AS NgayGiaoDich, a.UNITCODE AS MADONVIXUAT ';
P_SELECT_COLUMNS_IN_GROUPBY:= 'b.MAVATTU AS MA, b.TENVATTU AS TEN,b.BARCODE AS BARCODE , t.MADONVINHAN AS GROUPCODE,t.NGAYCHUNGTU AS NGAYCHUNGTU, t.UNITCODE ';
P_TABLE_GROUPBY:= ' INNER JOIN AU_DONVI c ON a.GROUPCODE = c.MADONVI';
END;
ELSIF P_GROUPBY = 'MALOAITHUE' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU,b.BARCODE, ct.VAT, t.NGAYCHUNGTU';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS MaCon, a.TEN AS TenCon,a.BARCODE AS BARCODE, c.MALOAITHUE AS MaCha,  c.LOAITHUE AS TenCha,a.NGAYCHUNGTU AS NgayGiaoDich   ';
P_SELECT_COLUMNS_IN_GROUPBY:= 'b.MAVATTU AS MA, b.TENVATTU AS TEN,b.BARCODE AS BARCODE , ct.VAT AS GROUPCODE,t.NGAYCHUNGTU AS NGAYCHUNGTU ';
P_TABLE_GROUPBY:= ' LEFT JOIN DM_LOAITHUE c ON a.GROUPCODE = c.MALOAITHUE AND c.UNITCODE = '''||P_UNITCODE||'''';
END;
ELSIF P_GROUPBY = 'MAKHO' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU,b.BARCODE, t.MAKHOXUAT,t.NGAYCHUNGTU';
P_SELECT_COLUMNS_OUT_GROUPBY:= ' a.MA AS MaCon, a.TEN AS TenCon,a.BARCODE AS BARCODE,c.MAKHO AS MaCha, c.TENKHO AS TenCha,a.NGAYCHUNGTU AS NgayGiaoDich ';
P_SELECT_COLUMNS_IN_GROUPBY:= 'b.MAVATTU AS MA, b.TENVATTU AS TEN,b.BARCODE AS BARCODE , t.MAKHOXUAT AS GROUPCODE,t.NGAYCHUNGTU AS NGAYCHUNGTU ';
P_TABLE_GROUPBY:= ' INNER JOIN DM_KHO c ON a.GROUPCODE = c.MAKHO AND c.UNITCODE = '''||P_UNITCODE||'''';
END;
ELSIF P_GROUPBY = 'MANHOMVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU,b.BARCODE,  b.MANHOMVATTU,t.NGAYCHUNGTU';
P_SELECT_COLUMNS_OUT_GROUPBY:= ' a.MA AS MaCon, a.TEN AS TenCon,a.BARCODE AS BARCODE,c.MANHOMVTU AS MaCha, c.TENNHOMVT AS TenCha,a.NGAYCHUNGTU AS NgayGiaoDich ';
P_SELECT_COLUMNS_IN_GROUPBY:= 'b.MAVATTU AS MA, b.TENVATTU AS TEN ,b.BARCODE AS BARCODE, b.MANHOMVATTU AS GROUPCODE,t.NGAYCHUNGTU AS NGAYCHUNGTU';
P_TABLE_GROUPBY:= ' INNER JOIN DM_NHOMVATTU c ON a.GROUPCODE = c.MANHOMVTU AND c.UNITCODE = '''||P_UNITCODE||'''';
END;
ELSIF P_GROUPBY = 'MALOAIVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU,b.BARCODE, b.MALOAIVATTU,t.NGAYCHUNGTU';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS MaCon, a.TEN AS TenCon,a.BARCODE AS BARCODE,c.MALOAIVATTU AS MaCha, c.TENLOAIVT AS TenCha,a.NGAYCHUNGTU AS NgayGiaoDich ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MAVATTU AS MA, b.TENVATTU AS TEN,b.BARCODE AS BARCODE, b.MALOAIVATTU AS GROUPCODE,t.NGAYCHUNGTU AS NGAYCHUNGTU ';
P_TABLE_GROUPBY:= ' INNER JOIN DM_LOAIVATTU c ON a.GROUPCODE = c.MALOAIVATTU AND c.UNITCODE = '''||P_UNITCODE||'''';
END;
ELSIF P_GROUPBY = 'MANHACUNGCAP' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU,b.BARCODE,  b.MAKHACHHANG,t.NGAYCHUNGTU';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS MaCon, a.TEN AS TenCon,a.BARCODE AS BARCODE, c.MANCC AS MaCha, c.TENNCC AS TenCha,a.NGAYCHUNGTU AS NgayGiaoDich ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MAVATTU AS MA, b.TENVATTU AS TEN,b.BARCODE AS BARCODE, b.MAKHACHHANG AS GROUPCODE,t.NGAYCHUNGTU';
P_TABLE_GROUPBY:= ' INNER JOIN DM_NHACUNGCAP c ON a.GROUPCODE = c.MANCC AND c.UNITCODE = '''||P_UNITCODE||'''';
END;
ELSIF P_GROUPBY = 'MAKHACHHANG' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU,b.BARCODE,t.MAKHACHHANG,t.NGAYCHUNGTU';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS MaCon, a.TEN AS TenCon,a.BARCODE AS BARCODE, c.MAKH AS MaCha, c.TENKH AS TenCha,a.NGAYCHUNGTU AS NgayGiaoDich ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MAVATTU AS MA, b.TENVATTU AS TEN,b.BARCODE AS BARCODE, t.MAKHACHHANG AS GROUPCODE,t.NGAYCHUNGTU';
P_TABLE_GROUPBY:= ' INNER JOIN DM_KHACHHANG c ON a.GROUPCODE = c.MAKH AND c.UNITCODE = '''||P_UNITCODE||'''';
END;
ELSIF P_GROUPBY = 'NGUOIDUNG' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU,b.BARCODE,t.I_CREATE_BY,t.NGAYCHUNGTU, t.UNITCODE';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS MaCon, a.TEN AS TenCon,a.BARCODE AS BARCODE, c.USERNAME AS MaCha, c.TENNHANVIEN AS TenCha,a.NGAYCHUNGTU AS NgayGiaoDich, a.UNITCODE AS MADONVIXUAT ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MAVATTU AS MA, b.TENVATTU AS TEN,b.BARCODE AS BARCODE, t.I_CREATE_BY AS GROUPCODE,t.NGAYCHUNGTU, t.UNITCODE';
P_TABLE_GROUPBY:= ' INNER JOIN AU_NGUOIDUNG c ON a.GROUPCODE = c.USERNAME AND c.UNITCODE = a.UNITCODE';
END;
ELSIF P_GROUPBY = 'MAGIAODICH' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU,b.BARCODE,t.MACHUNGTUPK,t.LOAICHUNGTU, t.NGAYCHUNGTU';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS MaCon, a.TEN AS TenCon,a.BARCODE AS BARCODE, a.MACHUNGTUPK AS MaCha, a.LOAICHUNGTU AS TenCha,a.NGAYCHUNGTU AS NgayGiaoDich ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MAVATTU AS MA, b.TENVATTU AS TEN,b.BARCODE AS BARCODE, t.MACHUNGTUPK AS MACHUNGTUPK,t.LOAICHUNGTU AS LOAICHUNGTU ,t.NGAYCHUNGTU';
P_TABLE_GROUPBY:= ' ';
END;
ELSE --ELSIF P_GROUPBY = 'MAVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU,b.BARCODE,t.NGAYCHUNGTU';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS MaCon, a.TEN AS TenCon,a.BARCODE AS BARCODE,  a.MA AS MaCha, a.TEN AS TenCha,a.NGAYCHUNGTU AS NgayGiaoDich';
P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MAVATTU AS MA, b.TENVATTU AS TEN ,b.BARCODE AS BARCODE,t.NGAYCHUNGTU';
P_TABLE_GROUPBY:= ' ';
END;
END IF;

  QUERY_STR:= 'select (a.SOLUONGBAN) as SOLUONGBAN,a.VON,a.VONCOVAT,a.TIENTHUE, a.DOANHTHU,(a.DOANHTHU + a.TIENTHUE) AS TONGBAN, (a.TIENCHIETKHAU) AS TIENCHIETKHAU,(a.DOANHTHU + a.TIENTHUE - a.VONCOVAT) AS LAIBANLE, 
  '||P_SELECT_COLUMNS_OUT_GROUPBY||'
  from (
  SELECT  '||P_SELECT_COLUMNS_IN_GROUPBY||'
                          ,SUM(NVL(ct.SOLUONG,0)) as SOLUONGBAN
                          ,SUM(NVL(ct.DONGIA  * ct.SOLUONG,0)) AS VON
                          ,SUM( NVL(ct.DONGIA * (1 + (g.TYGIA / 100)) * ct.SOLUONG,0) ) AS VONCOVAT
                          ,ROUND(SUM(CASE WHEN NVL(t.TIENCHIETKHAU,0) > 0 AND NVL(t.THANHTIENTRUOCVAT,0) > 0 THEN ct.THANHTIEN *(NVL(t.TIENCHIETKHAU,0) / t.THANHTIENTRUOCVAT) ELSE 0 END),2) as TIENCHIETKHAU
                          ,SUM(NVL(ct.SOLUONG,0) * NVL(ct.DONGIA,0)) as DOANHTHU 
                          ,SUM(NVL(ct.SOLUONG,0) * NVL(ct.DONGIA,0) * (NVL(g.TYGIA,0)/100 )) as TIENTHUE
                  from VATTUCHUNGTUCHITIET ct 
inner join VATTUCHUNGTU t on t.MACHUNGTUPK = ct.MACHUNGTUPK AND t.LOAICHUNGTU = ''XKHAC'' AND t.MALYDOKHAC = '''||P_PTHUCXUAT||'''
INNER JOIN DM_VATTU b on b.MAVATTU = ct.MAHANG AND b.UNITCODE = '''||P_UNITCODE||'''
LEFT JOIN DM_LOAITHUE g on g.MALOAITHUE = ct.VAT
WHERE
    t.TRANGTHAI = 10
    AND t.UNITCODE = '''||P_UNITCODE||'''
    AND t.NGAYDUYETPHIEU <=TO_DATE('''||P_DENNGAY||''',''DD/MM/YY'')
    AND t.NGAYDUYETPHIEU >=TO_DATE('''||P_TUNGAY||''',''DD/MM/YY'')
	'||P_EXPRESSION||'
	group by '||P_COLUMNS_GROUPBY||'
  order by t.NGAYCHUNGTU DESC) a
	  '||P_TABLE_GROUPBY;
 DBMS_OUTPUT.put_line (QUERY_STR );    
  OPEN cur FOR QUERY_STR;
  EXCEPTION
   WHEN NO_DATA_FOUND
   THEN
      DBMS_OUTPUT.put_line ('<your message>' || SQLERRM);
   WHEN OTHERS
   THEN
         DBMS_OUTPUT.put_line (QUERY_STR  || SQLERRM);     

  END BAOCAO_XKHAC_CHITIET;
--------------------------------------------------------
--  DDL for Procedure BAOCAO_XKHAC_CHITIET
--------------------------------------------------------
/
 create or replace PROCEDURE            "BAOCAO_XKHAC_TONGHOP" (P_GROUPBY IN VARCHAR2,P_PTHUCXUAT IN VARCHAR2, P_NGUOIDUNG IN VARCHAR2, P_UNITUSER IN VARCHAR2, P_TAX IN VARCHAR2, P_MAKHO IN VARCHAR2, P_MALOAI IN VARCHAR2,  P_MANHOM IN VARCHAR2,P_MAVATTU IN VARCHAR2, P_NHACUNGCAP IN VARCHAR2, P_MAKHACHHANG IN VARCHAR2, P_UNITCODE IN VARCHAR2, P_TUNGAY IN DATE, P_DENNGAY IN DATE, CUR  OUT SYS_REFCURSOR) IS
QUERY_STR VARCHAR(32767);
P_SELECT_COLUMNS_IN_GROUPBY VARCHAR(32767);
P_SELECT_COLUMNS_OUT_GROUPBY VARCHAR(32767);
P_TABLE_GROUPBY VARCHAR(32767);
P_COLUMNS_GROUPBY VARCHAR(32767);
P_EXPRESSION  VARCHAR(32767):= '';
BEGIN
IF TRIM(P_MAKHO) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND t.MAKHOXUAT IN ('||P_MAKHO||')';
END IF;
IF TRIM(P_MALOAI) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MALOAIVATTU IN ('||P_MALOAI||')';
END IF;
IF TRIM(P_NGUOIDUNG) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND t.I_CREATE_BY IN ('||P_NGUOIDUNG||')';
END IF;
IF TRIM(P_MANHOM) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MANHOMVATTU IN ('||P_MANHOM||')';
END IF;
IF TRIM(P_MAVATTU) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MAVATTU IN ('||P_MAVATTU||')';
END IF;    
IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
END IF;  
IF TRIM(P_MAKHACHHANG) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND t.MAKHACHHANG IN ('||P_MAKHACHHANG||')';
END IF;  
IF TRIM(P_UNITUSER) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND t.MADONVINHAN IN ('||P_UNITUSER||')';
END IF;  
IF TRIM(P_TAX) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND ct.VAT IN ('||P_TAX||')';
END IF;  
IF P_GROUPBY = 'MADONVIXUAT' THEN
BEGIN
P_COLUMNS_GROUPBY:= 't.UNITCODE';
P_SELECT_COLUMNS_OUT_GROUPBY:= ' c.MADONVI AS Ma, c.TENDONVI AS Ten,a.MA AS MADONVIXUAT ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' t.UNITCODE AS MA ';
P_TABLE_GROUPBY:= ' INNER JOIN AU_DONVI c ON a.MA = c.MADONVI';
END;
ELSIF P_GROUPBY = 'MADONVI' THEN
BEGIN
P_COLUMNS_GROUPBY:= 't.MADONVINHAN, t.UNITCODE';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'c.MADONVI AS Ma, c.TENDONVI AS Ten,a.UNITCODE AS MADONVIXUAT  ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' t.MADONVINHAN AS MA,t.UNITCODE ';
P_TABLE_GROUPBY:= ' INNER JOIN AU_DONVI c ON a.MA = c.MADONVI';
END;
ELSIF P_GROUPBY = 'MALOAITHUE' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'ct.VAT, t.UNITCODE';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'c.MALOAITHUE AS Ma, c.LOAITHUE AS Ten,a.UNITCODE AS MADONVIXUAT  ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' ct.VAT AS MA, t.UNITCODE ';
P_TABLE_GROUPBY:= ' LEFT JOIN DM_LOAITHUE c ON a.MA = c.MALOAITHUE';
END;
ELSIF P_GROUPBY = 'MAKHO' THEN
BEGIN
P_COLUMNS_GROUPBY:= 't.MAKHOXUAT, t.UNITCODE';
P_SELECT_COLUMNS_OUT_GROUPBY:= ' c.MAKHO AS Ma, c.TENKHO AS Ten,a.UNITCODE AS MADONVIXUAT ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' t.MAKHOXUAT AS MA, t.UNITCODE ';
P_TABLE_GROUPBY:= ' INNER JOIN DM_KHO c ON a.MA = c.MAKHO AND c.UNITCODE = a.UNITCODE';
END;
ELSIF P_GROUPBY = 'MANHOMVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MANHOMVATTU, t.UNITCODE';
P_SELECT_COLUMNS_OUT_GROUPBY:= ' c.MANHOMVTU AS Ma, c.TENNHOMVT AS Ten,a.UNITCODE AS MADONVIXUAT  ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MANHOMVATTU AS MA, t.UNITCODE ';
P_TABLE_GROUPBY:= ' INNER JOIN DM_NHOMVATTU c ON a.MA = c.MANHOMVTU AND c.UNITCODE = a.UNITCODE';
END;
ELSIF P_GROUPBY = 'MALOAIVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MALOAIVATTU, t.UNITCODE';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'c.MALOAIVATTU AS Ma, c.TENLOAIVT AS Ten,a.UNITCODE AS MADONVIXUAT  ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MALOAIVATTU as MA, t.UNITCODE ';
P_TABLE_GROUPBY:= ' INNER JOIN DM_LOAIVATTU c ON a.MA = c.MALOAIVATTU AND c.UNITCODE = a.UNITCODE';
END;
ELSIF P_GROUPBY = 'MANHACUNGCAP' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAKHACHHANG, t.UNITCODE';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'c.MANCC AS Ma, c.TENNCC AS Ten,a.UNITCODE AS MADONVIXUAT  ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MAKHACHHANG AS MA, t.UNITCODE ';
P_TABLE_GROUPBY:= ' INNER JOIN DM_NHACUNGCAP c ON a.MA = c.MANCC AND c.UNITCODE = a.UNITCODE';
END;
ELSIF P_GROUPBY = 'MAKHACHHANG' THEN
BEGIN
P_COLUMNS_GROUPBY:= 't.MAKHACHHANG, t.UNITCODE';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'c.MAKH AS Ma, c.TENKH AS Ten,a.UNITCODE AS MADONVIXUAT  ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' t.MAKHACHHANG AS MA , t.UNITCODE ';
P_TABLE_GROUPBY:= ' INNER JOIN DM_KHACHHANG c ON a.MA = c.MAKH AND c.UNITCODE = a.UNITCODE';
END;
ELSIF P_GROUPBY = 'NGUOIDUNG' THEN
BEGIN
P_COLUMNS_GROUPBY:= 't.I_CREATE_BY, t.UNITCODE';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'c.USERNAME AS Ma, c.TENNHANVIEN AS Ten,a.UNITCODE AS MADONVIXUAT  ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' t.I_CREATE_BY AS MA , t.UNITCODE ';
P_TABLE_GROUPBY:= ' INNER JOIN AU_NGUOIDUNG c ON a.MA = c.USERNAME AND c.UNITCODE = a.UNITCODE';
END;
ELSIF P_GROUPBY = 'MAGIAODICH' THEN
BEGIN
P_COLUMNS_GROUPBY:= 't.MACHUNGTUPK, t.UNITCODE';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS Ma, a.MA AS Ten,a.UNITCODE AS MADONVIXUAT  ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' t.MACHUNGTUPK AS MA , t.UNITCODE ';
P_TABLE_GROUPBY:= ' ';
END;
ELSE --ELSIF P_GROUPBY = 'MAVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU,b.TENVATTU, t.UNITCODE ';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS Ma, a.TEN AS Ten,a.UNITCODE AS MADONVIXUAT  ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MAVATTU AS MA, b.TENVATTU AS TEN, t.UNITCODE ';
P_TABLE_GROUPBY:= '  ';
END;
END IF;

QUERY_STR := 'SELECT (a.SOLUONGBAN) AS SOLUONGBAN,(a.VON) AS VON,(a.VONCOVAT) AS VONCOVAT,(a.TIENTHUE) AS TIENTHUE,
            (a.DOANHTHU) AS DOANHTHU,(a.DOANHTHU + a.TIENTHUE) AS TONGBAN, (a.TIENCHIETKHAU) AS TIENCHIETKHAU,(a.DOANHTHU + a.TIENTHUE - a.VONCOVAT) AS LAIBANLE, 
'||P_SELECT_COLUMNS_OUT_GROUPBY||'
from (
SELECT  '||P_SELECT_COLUMNS_IN_GROUPBY||'
                          ,SUM(NVL(ct.SOLUONG,0)) AS SOLUONGBAN
                          ,SUM(NVL(ct.DONGIA*ct.SOLUONG,0)) AS VON
                          ,SUM( NVL(ct.DONGIA * (1 + (g.TYGIA / 100)) * ct.SOLUONG,0) ) AS VONCOVAT
                          ,ROUND(SUM(CASE WHEN NVL(t.TIENCHIETKHAU,0) > 0 AND NVL(t.THANHTIENTRUOCVAT,0) > 0 THEN ct.THANHTIEN *(NVL(t.TIENCHIETKHAU,0) / t.THANHTIENTRUOCVAT) ELSE 0 END),2) AS TIENCHIETKHAU
                          ,SUM(NVL(ct.SOLUONG,0) * NVL(ct.DONGIA,0)) AS DOANHTHU 
                          ,SUM(NVL(ct.SOLUONG,0) * NVL(ct.DONGIA,0) * (NVL(g.TYGIA,0)/100)) AS TIENTHUE
FROM VATTUCHUNGTUCHITIET ct 
INNER JOIN VATTUCHUNGTU t ON t.MACHUNGTUPK = ct.MACHUNGTUPK AND t.LOAICHUNGTU = ''XKHAC'' AND t.MALYDOKHAC = '''||P_PTHUCXUAT||'''
INNER JOIN V_VATTU_GIABAN b ON b.MAVATTU = ct.MAHANG AND b.MADONVI= t.UNITCODE
LEFT JOIN DM_LOAITHUE g ON g.MALOAITHUE = ct.VAT
WHERE
    t.TRANGTHAI = 10
    AND t.UNITCODE = '''||P_UNITCODE||'''
    AND TO_DATE(t.NGAYDUYETPHIEU,''DD/MM/YY'') <= TO_DATE('''||P_DENNGAY||''',''DD/MM/YY'')
    AND TO_DATE(t.NGAYDUYETPHIEU,''DD/MM/YY'') >= TO_DATE('''||P_TUNGAY||''',''DD/MM/YY'')
	'||P_EXPRESSION||'
	GROUP BY  '||P_COLUMNS_GROUPBY||') a
 '||P_TABLE_GROUPBY;
BEGIN
DBMS_OUTPUT.put_line (QUERY_STR);
OPEN CUR FOR QUERY_STR;
EXCEPTION
            WHEN NO_DATA_FOUND THEN
             NULL;
               WHEN OTHERS THEN
      NULL;
END;
END BAOCAO_XKHAC_TONGHOP;
--------------------------------------------------------
--  DDL for Procedure BAOCAO_XKHAC_TONGHOP
--------------------------------------------------------
 /
 create or replace PROCEDURE  "NHAPBANBUONTRALAITONGHOP" (P_LOAICHUNGTU IN VARCHAR2,P_GROUPBY IN VARCHAR2, P_WAREHOUSE IN VARCHAR2, 
P_MALOAI IN VARCHAR2,  P_MANHOM IN VARCHAR2,P_MAVATTU IN VARCHAR2, P_NGUOIDUNG IN VARCHAR2,
P_NHACUNGCAP IN VARCHAR2,P_UNITCODE  IN VARCHAR2, P_MATHUE  IN VARCHAR2,
P_TUNGAY IN DATE,P_DENNGAY IN DATE, cur  OUT SYS_REFCURSOR) AS

P_EXPRESSION VARCHAR(3232);
QUERY_STR VARCHAR(32767);
P_TABLE_GROUPBY VARCHAR(32767);
P_COLUMNS_GROUPBY VARCHAR(32767);
P_SELECT_COLUMNS_GROUPBY VARCHAR(32767);
P_SELECT VARCHAR(3232);
P_SELECT2 VARCHAR(3232);

BEGIN
IF TRIM(P_UNITCODE) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND t.UNITCODE = '''||P_UNITCODE||''' ';
END IF;
IF TRIM(P_MALOAI) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MALOAIVATTU IN ('||P_MALOAI||')';
END IF;
IF TRIM(P_NGUOIDUNG) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND t.I_CREATE_BY IN ('||P_NGUOIDUNG||')';
END IF;
IF TRIM(P_MANHOM) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MANHOMVATTU IN ('||P_MANHOM||')';
END IF;
IF TRIM(P_MAVATTU) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND ct.MAHANG IN ('||P_MAVATTU||')';
END IF;    
IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
END IF;
IF TRIM(P_MATHUE) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND ct.VAT IN ('||P_MATHUE||')';
END IF; 

IF P_GROUPBY = 'MAKHO' THEN
BEGIN
P_COLUMNS_GROUPBY:= 't.MAKHONHAP, c.TENKHO';
P_SELECT_COLUMNS_GROUPBY:= ' a.MAKHO AS MaCha, a.TENKHO AS TenCha ';
P_TABLE_GROUPBY:= ' INNER JOIN DM_KHO c ON t.MAKHONHAP = c.MAKHO AND c.UNITCODE = '''||P_UNITCODE||'''';
P_SELECT2:='t.MAKHONHAP AS MAKHO,c.TENKHO AS TENKHO';
P_SELECT:= ' ';
END;
ELSIF P_GROUPBY = 'MADONVI' THEN
BEGIN
P_COLUMNS_GROUPBY:= 't.UNITCODE, c.TENDONVI';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MADONVI, ''NULL'')  as MaCha, NVL(a.TENDONVI, ''NULL'') as TenCha ';
P_TABLE_GROUPBY:= ' INNER JOIN AU_DONVI c ON t.UNITCODE = c.MADONVI AND c.UNITCODE = '''||P_UNITCODE||'''';
P_SELECT2:='t.UNITCODE AS MADONVI,c.TENDONVI AS TENDONVI';
P_SELECT:= ' ';
END;
ELSIF P_GROUPBY = 'MANHOMVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MANHOMVATTU,kh.TENNHOMVT';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MANHOMVATTU, ''NULL'')  as MaCha, NVL(a.TENNHOMVT, ''NULL'') as TenCha ';
P_TABLE_GROUPBY:= ' INNER JOIN DM_NHOMVATTU kh on b.MANHOMVATTU = kh.MANHOMVTU AND kh.UNITCODE = '''||P_UNITCODE||'''';
P_SELECT2:='b.MANHOMVATTU AS MANHOMVATTU,kh.TENNHOMVT as TENNHOMVT';
P_SELECT:= ' ';
END;
ELSIF P_GROUPBY = 'MALOAIVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MALOAIVATTU,kh.TENLOAIVT';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MALOAIVATTU, ''NULL'')  as MaCha, NVL(a.TENLOAIVT, ''NULL'') as TenCha ';
P_TABLE_GROUPBY:= ' INNER JOIN DM_LOAIVATTU kh ON b.MALOAIVATTU = kh.MALOAIVATTU AND kh.UNITCODE = '''||P_UNITCODE||'''';
P_SELECT2:=' b.MALOAIVATTU AS MALOAIVATTU,kh.TENLOAIVT as TENLOAIVT';

P_SELECT:= ' ';

END;
ELSIF P_GROUPBY = 'MAKHACHHANG' THEN
BEGIN
P_COLUMNS_GROUPBY:= 't.MAKHACHHANG , kh.TENKH';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MAKHACHHANG, ''NULL'')  as MaCha, NVL(a.TENKH, ''NULL'') as TenCha ';
P_TABLE_GROUPBY:= ' INNER JOIN DM_KHACHHANG kh on t.MAKHACHHANG = kh.MAKH AND kh.LOAIKHACHHANG =1 AND kh.UNITCODE = '''||P_UNITCODE||'''';
P_SELECT2:=' t.MAKHACHHANG AS MAKHACHHANG,kh.TENKH as TENKH';
P_SELECT:= ' ';
END;
ELSIF P_GROUPBY = 'NGUOIDUNG' THEN
BEGIN
P_COLUMNS_GROUPBY:= 't.I_CREATE_BY , kh.TENNHANVIEN';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.USERNAME, ''NULL'')  as MaCha, NVL(a.TENNHANVIEN, ''NULL'') as TenCha ';
P_TABLE_GROUPBY:= ' INNER JOIN AU_NGUOIDUNG kh on t.I_CREATE_BY = kh.USERNAME AND kh.UNITCODE = '''||P_UNITCODE||'''';
P_SELECT2:=' t.I_CREATE_BY AS USERNAME,kh.TENNHANVIEN as TENNHANVIEN';
P_SELECT:= ' ';
END;
ELSIF P_GROUPBY ='MALOAITHUE' THEN
BEGIN
P_COLUMNS_GROUPBY:= ' lt.MALOAITHUE ,lt.LOAITHUE';
P_SELECT_COLUMNS_GROUPBY:= 'a.MaCha , a.TenCha';
P_TABLE_GROUPBY:= ' ';
P_SELECT2:='lt.MALOAITHUE as MaCha , lt.LOAITHUE as TenCha';
P_SELECT:= '';
END;
ELSIF P_GROUPBY ='MANHACUNGCAP' THEN
BEGIN
P_COLUMNS_GROUPBY:= ' ncc.MANCC ,ncc.TENNCC';
P_SELECT_COLUMNS_GROUPBY:= 'a.MaCha , a.TenCha';
P_TABLE_GROUPBY:= 'INNER JOIN DM_NHACUNGCAP ncc on ncc.MANCC = b.MAKHACHHANG AND b.UNITCODE = '''||P_UNITCODE||''' ';
P_SELECT2:='ncc.MANCC as MaCha , ncc.TENNCC as TenCha';
P_SELECT:= '';
END;
ELSIF P_GROUPBY ='PHIEU' THEN
BEGIN
P_COLUMNS_GROUPBY:= ' t.MACHUNGTU, t.MACHUNGTUPK';
P_SELECT_COLUMNS_GROUPBY:= 'a.MaCha , a.TenCha';
P_SELECT2:='t.MACHUNGTU as MaCha , t.MACHUNGTUPK as TenCha';
P_SELECT:= '';
END;
ELSE --ELSIF P_GROUPBY = 'MAVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU,b.TENVATTU,b.GIABANBUON,b.GiaBanLeVat';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MAVATTU, ''NULL'')  as MaCha, NVL(a.TENVATTU, ''NULL'') as TenCha,a.MAVATTU as MaCon,a.TENVATTU as TenCon ';
P_TABLE_GROUPBY:= ' AND b.UNITCODE = '''||P_UNITCODE||''' ';
P_SELECT2:=' b.MAVATTU as MAVATTU,b.TENVATTU as TENVATTU';
P_SELECT:= 'b.GIABANBUON as DONGIANHAP,b.GiaBanLeVat as GiaBanLeVat ,';
END;
END IF;
QUERY_STR:= 'SELECT (a.SOLUONG) as SoLuong, (a.TIENHANG) as TienHang, (a.TIENVAT) as TienVat, (a.TIENCHIETKHAU) as TienChietKhau, (a.TIENHANG - a.TIENCHIETKHAU + a.TIENVAT) AS TongTien ,'||P_SELECT_COLUMNS_GROUPBY||'
FROM (
SELECT   '||P_SELECT2||',
          SUM(ct.SOLUONG) AS SOLUONG, 
          SUM(ct.SOLUONG*ROUND(NVL(ct.DONGIA,0),2)) AS TIENHANG ,
          '||P_SELECT||' 
          SUM(ROUND(NVL(ct.DONGIA,0),2) * NVL(lt.TYGIA/100,0) * ct.SOLUONG) AS TIENVAT, 
          SUM(CASE WHEN NVL(t.TIENCHIETKHAU,0) > 0 AND NVL(t.THANHTIENTRUOCVAT,0) > 0 THEN ct.THANHTIEN *(NVL(t.TIENCHIETKHAU,0)/t.THANHTIENTRUOCVAT) ELSE 0 END) AS TIENCHIETKHAU
FROM VATTUCHUNGTUCHITIET ct 
INNER JOIN VATTUCHUNGTU t on t.MACHUNGTUPK = ct.MACHUNGTUPK 
LEFT JOIN DM_LOAITHUE lt on lt.MALOAITHUE = ct.VAT
INNER JOIN V_VATTU_GIABAN b on b.MAVATTU = ct.MAHANG AND b.UNITCODE = '''||P_UNITCODE||'''
'||P_TABLE_GROUPBY||'
WHERE
    t.TRANGTHAI = 10
    AND t.UNITCODE = '''||P_UNITCODE||'''
    AND TO_DATE(t.NGAYCHUNGTU,''DD/MM/YY'') <= TO_DATE('''||P_DENNGAY||''',''DD/MM/YY'')
    AND TO_DATE(t.NGAYCHUNGTU,''DD/MM/YY'') >= TO_DATE('''||P_TUNGAY||''',''DD/MM/YY'') 
    AND t.UNITCODE = '''||P_UNITCODE||''' 
    AND t.LOAICHUNGTU ='''||P_LOAICHUNGTU||''' '||P_EXPRESSION||' GROUP BY '||P_COLUMNS_GROUPBY||') a';
OPEN CUR FOR QUERY_STR;
  EXCEPTION
   WHEN NO_DATA_FOUND
   THEN
      DBMS_OUTPUT.put_line ('<your message>' || SQLERRM);
   WHEN OTHERS
   THEN
         DBMS_OUTPUT.put_line (QUERY_STR  || SQLERRM);     
END NHAPBANBUONTRALAITONGHOP;
--------------------------------------------------------
--  DDL for Procedure NHAPBANBUONTRALAITONGHOP
--------------------------------------------------------
 /
 create or replace PROCEDURE NHAPBANBUONTRALAICHITIET(P_TABLE_NAME IN VARCHAR2,P_LOAICHUNGTU IN VARCHAR2, 
P_GROUPBY IN VARCHAR2,P_WAREHOUSE IN VARCHAR2, P_MALOAI IN VARCHAR2,  P_MANHOM IN VARCHAR2, P_NGUOIDUNG IN VARCHAR2,
P_MAVATTU IN VARCHAR2,P_NHACUNGCAP IN VARCHAR2,P_UNITCODE  IN VARCHAR2, P_MATHUE  IN VARCHAR2,
P_TUNGAY IN DATE,P_DENNGAY IN DATE, cur  OUT SYS_REFCURSOR) AS

P_EXPRESSION VARCHAR(3000);
QUERY_STR VARCHAR(3000);
P_TABLE_GROUPBY VARCHAR(3000);
P_COLUMNS_GROUPBY VARCHAR(3000);
P_SELECT_COLUMNS_GROUPBY VARCHAR(3000);
P_SELECT VARCHAR(3000);
BEGIN
IF TRIM(P_MALOAI) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MALOAIVATTU IN ('||P_MALOAI||')';
END IF;
IF TRIM(P_MANHOM) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MANHOMVATTU IN ('||P_MANHOM||')';
END IF;
IF TRIM(P_MAVATTU) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND ct.MAHANG IN ('||P_MAVATTU||')';
END IF;    
IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
END IF;
IF TRIM(P_MATHUE) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND ct.VAT IN ('||P_MATHUE||')';
END IF;  

IF P_GROUPBY = 'MAKHO' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'c.MAKHO,c.TENKHO,b.MAVATTU,b.TENVATTU,ct.DONGIA,b.GiaBanLeVat,t.NGAYCHUNGTU ';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MAKHO, ''NULL'')  as MaCha, NVL(a.TENKHO, ''NULL'') as TenCha,a.MAVATTU as MaCon,a.TENVATTU as TenCon,a.NGAYCHUNGTU as NGAYCHUNGTU ';
P_TABLE_GROUPBY:= ' INNER JOIN DM_KHO c ON t.MAKHONHAP = c.MAKHO AND c.UNITCODE = '''||P_UNITCODE||'''';
P_SELECT:='t.NGAYCHUNGTU as NGAYCHUNGTU, c.MAKHO AS MAKHO,c.TENKHO as TENKHO,b.MAVATTU as MAVATTU,b.TENVATTU as TENVATTU';
END;
ELSIF P_GROUPBY = 'MADONVI' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MADONVI,dv.TENDONVI,b.MAVATTU,b.TENVATTU,t.NGAYCHUNGTU, ct.DONGIA, b.GiaBanLeVat ';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MADONVI, ''NULL'')  as MaCha, NVL(a.TENDONVI, ''NULL'') as TenCha,a.MAVATTU as MaCon,a.TENVATTU as TenCon,a.NGAYCHUNGTU as NGAYCHUNGTU ';
P_TABLE_GROUPBY:= ' INNER JOIN AU_DONVI dv on b.MADONVI = dv.MADONVI AND dv.MADONVI = '''||P_UNITCODE||'''';
P_SELECT:='t.NGAYCHUNGTU as NGAYCHUNGTU, b.MADONVI AS MADONVI,dv.TENDONVI as TENDONVI,b.MAVATTU as MAVATTU,b.TENVATTU as TENVATTU';
END;
ELSIF P_GROUPBY = 'MANHOMVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MANHOMVATTU,kh.TENNHOMVT,b.MAVATTU,b.TENVATTU,ct.DONGIA,b.GiaBanLeVat,t.NGAYCHUNGTU ';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MANHOMVATTU, ''NULL'')  as MaCha, NVL(a.TENNHOMVT, ''NULL'') as TenCha,a.MAVATTU as MaCon,a.TENVATTU as TenCon,a.NGAYCHUNGTU as NGAYCHUNGTU ';
P_TABLE_GROUPBY:= ' INNER JOIN DM_NHOMVATTU kh on b.MANHOMVATTU = kh.MANHOMVTU AND kh.UNITCODE = '''||P_UNITCODE||'''';
P_SELECT:='t.NGAYCHUNGTU as NGAYCHUNGTU, b.MANHOMVATTU AS MANHOMVATTU,kh.TENNHOMVT as TENNHOMVT,b.MAVATTU as MAVATTU,b.TENVATTU as TENVATTU';
END;
ELSIF P_GROUPBY = 'MALOAIVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MALOAIVATTU,kh.TENLOAIVT,b.MAVATTU,b.TENVATTU,ct.DONGIA,b.GiaBanLeVat,t.NGAYCHUNGTU ';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MALOAIVATTU, ''NULL'')  as MaCha, NVL(a.TENLOAIVT, ''NULL'') as TenCha,a.MAVATTU as MaCon,a.TENVATTU as TenCon,a.NGAYCHUNGTU as NgayChungTu ';
P_TABLE_GROUPBY:= ' INNER JOIN DM_LOAIVATTU kh ON b.MALOAIVATTU = kh.MALOAIVATTU AND kh.UNITCODE = '''||P_UNITCODE||'''';
P_SELECT:=' t.NGAYCHUNGTU as NGAYCHUNGTU,b.MALOAIVATTU AS MALOAIVATTU,kh.TENLOAIVT as TENLOAIVT,b.MAVATTU as MAVATTU,b.TENVATTU as TENVATTU';
END;
ELSIF P_GROUPBY = 'MANHACUNGCAP' THEN
BEGIN
P_COLUMNS_GROUPBY:= 't.MAKHACHHANG,ncc.TENNCC,b.MAVATTU,b.TENVATTU,ct.DONGIA,b.GiaBanLeVat,t.NGAYCHUNGTU ';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MAKHACHHANG, ''NULL'')  as MaCha, NVL(a.TENNCC, ''NULL'') as TenCha,a.MAVATTU as MaCon,a.TENVATTU as TenCon,a.NGAYCHUNGTU as NgayChungTu ';
P_TABLE_GROUPBY:= ' INNER JOIN DM_NHACUNGCAP ncc on t.MAKHACHHANG = ncc.MANCC AND ncc.UNITCODE = '''||P_UNITCODE||'''';
P_SELECT:=' t.NGAYCHUNGTU as NGAYCHUNGTU ,t.MAKHACHHANG AS MAKHACHHANG,ncc.TENNCC as TENNCC,b.MAVATTU as MAVATTU,b.TENVATTU as TENVATTU';
END;
ELSIF P_GROUPBY = 'NGUOIDUNG' THEN
BEGIN
P_COLUMNS_GROUPBY:= 't.I_CREATE_BY,ncc.TENNHANVIEN,b.MAVATTU,b.TENVATTU,ct.DONGIA,b.GiaBanLeVat,t.NGAYCHUNGTU ';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.USERNAME, ''NULL'')  as MaCha, NVL(a.TENNHANVIEN, ''NULL'') as TenCha,a.MAVATTU as MaCon,a.TENVATTU as TenCon,a.NGAYCHUNGTU as NgayChungTu ';
P_TABLE_GROUPBY:= ' INNER JOIN AU_NGUOIDUNG ncc on t.I_CREATE_BY = ncc.USERNAME AND ncc.UNITCODE = '''||P_UNITCODE||'''';
P_SELECT:=' t.NGAYCHUNGTU as NGAYCHUNGTU ,t.I_CREATE_BY AS USERNAME,ncc.TENNHANVIEN as TENNHANVIEN,b.MAVATTU as MAVATTU,b.TENVATTU as TENVATTU';
END;
ELSIF P_GROUPBY = 'MALOAITHUE' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'ct.VAT,lt.LOAITHUE,b.MAVATTU,b.TENVATTU,ct.DONGIA,b.GiaBanLeVat,t.NGAYCHUNGTU ';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MALOAITHUE, ''NULL'')  as MaCha, NVL(a.LOAITHUE, ''NULL'') as TenCha,a.MAVATTU as MaCon,a.TENVATTU as TenCon,a.NGAYCHUNGTU as NgayChungTu ';
P_TABLE_GROUPBY:= ' ';
P_SELECT:=' t.NGAYCHUNGTU as NGAYCHUNGTU ,ct.VAT AS MALOAITHUE,lt.LOAITHUE as LOAITHUE,b.MAVATTU as MAVATTU,b.TENVATTU as TENVATTU';
END;
ELSIF P_GROUPBY = 'PHIEU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 't.MACHUNGTU,t.MACHUNGTUPK,b.MAVATTU,b.TENVATTU,ct.DONGIA,b.GiaBanLeVat,t.NGAYCHUNGTU ';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MACHUNGTU, ''NULL'')  as MaCha, NVL(a.MACHUNGTUPK, ''NULL'') as TenCha,a.MAVATTU as MaCon,a.TENVATTU as TenCon,a.NGAYCHUNGTU as NgayChungTu ';
P_SELECT:=' t.NGAYCHUNGTU as NGAYCHUNGTU ,t.MACHUNGTU AS MACHUNGTU,t.MACHUNGTUPK as MACHUNGTUPK,b.MAVATTU as MAVATTU,b.TENVATTU as TENVATTU';
END;
ELSE --ELSIF P_GROUPBY = 'MAVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU,b.TENVATTU,ct.DONGIA,b.GiaBanLeVat,t.NGAYCHUNGTU';
P_SELECT_COLUMNS_GROUPBY:= ' NVL(a.MAVATTU, ''NULL'')  as MaCha, NVL(a.TENVATTU, ''NULL'') as TenCha,a.MAVATTU as MaCon,a.TENVATTU as TenCon,a.NGAYCHUNGTU AS NgayChungTu ';
P_TABLE_GROUPBY:= ' AND b.UNITCODE = '''||P_UNITCODE||''' ';
P_SELECT:=' t.NGAYCHUNGTU as NGAYCHUNGTU,b.MAVATTU as MAVATTU,b.TENVATTU as TENVATTU';
END;
END IF;
QUERY_STR:= 'SELECT (a.SOLUONG) AS SoLuong,(a.VON) AS VON ,(a.VON) AS VON,(a.DONGIANHAP) AS DonGiaNhap,a.GiaBanLeVat AS GiaBan, (a.TIENHANG) AS TienHang, (a.TIENVAT) AS TienVat, (a.TIENCHIETKHAU) AS TienChietKhau, (a.TIENHANG - a.TIENCHIETKHAU + a.TIENVAT) AS TongTien ,'||P_SELECT_COLUMNS_GROUPBY||'
FROM (
SELECT '||P_SELECT||',SUM(ct.SOLUONG) AS SOLUONG,
         SUM(ct.SOLUONG*ROUND(NVL(ct.DONGIA,0))) AS TIENHANG ,
         ROUND(SUM(ROUND(NVL(ct.DONGIA,0),2) * NVL(lt.TYGIA/100,0)*ct.SOLUONG)) AS TIENVAT,
         0 AS TIENCHIETKHAU,
         ROUND(NVL(ct.DONGIA,0),2) AS DONGIANHAP,
         ROUND(NVL(b.GiaBanLeVat,0),2) AS GiaBanLeVat,
         ROUND(SUM(NVL(ct.GIAVON,0) * NVL(ct.SOLUONG,0)),2) AS VON
    FROM VATTUCHUNGTUCHITIET ct 
    INNER JOIN VATTUCHUNGTU t ON t.MACHUNGTUPK = ct.MACHUNGTUPK 
    INNER JOIN V_VATTU_GIABAN b ON b.MAVATTU = ct.MAHANG
    LEFT JOIN DM_LOAITHUE lt ON lt.MALOAITHUE = ct.VAT
    '||P_TABLE_GROUPBY||'
    WHERE
    t.TRANGTHAI = 10
    AND t.UNITCODE = '''||P_UNITCODE||'''
    AND TO_DATE(t.NGAYCHUNGTU,''DD/MM/YY'') <= TO_DATE('''||P_DENNGAY||''',''DD/MM/YY'')
    AND TO_DATE(t.NGAYCHUNGTU,''DD/MM/YY'') >= TO_DATE('''||P_TUNGAY||''',''DD/MM/YY'') 
    AND t.UNITCODE = '''||P_UNITCODE||''' 
    AND t.LOAICHUNGTU = '''||P_LOAICHUNGTU||''' '||P_EXPRESSION||' 
    GROUP BY '||P_COLUMNS_GROUPBY||' ORDER BY '||P_COLUMNS_GROUPBY||' ) a';
OPEN CUR FOR QUERY_STR;
DBMS_OUTPUT.put_line (QUERY_STR);
  EXCEPTION
   WHEN NO_DATA_FOUND
   THEN
      DBMS_OUTPUT.put_line ('<your message>' || SQLERRM);
   WHEN OTHERS
   THEN
         DBMS_OUTPUT.put_line (QUERY_STR  || SQLERRM);     
END NHAPBANBUONTRALAICHITIET;
 /
create or replace PROCEDURE "BAOCAO_TONKHO_CHITIET" (P_TABLE_NAME IN VARCHAR2,P_DKIENLOC IN VARCHAR2,P_GROUPBY IN VARCHAR2, P_MAKHO IN VARCHAR2, P_MALOAI IN VARCHAR2,  P_MANHOM IN VARCHAR2,P_MAVATTU IN VARCHAR2, P_NHACUNGCAP IN VARCHAR2, P_UNITCODE IN VARCHAR2,P_SELECTEDVAT IN VARCHAR2,CUR  OUT SYS_REFCURSOR) AS
QUERY_STR VARCHAR(5000);
P_SELECT_COLUMNS_IN_GROUPBY VARCHAR(2000);
P_SELECT_COLUMNS_OUT_GROUPBY VARCHAR(2000);
P_TABLE_GROUPBY VARCHAR(2000);
P_COLUMNS_GROUPBY VARCHAR(2000);
P_EXPRESSION  VARCHAR(1000):= '';
P_NOTNULL VARCHAR(1000);
BEGIN
IF P_DKIENLOC = 'POSITIVE' THEN 
P_EXPRESSION := P_EXPRESSION||' AND NVL(t.TONCUOIKYSL,0) > 0 ';
END IF;
IF P_DKIENLOC = 'NEGATIVE' THEN 
P_EXPRESSION := P_EXPRESSION||' AND NVL(t.TONCUOIKYSL,0) < 0 ';
END IF;
IF P_DKIENLOC = 'ZERO' THEN 
P_EXPRESSION := P_EXPRESSION||' AND NVL(t.TONCUOIKYSL,0) = 0 ';
END IF;
--  
IF TRIM(P_MAKHO) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND t.MAKHO IN ('||P_MAKHO||')';
END IF;
IF TRIM(P_MALOAI) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MALOAIVATTU IN ('||P_MALOAI||')';
END IF;
IF TRIM(P_MANHOM) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MANHOMVATTU IN ('||P_MANHOM||')';
END IF;
IF TRIM(P_MAVATTU) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MAVATTU IN ('||P_MAVATTU||')';
END IF;    
IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
P_EXPRESSION := P_EXPRESSION||' AND b.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
END IF;  
--

IF P_GROUPBY = 'MADONVI' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU, b.BARCODE, t.UNITCODE, t.GIAVON, vtgc.gia_banle_vat, vtgc.giamuavat,t.MAKHO';
P_SELECT_COLUMNS_OUT_GROUPBY:= ' a.MA AS MaCon, a.TEN AS TenCon,a.BARCODE AS BARCODE, c.MADONVI AS MaCha, c.TENDONVI AS TenCha,a.MAKHO, a.MA AS MADONVI, a.gia_banle_vat, a.giamuavat  ';
P_SELECT_COLUMNS_IN_GROUPBY:= 'b.MAVATTU AS MA, b.TENVATTU AS TEN ,b.BARCODE AS BARCODE,t.MAKHO, t.UNITCODE AS GROUPCODE, vtgc.gia_banle_vat, vtgc.giamuavat ';
P_TABLE_GROUPBY:= ' INNER JOIN AU_DONVI c ON a.GROUPCODE = c.MADONVI';
P_NOTNULL := ' AND t.UNITCODE IS NOT NULL ';
END;
ELSIF P_GROUPBY = 'MAKHO' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU,b.BARCODE, t.MAKHO, t.UNITCODE, t.GIAVON, vtgc.gia_banle_vat, vtgc.giamuavat';
P_SELECT_COLUMNS_OUT_GROUPBY:= ' a.MA AS MaCon, a.TEN AS TenCon,a.BARCODE AS BARCODE,c.MAKHO AS MaCha,c.MAKHO AS MAKHO, c.TENKHO AS TenCha, a.UNITCODE AS MADONVI, a.gia_banle_vat, a.giamuavat ';
P_SELECT_COLUMNS_IN_GROUPBY:= 'b.MAVATTU AS MA, b.TENVATTU AS TEN,b.BARCODE AS BARCODE , t.MAKHO AS GROUPCODE, t.UNITCODE, vtgc.gia_banle_vat, vtgc.giamuavat';
P_TABLE_GROUPBY:= ' INNER JOIN DM_KHO c ON a.GROUPCODE = c.MAKHO AND c.UNITCODE = a.UNITCODE';
P_NOTNULL := ' AND t.MAKHO IS NOT NULL ';
END;
ELSIF P_GROUPBY = 'MANHOMVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU,b.BARCODE,  b.MANHOMVATTU, t.UNITCODE, t.GIAVON, vtgc.gia_banle_vat, vtgc.giamuavat,t.MAKHO';
P_SELECT_COLUMNS_OUT_GROUPBY:= ' a.MA AS MaCon, a.TEN AS TenCon,a.BARCODE AS BARCODE,c.MANHOMVTU AS MaCha, c.TENNHOMVT AS TenCha,a.MAKHO, a.UNITCODE AS MADONVI, a.gia_banle_vat, a.giamuavat ';
P_SELECT_COLUMNS_IN_GROUPBY:= 'b.MAVATTU AS MA, b.TENVATTU AS TEN ,b.BARCODE AS BARCODE,t.MAKHO, b.MANHOMVATTU AS GROUPCODE, t.UNITCODE, vtgc.gia_banle_vat, vtgc.giamuavat';
P_TABLE_GROUPBY:= ' INNER JOIN DM_NHOMVATTU c ON a.GROUPCODE = c.MANHOMVTU AND c.UNITCODE =  a.UNITCODE';
P_NOTNULL := ' AND b.MANHOMVATTU IS NOT NULL ';
END;
ELSIF P_GROUPBY = 'MALOAIVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU,b.BARCODE, b.MALOAIVATTU, t.UNITCODE, t.GIAVON, vtgc.gia_banle_vat, vtgc.giamuavat,t.MAKHO';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS MaCon, a.TEN AS TenCon,a.BARCODE AS BARCODE,c.MALOAIVATTU AS MaCha, c.TENLOAIVT AS TenCha,a.MAKHO, a.UNITCODE AS MADONVI, a.gia_banle_vat, a.giamuavat ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MAVATTU AS MA, b.TENVATTU AS TEN,b.BARCODE AS BARCODE,t.MAKHO, b.MALOAIVATTU AS GROUPCODE, t.UNITCODE, vtgc.gia_banle_vat, vtgc.giamuavat';
P_TABLE_GROUPBY:= ' INNER JOIN DM_LOAIVATTU c ON a.GROUPCODE = c.MALOAIVATTU AND c.UNITCODE =  a.UNITCODE';
P_NOTNULL := ' AND b.MALOAIVATTU IS NOT NULL ';
END;
ELSIF P_GROUPBY = 'MAKHACHHANG' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU,b.BARCODE,  b.MAKHACHHANG, t.UNITCODE, t.GIAVON, vtgc.gia_banle_vat, vtgc.giamuavat,t.MAKHO';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS MaCon, a.TEN AS TenCon,a.BARCODE AS BARCODE, c.MANCC AS MaCha, c.TENNCC AS TenCha,a.MAKHO, a.UNITCODE AS MADONVI, a.gia_banle_vat, a.giamuavat ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MAVATTU AS MA, b.TENVATTU AS TEN,b.BARCODE AS BARCODE,t.MAKHO, b.MAKHACHHANG AS GROUPCODE, t.UNITCODE, vtgc.gia_banle_vat, vtgc.giamuavat';
P_TABLE_GROUPBY:= ' INNER JOIN DM_NHACUNGCAP c ON a.GROUPCODE = c.MANCC AND c.UNITCODE =  a.UNITCODE';
P_NOTNULL := ' AND b.MAKHACHHANG IS NOT NULL ';
END;
ELSE --ELSIF P_GROUPBY = 'MAVATTU' THEN
BEGIN
P_COLUMNS_GROUPBY:= 'b.MAVATTU, b.TENVATTU,b.BARCODE, t.UNITCODE, t.GIAVON, vtgc.gia_banle_vat, vtgc.giamuavat,t.MAKHO';
P_SELECT_COLUMNS_OUT_GROUPBY:= 'a.MA AS MaCon, a.TEN AS TenCon,a.BARCODE AS BARCODE,  a.MA AS MaCha, a.TEN AS TenCha, a.UNITCODE AS MADONVI,a.MAKHO, a.gia_banle_vat, a.giamuavat ';
P_SELECT_COLUMNS_IN_GROUPBY:= ' b.MAVATTU AS MA, b.TENVATTU AS TEN ,b.BARCODE AS BARCODE,t.MAKHO, t.UNITCODE, vtgc.gia_banle_vat, vtgc.giamuavat';
P_TABLE_GROUPBY:= ' ';
P_NOTNULL := ' AND b.MAVATTU IS NOT NULL ';
END;
END IF;
 IF P_SELECTEDVAT = '0' THEN ----Không lấy giá VAT
    QUERY_STR := 'select (a.TONCUOIKYSL) as TONCUOIKYSL,(a.TONCUOIKYGT) as TONCUOIKYGT, a.GIAVON,
    '||P_SELECT_COLUMNS_OUT_GROUPBY||'
    from (
    SELECT  '||P_SELECT_COLUMNS_IN_GROUPBY||'
                              ,SUM(NVL(t.TONCUOIKYSL,0)) as TONCUOIKYSL
                              ,SUM(NVL(t.TONCUOIKYGT,0)) as TONCUOIKYGT
                              ,NVL(t.GIAVON,0) AS GIAVON
    from '||P_TABLE_NAME||' t
    INNER JOIN DM_VATTU b on b.MAVATTU = t.MAVATTU AND b.UNITCODE = t.UNITCODE
    inner join dm_vattu_giaca vtgc on vtgc.mavattu = t.mavattu
    WHERE
        t.UNITCODE LIKE ''%'||P_UNITCODE||'%'' 
        AND t.TONCUOIKYSL <> 0
        '||P_NOTNULL||'
        '||P_EXPRESSION||' 
        GROUP BY  '||P_COLUMNS_GROUPBY|| ' ORDER BY ' || P_COLUMNS_GROUPBY ||') a
     '||P_TABLE_GROUPBY;
ELSE
    QUERY_STR := 'select (a.TONCUOIKYSL) as TONCUOIKYSL,(a.TONCUOIKYGT) as TONCUOIKYGT, a.GIAVON,
    '||P_SELECT_COLUMNS_OUT_GROUPBY||'
    from (
    SELECT  '||P_SELECT_COLUMNS_IN_GROUPBY||'
                              ,SUM(NVL(t.TONCUOIKYSL,0)) as TONCUOIKYSL
                              ,SUM(NVL(t.TONCUOIKYGT*(1 + (b.TYLE_VAT_VAO/100)),0)) as TONCUOIKYGT
                              ,SUM(NVL(t.GIAVON*(1 + (b.TYLE_VAT_VAO/100)),0)) AS GIAVON
    from '||P_TABLE_NAME||' t
    INNER JOIN DM_VATTU b on b.MAVATTU = t.MAVATTU AND b.UNITCODE = t.UNITCODE
    INNER JOIN dm_vattu_giaca vtgc on vtgc.mavattu = t.mavattu
    WHERE
        t.UNITCODE = '''||P_UNITCODE||''' 
        AND t.TONCUOIKYSL <> 0
        '||P_NOTNULL||'
        '||P_EXPRESSION||' 
        GROUP BY  '||P_COLUMNS_GROUPBY|| ' ORDER BY ' || P_COLUMNS_GROUPBY ||') a
     '||P_TABLE_GROUPBY;
END IF;
BEGIN
DBMS_OUTPUT.put_line (QUERY_STR);  
OPEN CUR FOR QUERY_STR;
EXCEPTION
            WHEN NO_DATA_FOUND THEN
             NULL;
               WHEN OTHERS THEN
      NULL;
END;
END BAOCAO_TONKHO_CHITIET;
--------------------------------------------------------
--  DDL for Procedure BAOCAO_TONKHO_CHITIET
--------------------------------------------------------
/
create or replace PROCEDURE "BAOCAO_XNTNEW_TONGHOP" (P_GROUPBY IN VARCHAR2, P_MAKHO IN VARCHAR2, P_MALOAI IN VARCHAR2,  P_MANHOM IN VARCHAR2,P_MAVATTU IN VARCHAR2, P_NHACUNGCAP IN VARCHAR2,P_UNITCODE  IN VARCHAR2, P_TUNGAY IN DATE,P_DENNGAY IN DATE,P_USERNAME IN VARCHAR2, XTNCOLLECTION  OUT SYS_REFCURSOR) 
IS
    KY_BATDAU NUMBER;
    NAM_BATDAU NUMBER;
    KY_KETTHUC NUMBER;
    NAM_KETTHUC NUMBER;
    P_SQL_INSERT VARCHAR2(32767);
    QUERY_STR VARCHAR(32767);
    RESULT_STR VARCHAR(32767);
    P_SELECT_COLUMNS_GROUPBY VARCHAR(32767);
    P_TABLE_GROUPBY VARCHAR(32767);
    P_COLUMNS_GROUPBY VARCHAR(32767);
    P_SUB_GROUPBY VARCHAR(32767);
    P_SUB_SELECT_GROUPBY VARCHAR(32767);
    P_EXPRESSION VARCHAR(32767);
    P_ORDERBY VARCHAR(32767);
    CUR SYS_REFCURSOR;
    CHECK_EXIST_TABLE NUMBER(18,2) := 0;
    CREATE_TABLE VARCHAR(3000);
BEGIN
    CREATE_TABLE:= 'CREATE GLOBAL TEMPORARY TABLE "TBNETERP"."XUATNHAPTON_TEMP" 
   (	"MAVATTU" NVARCHAR2(50), 
	"MALOAIVATTU" NVARCHAR2(20), 
	"MANHOMVATTU" NVARCHAR2(20), 
	"MANHACUNGCAP" NVARCHAR2(20), 
	"MAKHO" NVARCHAR2(50), 
	"SOLUONG" NUMBER(17,4) DEFAULT 0, 
	"DONGIA" NUMBER(17,4) DEFAULT 0, 
	"THANHTIEN" NUMBER(17,4) DEFAULT 0, 
	"UNITCODE" NVARCHAR2(20), 
	"LOAICHUNGTU" NVARCHAR2(20), 
	"NGAYCHUNGTU" DATE, 
	"NGAYDUYETPHIEU" DATE,
    "USERNAME" NVARCHAR2(50)
   ) ON COMMIT PRESERVE ROWS';
    EXECUTE IMMEDIATE 'SELECT COUNT(*) FROM USER_TABLES WHERE TABLE_NAME = ''XUATNHAPTON_TEMP''' INTO CHECK_EXIST_TABLE;
    IF CHECK_EXIST_TABLE > 0 THEN DBMS_OUTPUT.PUT_LINE('');
    ELSE EXECUTE IMMEDIATE CREATE_TABLE;
    END IF;
    EXECUTE IMMEDIATE 'DELETE XUATNHAPTON_TEMP WHERE USERNAME = '''||P_USERNAME||''' AND UNITCODE = '''||P_UNITCODE||'''';
    P_SQL_INSERT := 'INSERT INTO XUATNHAPTON_TEMP (MAVATTU, MALOAIVATTU, MANHOMVATTU,MANHACUNGCAP,MAKHO,SOLUONG,DONGIA,THANHTIEN,UNITCODE, LOAICHUNGTU,NGAYCHUNGTU,NGAYDUYETPHIEU,USERNAME)
         SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
          DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
          DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
          DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
          VATTUCHUNGTU.MAKHONHAP AS MAKHO,
          VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
          VATTUCHUNGTUCHITIET.DONGIA AS DONGIA,
          VATTUCHUNGTUCHITIET.THANHTIEN AS THANHTIEN,
          VATTUCHUNGTU.UNITCODE AS UNITCODE,
          VATTUCHUNGTU.LOAICHUNGTU AS LOAICHUNGTU,
          VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
          VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
          '''||P_USERNAME||''' AS USERNAME
          FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET ON VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
        WHERE VATTUCHUNGTU.LOAICHUNGTU IN (''NMUA'',''NHBANTL'') AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';        
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHONHAP IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;
        --XUĂ¡ÂºÂ¤T BĂƒï¿½N LĂ¡ÂºÂº WEB
      P_SQL_INSERT := P_SQL_INSERT || ' UNION ALL
         SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
          DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
          DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
          DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
          VATTUCHUNGTU.MAKHOXUAT AS MAKHO,
          VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
          VATTUCHUNGTUCHITIET.DONGIA AS DONGIA,
          VATTUCHUNGTUCHITIET.THANHTIEN AS THANHTIEN,
          VATTUCHUNGTU.UNITCODE AS UNITCODE,
          VATTUCHUNGTU.LOAICHUNGTU AS LOAICHUNGTU,
          VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
          VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
          '''||P_USERNAME||''' AS USERNAME
          FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET ON VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
        WHERE VATTUCHUNGTU.LOAICHUNGTU=''XBANLE'' AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';        
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHOXUAT IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;     

            --XUĂ¡ÂºÂ¤T HĂ¡Â»Â¦Y
             P_SQL_INSERT := P_SQL_INSERT || '
            UNION ALL
            SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
              DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              VATTUCHUNGTU.MAKHOXUAT AS MAKHO,
              VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
              VATTUCHUNGTUCHITIET.DONGIA AS DONGIA,
              VATTUCHUNGTUCHITIET.THANHTIEN AS THANHTIEN,
              VATTUCHUNGTU.UNITCODE AS UNITCODE,
              TO_NCHAR(''XUATHUY'') AS LOAICHUNGTU,
              VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
              VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
              FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET
              ON (VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK)
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
              WHERE VATTUCHUNGTU.LOAICHUNGTU = ''XKHAC'' AND VATTUCHUNGTU.MALYDOKHAC =''X1'' AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHOXUAT IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;

            --XuĂ¡ÂºÂ¥t trĂ¡ÂºÂ£ nhĂƒÂ  cung cĂ¡ÂºÂ¥p 
             P_SQL_INSERT := P_SQL_INSERT || '
            UNION ALL
             SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
              DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              VATTUCHUNGTU.MAKHOXUAT AS MAKHO,
              VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
              VATTUCHUNGTUCHITIET.DONGIA AS DONGIA,
              VATTUCHUNGTUCHITIET.THANHTIEN AS THANHTIEN,
              VATTUCHUNGTU.UNITCODE AS UNITCODE,
              TO_NCHAR(''XUATTRANCC'') AS LOAICHUNGTU,
              VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
              VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
              FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET
              ON (VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK)
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
              WHERE VATTUCHUNGTU.LOAICHUNGTU = ''XKHAC'' AND VATTUCHUNGTU.MALYDOKHAC =''X12'' AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHOXUAT IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;

           --XUĂ¡ÂºÂ¤T Ă„ï¿½IĂ¡Â»â‚¬U CHĂ¡Â»Ë†NH
             P_SQL_INSERT := P_SQL_INSERT || '
          UNION ALL
             SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
              DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              VATTUCHUNGTU.MAKHOXUAT AS MAKHO,
              VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
              VATTUCHUNGTUCHITIET.DONGIA AS DONGIA,
              VATTUCHUNGTUCHITIET.THANHTIEN AS THANHTIEN,
              VATTUCHUNGTU.UNITCODE AS UNITCODE,
              TO_NCHAR(''XUATDIEUCHINH'') AS LOAICHUNGTU,
              VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
              VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
              FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET
              ON (VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK)
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU  AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
              WHERE VATTUCHUNGTU.LOAICHUNGTU = ''XKHAC'' AND VATTUCHUNGTU.MALYDOKHAC =''X2'' AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHOXUAT IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;

            --XUĂ¡ÂºÂ¤T HĂ¡Â»Â¦Y HĂƒâ‚¬NG HĂ¡Â»Å½NG -- cĂƒÂ³ 2 trĂ†Â°Ă¡Â»ï¿½ng hĂ¡Â»Â£p xuĂ¡ÂºÂ¥t hĂ¡Â»Â§y hĂƒÂ ng hĂƒÂ³a 1: cĂƒÂ³ mĂƒÂ£ lĂƒÂ½ do lĂƒÂ  X11 vĂƒÂ  2: mĂƒÂ£ lĂƒÂ½ do NULL
             P_SQL_INSERT := P_SQL_INSERT || '
        UNION ALL
             SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
              DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              VATTUCHUNGTU.MAKHOXUAT AS MAKHO,
              VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
              VATTUCHUNGTUCHITIET.DONGIA AS DONGIA,
              VATTUCHUNGTUCHITIET.THANHTIEN AS THANHTIEN,
              VATTUCHUNGTU.UNITCODE AS UNITCODE,
              TO_NCHAR(''XUATHUYHANGHONG'') AS LOAICHUNGTU,
              VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
              VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
              FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET
              ON (VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK)
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
              WHERE VATTUCHUNGTU.LOAICHUNGTU = ''XKHAC'' AND (VATTUCHUNGTU.MALYDOKHAC IS NULL OR VATTUCHUNGTU.MALYDOKHAC = ''X11'' ) AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHOXUAT IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;
            ---NHĂ¡ÂºÂ¬P KHĂƒï¿½C ---NHĂ¡ÂºÂ¬P TRĂ¡Â»Âª TĂ¡Â»â€™N Ăƒâ€�M --NHĂ¡ÂºÂ¬P Ă„ï¿½IĂ¡Â»â‚¬U CHĂ¡Â»Ë†NH
             P_SQL_INSERT := P_SQL_INSERT || '
                        UNION ALL
             SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
              DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              VATTUCHUNGTU.MAKHONHAP AS MAKHO,
              VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
              VATTUCHUNGTUCHITIET.DONGIA AS DONGIA,
              VATTUCHUNGTUCHITIET.THANHTIEN AS THANHTIEN,
              VATTUCHUNGTU.UNITCODE AS UNITCODE,
              TO_NCHAR(''NHAPDIEUCHINH'') AS LOAICHUNGTU,
              VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
              VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
              FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET
              ON (VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK)
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
              WHERE VATTUCHUNGTU.LOAICHUNGTU = ''NKHAC'' AND VATTUCHUNGTU.MALYDOKHAC =''N3'' AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHONHAP IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;
            ---NHĂ¡ÂºÂ¬P KHĂƒï¿½C ---XĂ¡Â»Â¬ LĂƒï¿½ HĂƒâ‚¬NG Ăƒâ€�M
             P_SQL_INSERT := P_SQL_INSERT || '
                        UNION ALL
             SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
            DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              VATTUCHUNGTU.MAKHONHAP AS MAKHO,
              VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
              VATTUCHUNGTUCHITIET.DONGIA AS DONGIA,
              VATTUCHUNGTUCHITIET.THANHTIEN AS THANHTIEN,
              VATTUCHUNGTU.UNITCODE AS UNITCODE,
              TO_NCHAR(''NHAPHANGAM'') AS LOAICHUNGTU,
              VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
              VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
              FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET
              ON (VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK)
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
              WHERE VATTUCHUNGTU.LOAICHUNGTU = ''NKHAC'' AND VATTUCHUNGTU.MALYDOKHAC =''N2'' AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHONHAP IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;
            -- Ă„ï¿½IĂ¡Â»â‚¬U CHUYĂ¡Â»â€�N NHĂ¡ÂºÂ¬N -- cĂƒÂ³ 2 trĂ†Â°Ă¡Â»ï¿½ng hĂ¡Â»Â£p: NHĂ¡ÂºÂ¬P CHUYĂ¡Â»â€�N KHO VĂƒâ‚¬ NHĂ¡ÂºÂ¬P ST THĂƒâ‚¬NH VIĂƒÅ N
            -- NHĂ¡ÂºÂ¬P CHUYĂ¡Â»â€�N KHO
             P_SQL_INSERT := P_SQL_INSERT || '
             UNION ALL
             SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
              DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              VATTUCHUNGTU.MAKHONHAP AS MAKHO,
              VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
              VATTUCHUNGTUCHITIET.DONGIA AS DONGIA,
              VATTUCHUNGTUCHITIET.THANHTIEN AS THANHTIEN,
              VATTUCHUNGTU.UNITCODE AS UNITCODE,
              TO_NCHAR(''NHAPCHUYENKHO'') AS LOAICHUNGTU,
              VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
              VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
              FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET
              ON (VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK)
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
              WHERE VATTUCHUNGTU.LOAICHUNGTU = ''DCN'' AND VATTUCHUNGTU.MADONVIXUAT = VATTUCHUNGTU.UNITCODE AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHONHAP IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;
            -- NHĂ¡ÂºÂ¬P ST THĂƒâ‚¬NH VIĂƒÅ N
             P_SQL_INSERT := P_SQL_INSERT || '
            UNION ALL
             SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
              DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              VATTUCHUNGTU.MAKHONHAP AS MAKHO,
              VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
              VATTUCHUNGTUCHITIET.DONGIA AS DONGIA,
              VATTUCHUNGTUCHITIET.THANHTIEN AS THANHTIEN,
              VATTUCHUNGTU.UNITCODE AS UNITCODE,
              TO_NCHAR(''NHAPSTTHANHVIEN'') AS LOAICHUNGTU,
              VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
              VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
              FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET
              ON (VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK)
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
              WHERE VATTUCHUNGTU.LOAICHUNGTU = ''DCN'' AND VATTUCHUNGTU.MADONVIXUAT <> VATTUCHUNGTU.UNITCODE AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHONHAP IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;
            -- Ă„ï¿½IĂ¡Â»â‚¬U CHUYĂ¡Â»â€�N XUĂ¡ÂºÂ¤T-- cĂƒÂ³ 2 trĂ†Â°Ă¡Â»ï¿½ng hĂ¡Â»Â£p: XUĂ¡ÂºÂ¤T CHUYĂ¡Â»â€�N KHO VĂƒâ‚¬ XUĂ¡ÂºÂ¤T ST THĂƒâ‚¬NH VIĂƒÅ N
            -- XUĂ¡ÂºÂ¤T CHUYĂ¡Â»â€�N KHO
             P_SQL_INSERT := P_SQL_INSERT || '
            UNION ALL
             SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
              DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              VATTUCHUNGTU.MAKHOXUAT AS MAKHO,
              VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
              VATTUCHUNGTUCHITIET.DONGIA AS DONGIA,
              VATTUCHUNGTUCHITIET.THANHTIEN AS THANHTIEN,
              VATTUCHUNGTU.UNITCODE AS UNITCODE,
              TO_NCHAR(''XUATCHUYENKHO'') AS LOAICHUNGTU,
              VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
              VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
              FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET
              ON (VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK)
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU  AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
              WHERE VATTUCHUNGTU.LOAICHUNGTU = ''DCX'' AND VATTUCHUNGTU.MADONVINHAN = VATTUCHUNGTU.UNITCODE AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHOXUAT IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;
            -- XUĂ¡ÂºÂ¤T ST THĂƒâ‚¬NH VIĂƒÅ N
             P_SQL_INSERT := P_SQL_INSERT || '
            UNION ALL
             SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
              DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              VATTUCHUNGTU.MAKHOXUAT AS MAKHO,
              VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
              VATTUCHUNGTUCHITIET.DONGIA AS DONGIA,
              VATTUCHUNGTUCHITIET.THANHTIEN AS THANHTIEN,
              VATTUCHUNGTU.UNITCODE AS UNITCODE,
              TO_NCHAR(''XUATSTTHANHVIEN'') AS LOAICHUNGTU,
              VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
              VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
              FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET
              ON (VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK)
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
              WHERE VATTUCHUNGTU.LOAICHUNGTU = ''DCX'' AND VATTUCHUNGTU.MADONVINHAN <> VATTUCHUNGTU.UNITCODE AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHOXUAT IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;
            -- XUĂ¡ÂºÂ¤T BĂƒï¿½N BUĂƒâ€�N
             P_SQL_INSERT := P_SQL_INSERT || ' UNION ALL
             SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
              DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              VATTUCHUNGTU.MAKHOXUAT AS MAKHO,
              VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
              VATTUCHUNGTUCHITIET.DONGIA AS DONGIA,
              VATTUCHUNGTUCHITIET.THANHTIEN AS THANHTIEN,
              VATTUCHUNGTU.UNITCODE AS UNITCODE,
              TO_NCHAR(''XUATBANBUON'') AS LOAICHUNGTU,
              VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
              VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
              FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET
              ON (VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK)
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU  AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
              WHERE VATTUCHUNGTU.LOAICHUNGTU = ''XBAN'' AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHOXUAT IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;

            -------------------------------------
            --LĂ¡ÂºÂ¤Y DĂ¡Â»Â® LIĂ¡Â»â€ U BĂƒï¿½N HĂƒâ‚¬NG --
            P_SQL_INSERT := P_SQL_INSERT || '
           UNION ALL
            SELECT hanggdquay.MAVATTU AS MAVATTU,
                     DM_VATTU.MALOAIVATTU AS MALOAIVATTU, 
                     DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
                     DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
                     hanggdquay.MAKHOHANG AS MAKHO,
                     hanggdquay.SOLUONG AS SOLUONG,
                     hanggdquay.GIABANLECOVAT AS DONGIA,
                     hanggdquay.TTIENCOVAT AS THANHTIEN,
                     hanggdquay.MADONVI AS UNITCODE,
                     TO_NCHAR(gdquay.LOAIGIAODICH) AS LOAICHUNGTU,
                     gdquay.NGAYTAO AS NGAYCHUNGTU,
                     gdquay.NGAYPHATSINH AS NGAYDUYETPHIEU,
                     '''||P_USERNAME||''' AS USERNAME
            FROM NVGDQUAY_ASYNCCLIENT gdquay
               INNER JOIN NVHANGGDQUAY_ASYNCCLIENT hanggdquay
                  ON (gdquay.MAGIAODICHQUAYPK = hanggdquay.MAGDQUAYPK)
              INNER JOIN DM_VATTU ON hanggdquay.MAVATTU = DM_VATTU.MAVATTU  AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
                  WHERE hanggdquay.MADONVI = '''||P_UNITCODE||''' AND TO_DATE(gdquay.NGAYPHATSINH,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';  
                   IF TRIM(P_MAKHO) IS NOT NULL THEN
                    P_SQL_INSERT := P_SQL_INSERT||' AND hanggdquay.MAKHOHANG IN ('||P_MAKHO||')';
                    END IF;
                    IF TRIM(P_MALOAI) IS NOT NULL THEN
                    P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
                    END IF;
                    IF TRIM(P_MANHOM) IS NOT NULL THEN
                    P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
                    END IF;
                    IF TRIM(P_MAVATTU) IS NOT NULL THEN
                    P_SQL_INSERT := P_SQL_INSERT||' AND hanggdquay.MAVATTU IN ('||P_MAVATTU||')';
                    END IF;
                    IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
                    P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
                    END IF;
            -- LĂ¡ÂºÂ¤Y DĂ¡Â»Â® LIĂ¡Â»â€ U NHĂ¡ÂºÂ¬P KIĂ¡Â»â€�M KĂƒÅ  
            P_SQL_INSERT := P_SQL_INSERT || '
            UNION ALL
            SELECT kiemkechitiet.MAVATTU AS MAVATTU,
            kiemkechitiet.LOAIVATTUKK AS MALOAIVATTU,
            kiemkechitiet.NHOMVATTUKK AS MANHOMVATTU,
            DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
            kiemke.KHOKIEMKE AS MAKHO,
            ABS(kiemkechitiet.SOLUONGCHENHLECH) AS SOLUONG,
            kiemkechitiet.GIAVON AS DONGIA,
            ABS(kiemkechitiet.TIENCHENHLECH) AS THANHTIEN,
            kiemkechitiet.MADONVI AS UNITCODE,
            TO_NCHAR(''NHAPKIEMKE'') AS LOAICHUNGTU,
            kiemke.NGAYKIEMKE AS NGAYCHUNGTU,
            kiemke.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
            '''||P_USERNAME||''' AS USERNAME
            FROM NVKIEMKE kiemke INNER JOIN NVKIEMKECHITIET kiemkechitiet 
            ON (kiemke.MAPHIEUKIEMKE = kiemkechitiet.MAPHIEUKIEMKE)
              INNER JOIN DM_VATTU ON kiemkechitiet.MAVATTU = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
            WHERE kiemke.TRANGTHAI = 10 AND kiemkechitiet.MADONVI = '''||P_UNITCODE||''' AND kiemkechitiet.SOLUONGCHENHLECH < 0 AND TO_DATE(kiemke.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND kiemke.KHOKIEMKE IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND kiemkechitiet.LOAIVATTUKK  IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND kiemkechitiet.NHOMVATTUKK IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND  kiemkechitiet.MAVATTU IN ('||P_MAVATTU||')';  
            END IF;
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;
         -- LĂ¡ÂºÂ¤Y DĂ¡Â»Â® LIĂ¡Â»â€ U XUĂ¡ÂºÂ¤T KIĂ¡Â»â€�M KĂƒÅ  
         P_SQL_INSERT := P_SQL_INSERT || '
            UNION ALL
            SELECT kiemkechitiet.MAVATTU AS MAVATTU,
            kiemkechitiet.LOAIVATTUKK AS MALOAIVATTU,
            kiemkechitiet.NHOMVATTUKK AS MANHOMVATTU,
            DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
            kiemke.KHOKIEMKE AS MAKHO,
            ABS(kiemkechitiet.SOLUONGCHENHLECH) AS SOLUONG,
            kiemkechitiet.GIAVON AS DONGIA,
            ABS(kiemkechitiet.TIENCHENHLECH) AS THANHTIEN,
            kiemkechitiet.MADONVI AS UNITCODE,
            TO_NCHAR(''XUATKIEMKE'') AS LOAICHUNGTU,
            kiemke.NGAYKIEMKE AS NGAYCHUNGTU,
            kiemke.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
            '''||P_USERNAME||''' AS USERNAME
            FROM NVKIEMKE kiemke INNER JOIN NVKIEMKECHITIET kiemkechitiet 
            ON (kiemke.MAPHIEUKIEMKE = kiemkechitiet.MAPHIEUKIEMKE)
            INNER JOIN DM_VATTU ON kiemkechitiet.MAVATTU = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
            WHERE kiemke.TRANGTHAI = 10 AND kiemkechitiet.MADONVI = '''||P_UNITCODE||''' AND kiemkechitiet.SOLUONGCHENHLECH >= 0 AND TO_DATE(kiemke.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND kiemke.KHOKIEMKE IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND kiemkechitiet.LOAIVATTUKK  IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND kiemkechitiet.NHOMVATTUKK IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND  kiemkechitiet.MAVATTU IN ('||P_MAVATTU||')'; 
            END IF;
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;

        --TĂƒÅ’M BĂ¡ÂºÂ¢NG XUĂ¡ÂºÂ¤T NHĂ¡ÂºÂ¬P TĂ¡Â»â€™N Ă„ï¿½Ă¡ÂºÂ¦U KĂ¡Â»Â²
        BEGIN
        SELECT KY, NAM INTO KY_BATDAU, NAM_BATDAU FROM DM_KYKETOAN WHERE TO_DATE(DENNGAY, 'dd/MM/yyyy') = TO_DATE(P_TUNGAY, 'dd/MM/yyyy') AND UNITCODE = P_UNITCODE AND TRANGTHAI = 10;
           EXCEPTION
                    WHEN NO_DATA_FOUND THEN
                    DBMS_OUTPUT.PUT_LINE(SQLERRM);   
        END;--End TĂƒÂ¬m ky
         -- LĂ¡ÂºÂ¤Y DĂ¡Â»Â® LIĂ¡Â»â€ U TĂ¡Â»â€™N Ă„ï¿½Ă¡ÂºÂ¦U KĂ¡Â»Â²
         P_SQL_INSERT := P_SQL_INSERT || '
            UNION ALL
            SELECT TDK.MAVATTU AS MAVATTU,
              DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              TDK.MAKHO AS MAKHO,
              TDK.TONDAUKYSL AS SOLUONG,
              TDK.GIAVON AS DONGIA,
              TDK.TONDAUKYGT AS THANHTIEN,
              TDK.UNITCODE AS UNITCODE,
              TO_NCHAR(''TONDAUKY'') AS LOAICHUNGTU,
              TO_DATE('''||P_TUNGAY||''',''dd/MM/yyyy'') AS NGAYCHUNGTU,
              TO_DATE('''||P_TUNGAY||''',''dd/MM/yyyy'') AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
            FROM XNT_'||NAM_BATDAU||'_KY_'||KY_BATDAU||' TDK 
            INNER JOIN DM_VATTU ON TDK.MAVATTU = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
            WHERE TDK.UNITCODE = '''||P_UNITCODE||''' AND TDK.TONDAUKYSL <> 0 ';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND TDK.MAKHO IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND TDK.MAVATTU IN ('||P_MAVATTU||')';
            END IF;
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;


        BEGIN
           DBMS_OUTPUT.ENABLE(1000000);
            --DBMS_OUTPUT.put_line(P_SQL_INSERT);
            EXECUTE IMMEDIATE P_SQL_INSERT;
            EXCEPTION WHEN OTHERS THEN  
            DBMS_OUTPUT.PUT_LINE(SQLERRM);   
        END;

      
                          --QUERY_STR :='SELECT * FROM XUATNHAPTON_TEMP';
                         -- OPEN XTNCOLLECTION FOR QUERY_STR;
        ---NMUA,XBANLE,NHBANTL, XUATBANBUON, ||||||
        ---XUATHUYHANGHONG,XUATHUY,XUATTRANCC,XUATDIEUCHINH,NHAPDIEUCHINH,NHAPHANGAM,1,2,KIEMKE
        --XUATNHAPTON_TEMP (MAVATTU, MALOAIVATTU, MANHOMVATTU,MANHACUNGCAP,MAKHO,SOLUONG,DONGIA,THANHTIEN,UNITCODE, LOAICHUNGTU,NGAYCHUNGTU,NGAYDUYETPHIEU)
        QUERY_STR := '
        SELECT a.MAVATTU,a.MALOAIVATTU,a.MAKHO,a.MANHACUNGCAP,a.MANHOMVATTU,a.DONGIA,a.UNITCODE,a.NGAYCHUNGTU,a.NGAYDUYETPHIEU,
        NVL(a.XUATBANLEQUAY_SUM_SOLUONG,0) AS XBANLEQUAY_SL , NVL(a.XUATBANLEQUAY_SUM_THANHTIEN,0) AS XBANLEQUAY_GT,
        NVL(a.XUATBANLETRALAI_SUM_SOLUONG,0) AS XBANLETL_SL  , NVL(a.XUATBANLETRALAI_SUM_THANHTIEN,0) AS XBANLETL_GT,
        NVL(a.XUATBBQTN_SUM_SOLUONG,0) AS XUATBBQTN_SL  , NVL(a.XUATBBQTN_SUM_THANHTIEN,0) AS XUATBBQTN_GT,
        NVL(a.NMUA_SUM_SOLUONG,0) AS NMUA_SL , NVL(a.NMUA_SUM_THANHTIEN,0) AS NMUA_GT,
        NVL(a.NHAPKIEMKE_SUM_SOLUONG,0) AS NHAPKIEMKE_SL, NVL(a.NHAPKIEMKE_SUM_THANHTIEN,0) AS NHAPKIEMKE_GT,
        NVL(a.XUATKIEMKE_SUM_SOLUONG,0) AS XUATKIEMKE_SL, NVL(a.XUATKIEMKE_SUM_THANHTIEN,0) AS XUATKIEMKE_GT,
        NVL(a.XUATBANLE_SUM_SOLUONG,0) AS XBANLE_SL, NVL(a.XUATBANLE_SUM_THANHTIEN,0) AS XBANLE_GT,
        NVL(a.NHAPCHUYENKHO_SUM_SOLUONG,0) AS NHAPCHUYENKHO_SL, NVL(a.NHAPCHUYENKHO_SUM_THANHTIEN,0) AS NHAPCHUYENKHO_GT,
        NVL(a.NHAPSTTHANHVIEN_SUM_SOLUONG,0) AS NHAPSTTHANHVIEN_SL, NVL(a.NHAPSTTHANHVIEN_SUM_THANHTIEN,0) AS NHAPSTTHANHVIEN_GT,
        NVL(a.XUATCHUYENKHO_SUM_SOLUONG,0) AS XUATCHUYENKHO_SL, NVL(a.XUATCHUYENKHO_SUM_THANHTIEN,0) AS XUATCHUYENKHO_GT,
        NVL(a.XUATSTTHANHVIEN_SUM_SOLUONG,0) AS XUATSTTHANHVIEN_SL, NVL(a.XUATSTTHANHVIEN_SUM_THANHTIEN,0) AS XUATSTTHANHVIEN_GT,
        NVL(a.NHAPDIEUCHINH_SUM_SOLUONG,0) AS NHAPDIEUCHINH_SL, NVL(a.NHAPDIEUCHINH_SUM_THANHTIEN,0) AS NHAPDIEUCHINH_GT,
        NVL(a.XUATBANBUON_SUM_SOLUONG,0) AS XUATBANBUON_SL, NVL(a.XUATBANBUON_SUM_THANHTIEN,0) AS XUATBANBUON_GT,
        NVL(a.NHAPHANGAM_SUM_SOLUONG,0) AS NHAPHANGAM_SL, NVL(a.NHAPHANGAM_SUM_THANHTIEN,0) AS NHAPHANGAM_GT,
        NVL(a.XUATHUYHANGHONG_SUM_SOLUONG,0) AS XUATHUYHH_SL, NVL(a.XUATHUYHANGHONG_SUM_THANHTIEN,0) AS XUATHUYHH_GT,
        NVL(a.XUATHUY_SUM_SOLUONG,0) AS XUATHUY_SL, NVL(a.XUATHUY_SUM_THANHTIEN,0) AS XUATHUY_GT,
        NVL(a.XUATTRANCC_SUM_SOLUONG,0) AS XUATTRANCC_SL, NVL(a.XUATTRANCC_SUM_THANHTIEN,0) AS XUATTRANCC_GT,
        NVL(a.XUATDIEUCHINH_SUM_SOLUONG,0) AS XUATDC_SL, NVL(a.XUATDIEUCHINH_SUM_THANHTIEN,0) AS XUATDC_GT,
        NVL(a.NHBANTL_SUM_SOLUONG,0) AS NHAPBANTL_SL, NVL(a.NHBANTL_SUM_THANHTIEN,0) AS NHAPBANTL_GT,
        NVL(a.TONDAUKY_SUM_SOLUONG,0) AS TONDAUKY_SL, NVL(a.TONDAUKY_SUM_THANHTIEN,0) AS TONDAUKY_GT
        FROM (
            SELECT MAVATTU, MALOAIVATTU, MANHOMVATTU,SOLUONG,DONGIA,THANHTIEN,UNITCODE,MAKHO,MANHACUNGCAP,LOAICHUNGTU,NGAYCHUNGTU,NGAYDUYETPHIEU FROM XUATNHAPTON_TEMP)
            PIVOT ( SUM(SOLUONG) AS SUM_SOLUONG, SUM(NVL(THANHTIEN,0)) as SUM_THANHTIEN
              FOR LOAICHUNGTU
              IN (''1'' AS XUATBANLEQUAY,''2'' AS XUATBANLETRALAI,''3'' AS XUATBBQTN, ''NMUA'' AS NMUA, ''NHAPKIEMKE'' AS NHAPKIEMKE,''XUATKIEMKE'' AS XUATKIEMKE, ''NHAPCHUYENKHO'' AS NHAPCHUYENKHO, ''NHAPSTTHANHVIEN'' AS NHAPSTTHANHVIEN, ''XUATCHUYENKHO'' AS XUATCHUYENKHO, 
              ''XUATSTTHANHVIEN'' AS XUATSTTHANHVIEN, ''XBANLE'' AS XUATBANLE,''NHAPDIEUCHINH'' AS NHAPDIEUCHINH,''NHAPHANGAM'' AS NHAPHANGAM,''XUATHUYHANGHONG'' AS XUATHUYHANGHONG,''XUATHUY'' AS XUATHUY, ''XUATBANBUON'' AS XUATBANBUON,
              ''XUATTRANCC'' AS XUATTRANCC,''XUATDIEUCHINH'' AS XUATDIEUCHINH,''NHBANTL'' AS NHBANTL,''TONDAUKY'' AS TONDAUKY)
        ) a ORDER BY a.MAVATTU,a.MALOAIVATTU,a.MANHOMVATTU,a.NGAYDUYETPHIEU';



        --Group sau khi Pivot
        QUERY_STR  :=' SELECT U.MAVATTU,U.MALOAIVATTU, U.MANHOMVATTU, U.UNITCODE,U.MAKHO,U.MANHACUNGCAP,
        SUM(U.XBANLEQUAY_SL) AS XBANLEQUAY_SL , SUM(U.XBANLEQUAY_GT) AS XBANLEQUAY_GT,
        SUM(U.XBANLETL_SL) AS XBANLETL_SL  , SUM(U.XBANLETL_GT) AS XBANLETL_GT,
        SUM(U.XUATBBQTN_SL) AS XUATBBQTN_SL  , SUM(U.XUATBBQTN_GT) AS XUATBBQTN_GT,
        SUM(U.NMUA_SL) AS NMUA_SL , SUM(U.NMUA_GT) AS NMUA_GT,
        SUM(U.NHAPKIEMKE_SL) AS NHAPKIEMKE_SL, SUM(U.NHAPKIEMKE_GT) AS NHAPKIEMKE_GT,
        SUM(U.XUATKIEMKE_SL) AS XUATKIEMKE_SL, SUM(U.XUATKIEMKE_GT) AS XUATKIEMKE_GT,
        SUM(U.NHAPCHUYENKHO_SL) AS NHAPCHUYENKHO_SL, SUM(U.NHAPCHUYENKHO_GT) AS NHAPCHUYENKHO_GT,
        SUM(U.NHAPSTTHANHVIEN_SL) AS NHAPSTTHANHVIEN_SL, SUM(U.NHAPSTTHANHVIEN_GT) AS NHAPSTTHANHVIEN_GT,
        SUM(U.XUATCHUYENKHO_SL) AS XUATCHUYENKHO_SL, SUM(U.XUATCHUYENKHO_GT) AS XUATCHUYENKHO_GT,
        SUM(U.XUATSTTHANHVIEN_SL) AS XUATSTTHANHVIEN_SL, SUM(U.XUATSTTHANHVIEN_GT) AS XUATSTTHANHVIEN_GT,
        SUM(U.XBANLE_SL) AS XBANLE_SL, SUM(U.XBANLE_GT) AS XBANLE_GT,
        SUM(U.XUATBANBUON_SL) AS XUATBANBUON_SL, SUM(U.XUATBANBUON_GT) AS XUATBANBUON_GT,
        SUM(U.NHAPDIEUCHINH_SL) AS NHAPDIEUCHINH_SL, SUM(U.NHAPDIEUCHINH_GT) AS NHAPDIEUCHINH_GT,
        SUM(U.NHAPHANGAM_SL) AS NHAPHANGAM_SL, SUM(U.NHAPHANGAM_GT) AS NHAPHANGAM_GT,
        SUM(U.XUATHUYHH_SL) AS XUATHUYHH_SL, SUM(U.XUATHUYHH_GT) AS XUATHUYHH_GT,
        SUM(U.XUATHUY_SL) AS XUATHUY_SL, SUM(U.XUATHUY_GT) AS XUATHUY_GT,
        SUM(U.XUATTRANCC_SL) AS XUATTRANCC_SL, SUM(U.XUATTRANCC_GT) AS XUATTRANCC_GT,
        SUM(U.XUATDC_SL) AS XUATDC_SL, SUM(U.XUATDC_GT) AS XUATDC_GT,
        SUM(U.NHAPBANTL_SL) AS NHAPBANTL_SL, SUM(U.NHAPBANTL_GT) AS NHAPBANTL_GT,
        SUM(U.TONDAUKY_SL) AS TONDAUKY_SL, SUM(U.TONDAUKY_GT) AS TONDAUKY_GT
        FROM ('||QUERY_STR||') U 
        GROUP BY U.MAVATTU,U.MALOAIVATTU, U.MANHOMVATTU, U.UNITCODE, U.MAKHO,U.MANHACUNGCAP
        '; 


        --TĂƒÅ’M BĂ¡ÂºÂ¢NG XUĂ¡ÂºÂ¤T NHĂ¡ÂºÂ¬P TĂ¡Â»â€™N CUĂ¡Â»ï¿½I KĂ¡Â»Â²
        BEGIN

        SELECT KY, NAM INTO KY_KETTHUC, NAM_KETTHUC FROM DM_KYKETOAN WHERE TO_DATE(DENNGAY, 'dd/MM/yyyy') = TO_DATE(P_DENNGAY, 'dd/MM/yyyy') AND UNITCODE = P_UNITCODE AND TRANGTHAI = 10;
           EXCEPTION
                    WHEN NO_DATA_FOUND THEN
                    DBMS_OUTPUT.PUT_LINE(SQLERRM);   
        END;--End TĂƒÂ¬m ky
        RESULT_STR := '
        SELECT H.MAVATTU,H.MALOAIVATTU, H.MANHOMVATTU, H.UNITCODE,H.MAKHO,H.MANHACUNGCAP,
        NVL(H.XBANLEQUAY_SL,0) AS XBANLEQUAY_SL, NVL(H.XBANLEQUAY_GT,0) AS XBANLEQUAY_GT,
        NVL(H.XBANLETL_SL,0) AS XBANLETL_SL , NVL(H.XBANLETL_GT,0) AS XBANLETL_GT,
        NVL(H.XUATBBQTN_SL,0) AS XUATBBQTN_SL , NVL(H.XUATBBQTN_GT,0) AS XUATBBQTN_GT,
        NVL(H.NMUA_SL,0) AS NMUA_SL, NVL(H.NMUA_GT,0) AS NMUA_GT,
        NVL(H.NHAPKIEMKE_SL,0) AS NHAPKIEMKE_SL, NVL(H.NHAPKIEMKE_GT,0) AS NHAPKIEMKE_GT,
        NVL(H.XUATKIEMKE_SL,0) AS XUATKIEMKE_SL, NVL(H.XUATKIEMKE_GT,0) AS XUATKIEMKE_GT ,
        NVL(H.NHAPCHUYENKHO_SL,0) AS NHAPCHUYENKHO_SL, NVL(H.NHAPCHUYENKHO_GT,0) AS NHAPCHUYENKHO_GT,
        NVL(H.NHAPSTTHANHVIEN_SL,0) AS NHAPSTTHANHVIEN_SL, NVL(H.NHAPSTTHANHVIEN_GT,0) AS NHAPSTTHANHVIEN_GT,
        NVL(H.XUATCHUYENKHO_SL,0) AS XUATCHUYENKHO_SL, NVL(H.XUATCHUYENKHO_GT,0) AS XUATCHUYENKHO_GT,
        NVL(H.XUATSTTHANHVIEN_SL,0) AS XUATSTTHANHVIEN_SL, NVL(H.XUATSTTHANHVIEN_GT,0) AS XUATSTTHANHVIEN_GT,
        NVL(H.XBANLE_SL,0) AS XBANLE_SL, NVL(H.XBANLE_GT,0) AS XBANLE_GT,
        NVL(H.XUATBANBUON_SL,0) AS XUATBANBUON_SL, NVL(H.XUATBANBUON_GT,0) AS XUATBANBUON_GT,
        NVL(H.NHAPDIEUCHINH_SL,0) AS NHAPDIEUCHINH_SL, NVL(H.NHAPDIEUCHINH_GT,0) AS NHAPDIEUCHINH_GT,
        NVL(H.NHAPHANGAM_SL,0) AS NHAPHANGAM_SL, NVL(H.NHAPHANGAM_GT,0) AS NHAPHANGAM_GT,
        NVL(H.XUATHUYHH_SL,0) AS XUATHUYHH_SL, NVL(H.XUATHUYHH_GT,0) AS XUATHUYHH_GT,
        NVL(H.XUATHUY_SL,0) AS XUATHUY_SL, NVL(H.XUATHUY_GT,0) AS XUATHUY_GT,
        NVL(H.XUATTRANCC_SL,0) AS XUATTRANCC_SL, NVL(H.XUATTRANCC_GT,0) AS XUATTRANCC_GT,
        NVL(H.XUATDC_SL,0) AS XUATDC_SL, NVL(H.XUATDC_GT,0) AS XUATDC_GT,
        NVL(H.NHAPBANTL_SL,0) AS NHAPBANTL_SL, NVL(H.NHAPBANTL_GT,0) AS NHAPBANTL_GT,
        NVL(H.TONDAUKY_SL,0) AS TONDAUKY_SL,NVL(H.TONDAUKY_GT,0) AS TONDAUKY_GT,NVL(C.TONCUOIKYSL,0) AS TONCUOIKY_SL,NVL(C.TONCUOIKYGT,0) AS TONCUOIKY_GT
        FROM ('||QUERY_STR||') H 
        INNER JOIN XNT_'|| NAM_KETTHUC ||'_KY_'||KY_KETTHUC||' C ON H.MAVATTU = C.MAVATTU AND H.MAKHO = C.MAKHO AND H.UNITCODE = C.UNITCODE 
        ';
        --START RETURN RESULT...
        IF P_GROUPBY = 'MAKHO' THEN
        BEGIN
        P_COLUMNS_GROUPBY:= 'X.MAKHO, F.TENKHO';
        P_SELECT_COLUMNS_GROUPBY:= 'X.MAKHO AS MA, F.TENKHO AS TEN';
        P_TABLE_GROUPBY:= ' INNER JOIN DM_KHO F ON X.MAKHO = F.MAKHO AND F.UNITCODE = '''||P_UNITCODE||''' ';
        P_ORDERBY := 'X.MAKHO, F.TENKHO';
        END;

        ELSIF P_GROUPBY = 'MANHOMVATTU' THEN
        BEGIN
        P_COLUMNS_GROUPBY:= 'X.MANHOMVATTU, F.TENNHOMVT';
        P_SELECT_COLUMNS_GROUPBY:= ' X.MANHOMVATTU AS MA, F.TENNHOMVT AS TEN';
        P_TABLE_GROUPBY:= ' INNER JOIN DM_NHOMVATTU F ON X.MANHOMVATTU = F.MANHOMVTU AND F.UNITCODE = '''||P_UNITCODE||''' ';
        P_ORDERBY := 'X.MANHOMVATTU, F.TENNHOMVT';
        END;

        ELSIF P_GROUPBY = 'MALOAIVATTU' THEN
        BEGIN
        P_COLUMNS_GROUPBY:= 'X.MALOAIVATTU, F.TENLOAIVT';
        P_SELECT_COLUMNS_GROUPBY:= ' X.MALOAIVATTU AS MA, F.TENLOAIVT AS TEN';
        P_TABLE_GROUPBY:= ' INNER JOIN DM_LOAIVATTU F ON X.MALOAIVATTU = F.MALOAIVATTU AND F.UNITCODE = '''||P_UNITCODE||''' ';
        P_ORDERBY := 'X.MALOAIVATTU, F.TENLOAIVT';
        END;

        ELSIF P_GROUPBY = 'MAKHACHHANG' THEN
        BEGIN
        P_SELECT_COLUMNS_GROUPBY:= 'X.MANHACUNGCAP AS MA,F.TENNCC AS TEN';
        P_TABLE_GROUPBY:= 'INNER JOIN DM_NHACUNGCAP F ON X.MANHACUNGCAP = F.MANCC AND F.UNITCODE = '''||P_UNITCODE||'''';   
        P_COLUMNS_GROUPBY:= 'X.MANHACUNGCAP,F.TENNCC';
        P_ORDERBY := 'X.MANHACUNGCAP,F.TENNCC';
        END;
        ELSE 
        BEGIN
        P_COLUMNS_GROUPBY:= 'X.MAVATTU,F.TENVATTU';
        P_SELECT_COLUMNS_GROUPBY:= 'X.MAVATTU AS MA,F.TENVATTU AS TEN';
        P_TABLE_GROUPBY:= 'INNER JOIN DM_VATTU F ON X.MAVATTU = F.MAVATTU AND F.UNITCODE = '''||P_UNITCODE||'''';   
        P_ORDERBY := 'X.MAVATTU,F.TENVATTU';
        END;
        END IF;  

         RESULT_STR:=' SELECT '||P_SELECT_COLUMNS_GROUPBY||',SUM(X.XBANLEQUAY_SL) AS XBANLEQUAY_SL,SUM(X.XBANLEQUAY_GT) AS XBANLEQUAY_GT,
         SUM(X.XBANLETL_SL) AS XBANLETL_SL, SUM(X.XBANLETL_GT) AS XBANLETL_GT,
         SUM(X.XUATBBQTN_SL) AS XUATBBQTN_SL, SUM(X.XUATBBQTN_GT) AS XUATBBQTN_GT,
         SUM(X.NMUA_SL) AS NMUA_SL,SUM(X.NMUA_GT) AS NMUA_GT,
         SUM(X.NHAPKIEMKE_SL) AS NHAPKIEMKE_SL,SUM(X.NHAPKIEMKE_GT) AS NHAPKIEMKE_GT,
         SUM(X.XUATKIEMKE_SL) AS XUATKIEMKE_SL,SUM(X.XUATKIEMKE_GT) AS XUATKIEMKE_GT,
         SUM(X.NHAPCHUYENKHO_SL) AS NHAPCHUYENKHO_SL,SUM(X.NHAPCHUYENKHO_GT) AS NHAPCHUYENKHO_GT,
         SUM(X.NHAPSTTHANHVIEN_SL) AS NHAPSTTHANHVIEN_SL,SUM(X.NHAPSTTHANHVIEN_GT) AS NHAPSTTHANHVIEN_GT,SUM(X.XUATCHUYENKHO_SL) AS XUATCHUYENKHO_SL,
         SUM(X.XUATCHUYENKHO_GT) AS XUATCHUYENKHO_GT,SUM(X.XUATSTTHANHVIEN_SL) AS XUATSTTHANHVIEN_SL,
         SUM(X.XUATSTTHANHVIEN_GT) AS XUATSTTHANHVIEN_GT,SUM(X.XBANLE_SL) AS XBANLE_SL,SUM(X.XBANLE_GT) AS XBANLE_GT,SUM(X.XUATBANBUON_SL) AS XUATBANBUON_SL,SUM(X.XUATBANBUON_GT) AS XUATBANBUON_GT,
         SUM(X.NHAPDIEUCHINH_SL) AS NHAPDIEUCHINH_SL,SUM(X.NHAPDIEUCHINH_GT) AS NHAPDIEUCHINH_GT,SUM(X.NHAPHANGAM_SL) AS NHAPHANGAM_SL,SUM(X.NHAPHANGAM_GT) AS NHAPHANGAM_GT,SUM(X.XUATHUYHH_SL) AS XUATHUYHH_SL,
         SUM(X.XUATHUYHH_GT) AS XUATHUYHH_GT,SUM(X.XUATHUY_SL) AS XUATHUY_SL,SUM(X.XUATHUY_GT) AS XUATHUY_GT,
         SUM(X.XUATTRANCC_SL) AS XUATTRANCC_SL,SUM(X.XUATTRANCC_GT) AS XUATTRANCC_GT,SUM(X.XUATDC_SL) AS XUATDC_SL,SUM(X.XUATDC_GT) AS XUATDC_GT,SUM(X.NHAPBANTL_SL) AS NHAPBANTL_SL,SUM(X.NHAPBANTL_GT) AS NHAPBANTL_GT,
         SUM(X.TONDAUKY_SL) AS TONDAUKY_SL, SUM(X.TONDAUKY_GT) AS TONDAUKY_GT, SUM(X.TONCUOIKY_SL) AS TONCUOIKY_SL, SUM(X.TONCUOIKY_GT) AS TONCUOIKY_GT
         FROM ('||RESULT_STR||') X 
         '||P_TABLE_GROUPBY||'
         GROUP BY '||P_COLUMNS_GROUPBY||' ORDER BY '||P_ORDERBY||'';      
          BEGIN
                --DBMS_OUTPUT.put_line (RESULT_STR);
                OPEN XTNCOLLECTION FOR RESULT_STR;
                EXCEPTION
                   WHEN NO_DATA_FOUND
                   THEN
                      DBMS_OUTPUT.put_line ('<your message>' || SQLERRM);
                   WHEN OTHERS
                   THEN
                      DBMS_OUTPUT.put_line (RESULT_STR  || SQLERRM);
         END;
END BAOCAO_XNTNEW_TONGHOP;
--------------------------------------------------------
--  DDL for Procedure BAOCAO_XNT_TONGHOP
--------------------------------------------------------
/
create or replace PROCEDURE "BAOCAO_XNTNEW_CHITIET" (P_GROUPBY IN VARCHAR2, P_MAKHO IN VARCHAR2, P_MALOAI IN VARCHAR2,  
P_MANHOM IN VARCHAR2,P_MAVATTU IN VARCHAR2, P_NHACUNGCAP IN VARCHAR2,
P_UNITCODE  IN VARCHAR2, 
P_TUNGAY IN DATE,P_DENNGAY IN DATE,P_USERNAME IN VARCHAR2, 
XTNCOLLECTION  OUT SYS_REFCURSOR) 
IS
    KY_BATDAU NUMBER;
    NAM_BATDAU NUMBER;
    KY_KETTHUC NUMBER;
    NAM_KETTHUC NUMBER;
    P_SQL_INSERT VARCHAR2(32767);
    QUERY_STR VARCHAR(32767);
    RESULT_STR VARCHAR(32767);
    P_SELECT_COLUMNS_GROUPBY VARCHAR(32767);
    P_TABLE_GROUPBY VARCHAR(32767);
    P_COLUMNS_GROUPBY VARCHAR(32767);
    P_SUB_GROUPBY VARCHAR(32767);
    P_SUB_SELECT_GROUPBY VARCHAR(32767);
    P_EXPRESSION VARCHAR(32767);
    P_ORDERBY VARCHAR(32767);
    CUR SYS_REFCURSOR;
    CHECK_EXIST_TABLE NUMBER(18,2) := 0;
    CREATE_TABLE VARCHAR(3000);
BEGIN
    DBMS_OUTPUT.ENABLE(1000000);
     CREATE_TABLE:= 'CREATE GLOBAL TEMPORARY TABLE "TBNETERP"."XUATNHAPTON_TEMP" 
   (	"MAVATTU" NVARCHAR2(50), 
	"MALOAIVATTU" NVARCHAR2(20), 
	"MANHOMVATTU" NVARCHAR2(20), 
	"MANHACUNGCAP" NVARCHAR2(20), 
	"MAKHO" NVARCHAR2(50), 
	"SOLUONG" NUMBER(17,4) DEFAULT 0, 
	"DONGIA" NUMBER(17,4) DEFAULT 0, 
	"THANHTIEN" NUMBER(17,4) DEFAULT 0, 
	"UNITCODE" NVARCHAR2(20), 
	"LOAICHUNGTU" NVARCHAR2(20), 
	"NGAYCHUNGTU" DATE, 
	"NGAYDUYETPHIEU" DATE,
    "USERNAME" NVARCHAR2(50)
   ) ON COMMIT PRESERVE ROWS';
    EXECUTE IMMEDIATE 'SELECT COUNT(*) FROM USER_TABLES WHERE TABLE_NAME = ''XUATNHAPTON_TEMP''' INTO CHECK_EXIST_TABLE;
    IF CHECK_EXIST_TABLE > 0 THEN DBMS_OUTPUT.PUT_LINE('ON CREATE');
    ELSE EXECUTE IMMEDIATE CREATE_TABLE;
    END IF;
    EXECUTE IMMEDIATE 'DELETE XUATNHAPTON_TEMP WHERE USERNAME = '''||P_USERNAME||''' AND UNITCODE = '''||P_UNITCODE||'''';
    --NHẬP MUA, NHẬP BÁN BUÔN TRẢ LẠI
    P_SQL_INSERT := 'INSERT INTO XUATNHAPTON_TEMP (MAVATTU, MALOAIVATTU, MANHOMVATTU, MANHACUNGCAP, MAKHO, SOLUONG, DONGIA, THANHTIEN, UNITCODE, LOAICHUNGTU, NGAYCHUNGTU, NGAYDUYETPHIEU, USERNAME)
         SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
          DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
          DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
          DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
          VATTUCHUNGTU.MAKHONHAP AS MAKHO,
          VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
          VATTUCHUNGTUCHITIET.GIAVON AS DONGIA,
          VATTUCHUNGTUCHITIET.GIAVON * VATTUCHUNGTUCHITIET.SOLUONG AS THANHTIEN,
          VATTUCHUNGTU.UNITCODE AS UNITCODE,
          VATTUCHUNGTU.LOAICHUNGTU AS LOAICHUNGTU,
          VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
          VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
          '''||P_USERNAME||''' AS USERNAME
          FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET ON VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
        WHERE VATTUCHUNGTU.LOAICHUNGTU IN (''NMUA'',''NHBANTL'') AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';        
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHONHAP IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;
        --XUẤT BÁN LẺ WEB
        P_SQL_INSERT := P_SQL_INSERT || ' UNION ALL
         SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
          DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
          DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
          DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
          VATTUCHUNGTU.MAKHOXUAT AS MAKHO,
          VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,       
          VATTUCHUNGTUCHITIET.GIAVON AS DONGIA,
          VATTUCHUNGTUCHITIET.GIAVON * VATTUCHUNGTUCHITIET.SOLUONG AS THANHTIEN,
          VATTUCHUNGTU.UNITCODE AS UNITCODE,
          VATTUCHUNGTU.LOAICHUNGTU AS LOAICHUNGTU,
          VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
          VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
          '''||P_USERNAME||''' AS USERNAME
          FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET ON VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
        WHERE VATTUCHUNGTU.LOAICHUNGTU=''XBANLE'' AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';        
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHOXUAT IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;     

            --XUẤT HỦY
             P_SQL_INSERT := P_SQL_INSERT || '
            UNION ALL
            SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
              DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              VATTUCHUNGTU.MAKHOXUAT AS MAKHO,
              VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
              VATTUCHUNGTUCHITIET.GIAVON AS DONGIA,
              VATTUCHUNGTUCHITIET.GIAVON * VATTUCHUNGTUCHITIET.SOLUONG AS THANHTIEN,
              VATTUCHUNGTU.UNITCODE AS UNITCODE,
              TO_NCHAR(''XUATHUY'') AS LOAICHUNGTU,
              VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
              VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
              FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET
              ON (VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK)
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
              WHERE VATTUCHUNGTU.LOAICHUNGTU = ''XKHAC'' AND VATTUCHUNGTU.MALYDOKHAC =''X1'' AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHOXUAT IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;

            --XUẤT TRẢ NHÀ CUNG CẤP
             P_SQL_INSERT := P_SQL_INSERT || '
            UNION ALL
             SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
              DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              VATTUCHUNGTU.MAKHOXUAT AS MAKHO,
              VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
              VATTUCHUNGTUCHITIET.GIAVON AS DONGIA,
              VATTUCHUNGTUCHITIET.GIAVON * VATTUCHUNGTUCHITIET.SOLUONG AS THANHTIEN,
              VATTUCHUNGTU.UNITCODE AS UNITCODE,
              TO_NCHAR(''XUATTRANCC'') AS LOAICHUNGTU,
              VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
              VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
              FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET
              ON (VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK)
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
              WHERE VATTUCHUNGTU.LOAICHUNGTU = ''XKHAC'' AND VATTUCHUNGTU.MALYDOKHAC =''X12'' AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHOXUAT IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;

           -- XUẤT ĐIỀU CHỈNH
             P_SQL_INSERT := P_SQL_INSERT || '
          UNION ALL
             SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
              DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              VATTUCHUNGTU.MAKHOXUAT AS MAKHO,
              VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
              VATTUCHUNGTUCHITIET.GIAVON AS DONGIA,
              VATTUCHUNGTUCHITIET.GIAVON * VATTUCHUNGTUCHITIET.SOLUONG AS THANHTIEN,
              VATTUCHUNGTU.UNITCODE AS UNITCODE,
              TO_NCHAR(''XUATDIEUCHINH'') AS LOAICHUNGTU,
              VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
              VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
              FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET
              ON (VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK)
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU  AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
              WHERE VATTUCHUNGTU.LOAICHUNGTU = ''XKHAC'' AND VATTUCHUNGTU.MALYDOKHAC =''X2'' AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHOXUAT IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;

            --XUẤT HỦY HÀNG HỎNG- CÓ 2 TRƯỜNG HỢP XUẤT HỦY HÀNG HỎNG -  1: CÓ MÃ LÝ DO X11 VÀ  2: MÃ LÝ DO NULL
             P_SQL_INSERT := P_SQL_INSERT || '
        UNION ALL
             SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
              DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              VATTUCHUNGTU.MAKHOXUAT AS MAKHO,
              VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
              VATTUCHUNGTUCHITIET.GIAVON AS DONGIA,
              VATTUCHUNGTUCHITIET.GIAVON * VATTUCHUNGTUCHITIET.SOLUONG AS THANHTIEN,
              VATTUCHUNGTU.UNITCODE AS UNITCODE,
              TO_NCHAR(''XUATHUYHANGHONG'') AS LOAICHUNGTU,
              VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
              VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
              FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET
              ON (VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK)
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
              WHERE VATTUCHUNGTU.LOAICHUNGTU = ''XKHAC'' AND (VATTUCHUNGTU.MALYDOKHAC IS NULL OR VATTUCHUNGTU.MALYDOKHAC = ''X11'' ) AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHOXUAT IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;
            ---NHẬP KHÁC -- NHẬP ĐIỀU CHỈNH
             P_SQL_INSERT := P_SQL_INSERT || '
                        UNION ALL
             SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
              DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              VATTUCHUNGTU.MAKHONHAP AS MAKHO,
              VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
              VATTUCHUNGTUCHITIET.GIAVON AS DONGIA,
              VATTUCHUNGTUCHITIET.GIAVON * VATTUCHUNGTUCHITIET.SOLUONG AS THANHTIEN,
              VATTUCHUNGTU.UNITCODE AS UNITCODE,
              TO_NCHAR(''NHAPDIEUCHINH'') AS LOAICHUNGTU,
              VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
              VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
              FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET
              ON (VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK)
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
              WHERE VATTUCHUNGTU.LOAICHUNGTU = ''NKHAC'' AND VATTUCHUNGTU.MALYDOKHAC =''N3'' AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHONHAP IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;
            ---NHẬP KHÁC ---NHẬP HÀNG XUẤT ÂM
             P_SQL_INSERT := P_SQL_INSERT || '
                        UNION ALL
             SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
            DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              VATTUCHUNGTU.MAKHONHAP AS MAKHO,
              VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
              VATTUCHUNGTUCHITIET.GIAVON AS DONGIA,
              VATTUCHUNGTUCHITIET.GIAVON * VATTUCHUNGTUCHITIET.SOLUONG AS THANHTIEN,
              VATTUCHUNGTU.UNITCODE AS UNITCODE,
              TO_NCHAR(''NHAPHANGAM'') AS LOAICHUNGTU,
              VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
              VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
              FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET
              ON (VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK)
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
              WHERE VATTUCHUNGTU.LOAICHUNGTU = ''NKHAC'' AND VATTUCHUNGTU.MALYDOKHAC =''N2'' AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHONHAP IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;
            -- NHẬP ĐIỀU CHUYỂN NỘI BỘ -- CÓ 2 TRƯỜNG HỢP: NHẬP CHUYỂN KHO VÀ NHẬP ST THÀNH VIÊN
            -- NHẬP CHUYỂN KHO
             P_SQL_INSERT := P_SQL_INSERT || '
             UNION ALL
             SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
              DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              VATTUCHUNGTU.MAKHONHAP AS MAKHO,
              VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
              VATTUCHUNGTUCHITIET.GIAVON AS DONGIA,
              VATTUCHUNGTUCHITIET.GIAVON * VATTUCHUNGTUCHITIET.SOLUONG AS THANHTIEN,
              VATTUCHUNGTU.UNITCODE AS UNITCODE,
              TO_NCHAR(''NHAPCHUYENKHO'') AS LOAICHUNGTU,
              VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
              VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
              FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET
              ON (VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK)
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU  AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
              WHERE VATTUCHUNGTU.LOAICHUNGTU = ''DCN'' AND VATTUCHUNGTU.MADONVIXUAT = VATTUCHUNGTU.UNITCODE AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHONHAP IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;
            -- NHẬP ST THÀNH VIÊN
             P_SQL_INSERT := P_SQL_INSERT || '
            UNION ALL
             SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
              DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              VATTUCHUNGTU.MAKHONHAP AS MAKHO,
              VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
              VATTUCHUNGTUCHITIET.GIAVON AS DONGIA,
              VATTUCHUNGTUCHITIET.GIAVON * VATTUCHUNGTUCHITIET.SOLUONG AS THANHTIEN,
              VATTUCHUNGTU.UNITCODE AS UNITCODE,
              TO_NCHAR(''NHAPSTTHANHVIEN'') AS LOAICHUNGTU,
              VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
              VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
              FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET
              ON (VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK)
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
              WHERE VATTUCHUNGTU.LOAICHUNGTU = ''DCN'' AND VATTUCHUNGTU.MADONVIXUAT <> VATTUCHUNGTU.UNITCODE AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHONHAP IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;
            -- XUẤT ĐIỀU CHUYỂN NỘ BỘ-- CÓ 2 TRƯỜNG HỢP: XUẤT CHUYỂN KHO VÀ XUẤT ST THÀNH VIÊN
            -- XUẤT CHUYỂN KHO
             P_SQL_INSERT := P_SQL_INSERT || '
            UNION ALL
             SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
              DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              VATTUCHUNGTU.MAKHOXUAT AS MAKHO,
              VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
              VATTUCHUNGTUCHITIET.GIAVON AS DONGIA,
              VATTUCHUNGTUCHITIET.GIAVON * VATTUCHUNGTUCHITIET.SOLUONG AS THANHTIEN,
              VATTUCHUNGTU.UNITCODE AS UNITCODE,
              TO_NCHAR(''XUATCHUYENKHO'') AS LOAICHUNGTU,
              VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
              VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
              FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET
              ON (VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK)
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU  AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
              WHERE VATTUCHUNGTU.LOAICHUNGTU = ''DCX'' AND VATTUCHUNGTU.MADONVINHAN = VATTUCHUNGTU.UNITCODE AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHOXUAT IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;
            -- XUẤT ST THÀNH VIÊN
             P_SQL_INSERT := P_SQL_INSERT || '
            UNION ALL
             SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
              DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              VATTUCHUNGTU.MAKHOXUAT AS MAKHO,
              VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
              VATTUCHUNGTUCHITIET.GIAVON AS DONGIA,
              VATTUCHUNGTUCHITIET.GIAVON * VATTUCHUNGTUCHITIET.SOLUONG AS THANHTIEN,
              VATTUCHUNGTU.UNITCODE AS UNITCODE,
              TO_NCHAR(''XUATSTTHANHVIEN'') AS LOAICHUNGTU,
              VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
              VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
              FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET
              ON (VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK)
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
              WHERE VATTUCHUNGTU.LOAICHUNGTU = ''DCX'' AND VATTUCHUNGTU.MADONVINHAN <> VATTUCHUNGTU.UNITCODE AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHOXUAT IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;
            -- XUẤT BÁN BUÔN
             P_SQL_INSERT := P_SQL_INSERT || ' UNION ALL
             SELECT VATTUCHUNGTUCHITIET.MAHANG AS MAVATTU,
              DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              VATTUCHUNGTU.MAKHOXUAT AS MAKHO,
              VATTUCHUNGTUCHITIET.SOLUONG AS SOLUONG,
              VATTUCHUNGTUCHITIET.GIAVON AS DONGIA,
              VATTUCHUNGTUCHITIET.GIAVON * VATTUCHUNGTUCHITIET.SOLUONG AS THANHTIEN,
              VATTUCHUNGTU.UNITCODE AS UNITCODE,
              TO_NCHAR(''XUATBANBUON'') AS LOAICHUNGTU,
              VATTUCHUNGTU.NGAYCHUNGTU AS NGAYCHUNGTU,
              VATTUCHUNGTU.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
              '''||P_USERNAME||''' AS USERNAME
              FROM VATTUCHUNGTU
              INNER JOIN VATTUCHUNGTUCHITIET
              ON (VATTUCHUNGTU.MACHUNGTUPK = VATTUCHUNGTUCHITIET.MACHUNGTUPK)
              INNER JOIN DM_VATTU ON VATTUCHUNGTUCHITIET.MAHANG = DM_VATTU.MAVATTU  AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
              WHERE VATTUCHUNGTU.LOAICHUNGTU = ''XBAN'' AND VATTUCHUNGTU.TRANGTHAI = 10 AND VATTUCHUNGTU.UNITCODE = '''||P_UNITCODE||''' AND TO_DATE(VATTUCHUNGTU.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTU.MAKHOXUAT IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND VATTUCHUNGTUCHITIET.MAHANG IN ('||P_MAVATTU||')';
            END IF;    
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;

            -------------------------------------
            --XUẤT BÁN LẺ - GIAO DỊCH QUẦY
            P_SQL_INSERT := P_SQL_INSERT || '
           UNION ALL
            SELECT hanggdquay.MAVATTU AS MAVATTU,
                     DM_VATTU.MALOAIVATTU AS MALOAIVATTU, 
                     DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
                     DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
                     hanggdquay.MAKHOHANG AS MAKHO,
                     hanggdquay.SOLUONG AS SOLUONG,
                     hanggdquay.GIAVON AS DONGIA,
                     hanggdquay.GIAVON * hanggdquay.SOLUONG AS THANHTIEN,
                     hanggdquay.MADONVI AS UNITCODE,
                     TO_NCHAR(gdquay.LOAIGIAODICH) AS LOAICHUNGTU,
                     gdquay.NGAYTAO AS NGAYCHUNGTU,
                     gdquay.NGAYPHATSINH AS NGAYDUYETPHIEU,
                     '''||P_USERNAME||''' AS USERNAME
            FROM NVGDQUAY_ASYNCCLIENT gdquay
               INNER JOIN NVHANGGDQUAY_ASYNCCLIENT hanggdquay
                  ON (gdquay.MAGIAODICHQUAYPK = hanggdquay.MAGDQUAYPK)
              INNER JOIN DM_VATTU ON hanggdquay.MAVATTU = DM_VATTU.MAVATTU  AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
                  WHERE hanggdquay.MADONVI = '''||P_UNITCODE||''' 
                  AND TO_DATE(gdquay.NGAYPHATSINH,''DD/MM/YY'') 
                  BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';  
                   IF TRIM(P_MAKHO) IS NOT NULL THEN
                    P_SQL_INSERT := P_SQL_INSERT||' AND hanggdquay.MAKHOHANG IN ('||P_MAKHO||')';
                    END IF;
                    IF TRIM(P_MALOAI) IS NOT NULL THEN
                    P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
                    END IF;
                    IF TRIM(P_MANHOM) IS NOT NULL THEN
                    P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
                    END IF;
                    IF TRIM(P_MAVATTU) IS NOT NULL THEN
                    P_SQL_INSERT := P_SQL_INSERT||' AND hanggdquay.MAVATTU IN ('||P_MAVATTU||')';
                    END IF;
                    IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
                    P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
                    END IF;
            -- NHẬP KIỂM KÊ
            P_SQL_INSERT := P_SQL_INSERT || '
            UNION ALL
            SELECT kiemkechitiet.MAVATTU AS MAVATTU,
            kiemkechitiet.LOAIVATTUKK AS MALOAIVATTU,
            kiemkechitiet.NHOMVATTUKK AS MANHOMVATTU,
            DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
            kiemke.KHOKIEMKE AS MAKHO,
            kiemkechitiet.SOLUONGCHENHLECH AS SOLUONG,
            kiemkechitiet.GIAVON AS DONGIA,
            kiemkechitiet.SOLUONGCHENHLECH * kiemkechitiet.GIAVON AS THANHTIEN,
            kiemkechitiet.MADONVI AS UNITCODE,
            TO_NCHAR(''NHAPKIEMKE'') AS LOAICHUNGTU,
            kiemke.NGAYKIEMKE AS NGAYCHUNGTU,
            kiemke.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
            '''||P_USERNAME||''' AS USERNAME
            FROM NVKIEMKE kiemke INNER JOIN NVKIEMKECHITIET kiemkechitiet 
            ON (kiemke.MAPHIEUKIEMKE = kiemkechitiet.MAPHIEUKIEMKE)
              INNER JOIN DM_VATTU ON kiemkechitiet.MAVATTU = DM_VATTU.MAVATTU  AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
            WHERE kiemke.TRANGTHAI = 10 AND kiemkechitiet.MADONVI = '''||P_UNITCODE||''' AND kiemkechitiet.SOLUONGCHENHLECH < 0 AND TO_DATE(kiemke.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND kiemke.KHOKIEMKE IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND kiemkechitiet.LOAIVATTUKK  IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND kiemkechitiet.NHOMVATTUKK IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND  kiemkechitiet.MAVATTU IN ('||P_MAVATTU||')';  
            END IF;
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;

         -- XUẤT KIỂM KÊ
         P_SQL_INSERT := P_SQL_INSERT || '
            UNION ALL
            SELECT kiemkechitiet.MAVATTU AS MAVATTU,
            kiemkechitiet.LOAIVATTUKK AS MALOAIVATTU,
            kiemkechitiet.NHOMVATTUKK AS MANHOMVATTU,
            DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
            kiemke.KHOKIEMKE AS MAKHO,
            kiemkechitiet.SOLUONGCHENHLECH AS SOLUONG,
            kiemkechitiet.GIAVON AS DONGIA,
            kiemkechitiet.SOLUONGCHENHLECH * kiemkechitiet.GIAVON AS THANHTIEN,
            kiemkechitiet.MADONVI AS UNITCODE,
            TO_NCHAR(''XUATKIEMKE'') AS LOAICHUNGTU,
            kiemke.NGAYKIEMKE AS NGAYCHUNGTU,
            kiemke.NGAYDUYETPHIEU AS NGAYDUYETPHIEU,
            '''||P_USERNAME||''' AS USERNAME
            FROM NVKIEMKE kiemke INNER JOIN NVKIEMKECHITIET kiemkechitiet 
            ON (kiemke.MAPHIEUKIEMKE = kiemkechitiet.MAPHIEUKIEMKE)
            INNER JOIN DM_VATTU ON kiemkechitiet.MAVATTU = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
            WHERE kiemke.TRANGTHAI = 10 AND kiemkechitiet.MADONVI = '''||P_UNITCODE||''' AND kiemkechitiet.SOLUONGCHENHLECH >= 0 AND TO_DATE(kiemke.NGAYDUYETPHIEU,''DD/MM/YY'') BETWEEN TO_DATE('''||P_TUNGAY||''', ''DD/MM/YY'') AND TO_DATE('''||P_DENNGAY||''', ''DD/MM/YY'')';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND kiemke.KHOKIEMKE IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND kiemkechitiet.LOAIVATTUKK  IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND kiemkechitiet.NHOMVATTUKK IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND  kiemkechitiet.MAVATTU IN ('||P_MAVATTU||')'; 
            END IF;
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;

        -- GET KY, NAM CUA BANG XNT DAU KY
        BEGIN
        SELECT KY, NAM INTO KY_BATDAU, NAM_BATDAU FROM DM_KYKETOAN WHERE TO_DATE(DENNGAY, 'dd/MM/yyyy') = TO_DATE(P_TUNGAY, 'dd/MM/yyyy') AND UNITCODE = P_UNITCODE AND TRANGTHAI = 10;
           EXCEPTION
                    WHEN NO_DATA_FOUND THEN
                    DBMS_OUTPUT.PUT_LINE(SQLERRM);   
        END;--End 
         --LAY TON DAU KY TRONG BANG XNT
         P_SQL_INSERT := P_SQL_INSERT || '
            UNION ALL
            SELECT TDK.MAVATTU AS MAVATTU,
              DM_VATTU.MALOAIVATTU AS MALOAIVATTU,
              DM_VATTU.MANHOMVATTU AS  MANHOMVATTU,
              DM_VATTU.MAKHACHHANG AS MANHACUNGCAP,
              TDK.MAKHO AS MAKHO,
              TDK.TONDAUKYSL AS SOLUONG,
              TDK.GIAVON AS DONGIA,
              TDK.TONDAUKYSL * TDK.GIAVON AS THANHTIEN,
              TDK.UNITCODE AS UNITCODE,
              TO_NCHAR(''TONDAUKY'') AS LOAICHUNGTU,
              TO_DATE('''||P_TUNGAY||''',''dd/MM/yyyy'') AS NGAYCHUNGTU,
              TO_DATE('''||P_TUNGAY||''',''dd/MM/yyyy'') AS NGAYDUYETPHIEU,
               '''||P_USERNAME||''' AS USERNAME
            FROM XNT_'||NAM_BATDAU||'_KY_'||KY_BATDAU||' TDK 
            INNER JOIN DM_VATTU ON TDK.MAVATTU = DM_VATTU.MAVATTU AND DM_VATTU.UNITCODE = '''||P_UNITCODE||'''
            WHERE TDK.UNITCODE = '''||P_UNITCODE||''' AND TDK.TONDAUKYSL <> 0 ';
            IF TRIM(P_MAKHO) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND TDK.MAKHO IN ('||P_MAKHO||')';
            END IF;
            IF TRIM(P_MALOAI) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MALOAIVATTU IN ('||P_MALOAI||')';
            END IF;
            IF TRIM(P_MANHOM) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MANHOMVATTU IN ('||P_MANHOM||')';
            END IF;
            IF TRIM(P_MAVATTU) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND TDK.MAVATTU IN ('||P_MAVATTU||')';
            END IF;
            IF TRIM(P_NHACUNGCAP) IS NOT NULL THEN
            P_SQL_INSERT := P_SQL_INSERT||' AND DM_VATTU.MAKHACHHANG IN ('||P_NHACUNGCAP||')';
            END IF;


        BEGIN
            --DBMS_OUTPUT.put_line(P_SQL_INSERT);
            EXECUTE IMMEDIATE P_SQL_INSERT;
            EXCEPTION WHEN OTHERS THEN  
            DBMS_OUTPUT.PUT_LINE(P_SQL_INSERT || SQLERRM);   
        END;

                          --QUERY_STR :='SELECT * FROM XUATNHAPTON_TEMP';
                         -- OPEN XTNCOLLECTION FOR QUERY_STR;
        ---NMUA,XBANLE,NHBANTL, XUATBANBUON, ||||||
        ---XUATHUYHANGHONG,XUATHUY,XUATTRANCC,XUATDIEUCHINH,NHAPDIEUCHINH,NHAPHANGAM,1,2,KIEMKE
        --XUATNHAPTON_TEMP (MAVATTU, MALOAIVATTU, MANHOMVATTU,MANHACUNGCAP,MAKHO,SOLUONG,DONGIA,THANHTIEN,UNITCODE, LOAICHUNGTU,NGAYCHUNGTU,NGAYDUYETPHIEU)
        QUERY_STR := '
        SELECT a.MAVATTU,a.MALOAIVATTU,a.MAKHO,a.MANHACUNGCAP,a.MANHOMVATTU,a.DONGIA,a.UNITCODE,a.NGAYCHUNGTU,a.NGAYDUYETPHIEU,
        NVL(a.XUATBANLEQUAY_SUM_SOLUONG,0) AS XBANLEQUAY_SL , NVL(a.XUATBANLEQUAY_SUM_THANHTIEN,0) AS XBANLEQUAY_GT,
        NVL(a.XUATBANLETRALAI_SUM_SOLUONG,0) AS XBANLETL_SL  , NVL(a.XUATBANLETRALAI_SUM_THANHTIEN,0) AS XBANLETL_GT,
        NVL(a.XUATBBQTN_SUM_SOLUONG,0) AS XUATBBQTN_SL , NVL(a.XUATBBQTN_SUM_THANHTIEN,0) AS XUATBBQTN_GT,
        NVL(a.NMUA_SUM_SOLUONG,0) AS NMUA_SL , NVL(a.NMUA_SUM_THANHTIEN,0) AS NMUA_GT,
        NVL(a.NHAPKIEMKE_SUM_SOLUONG,0) AS NHAPKIEMKE_SL, NVL(a.NHAPKIEMKE_SUM_THANHTIEN,0) AS NHAPKIEMKE_GT,
        NVL(a.XUATKIEMKE_SUM_SOLUONG,0) AS XUATKIEMKE_SL, NVL(a.XUATKIEMKE_SUM_THANHTIEN,0) AS XUATKIEMKE_GT,
        NVL(a.XUATBANLE_SUM_SOLUONG,0) AS XBANLE_SL, NVL(a.XUATBANLE_SUM_THANHTIEN,0) AS XBANLE_GT,
        NVL(a.NHAPCHUYENKHO_SUM_SOLUONG,0) AS NHAPCHUYENKHO_SL, NVL(a.NHAPCHUYENKHO_SUM_THANHTIEN,0) AS NHAPCHUYENKHO_GT,
        NVL(a.NHAPSTTHANHVIEN_SUM_SOLUONG,0) AS NHAPSTTHANHVIEN_SL, NVL(a.NHAPSTTHANHVIEN_SUM_THANHTIEN,0) AS NHAPSTTHANHVIEN_GT,
        NVL(a.XUATCHUYENKHO_SUM_SOLUONG,0) AS XUATCHUYENKHO_SL, NVL(a.XUATCHUYENKHO_SUM_THANHTIEN,0) AS XUATCHUYENKHO_GT,
        NVL(a.XUATSTTHANHVIEN_SUM_SOLUONG,0) AS XUATSTTHANHVIEN_SL, NVL(a.XUATSTTHANHVIEN_SUM_THANHTIEN,0) AS XUATSTTHANHVIEN_GT,
        NVL(a.NHAPDIEUCHINH_SUM_SOLUONG,0) AS NHAPDIEUCHINH_SL, NVL(a.NHAPDIEUCHINH_SUM_THANHTIEN,0) AS NHAPDIEUCHINH_GT,
        NVL(a.XUATBANBUON_SUM_SOLUONG,0) AS XUATBANBUON_SL, NVL(a.XUATBANBUON_SUM_THANHTIEN,0) AS XUATBANBUON_GT,
        NVL(a.NHAPHANGAM_SUM_SOLUONG,0) AS NHAPHANGAM_SL, NVL(a.NHAPHANGAM_SUM_THANHTIEN,0) AS NHAPHANGAM_GT,
        NVL(a.XUATHUYHANGHONG_SUM_SOLUONG,0) AS XUATHUYHH_SL, NVL(a.XUATHUYHANGHONG_SUM_THANHTIEN,0) AS XUATHUYHH_GT,
        NVL(a.XUATHUY_SUM_SOLUONG,0) AS XUATHUY_SL, NVL(a.XUATHUY_SUM_THANHTIEN,0) AS XUATHUY_GT,
        NVL(a.XUATTRANCC_SUM_SOLUONG,0) AS XUATTRANCC_SL, NVL(a.XUATTRANCC_SUM_THANHTIEN,0) AS XUATTRANCC_GT,
        NVL(a.XUATDIEUCHINH_SUM_SOLUONG,0) AS XUATDC_SL, NVL(a.XUATDIEUCHINH_SUM_THANHTIEN,0) AS XUATDC_GT,
        NVL(a.NHBANTL_SUM_SOLUONG,0) AS NHAPBANTL_SL, NVL(a.NHBANTL_SUM_THANHTIEN,0) AS NHAPBANTL_GT,
        NVL(a.TONDAUKY_SUM_SOLUONG,0) AS TONDAUKY_SL, NVL(a.TONDAUKY_SUM_THANHTIEN,0) AS TONDAUKY_GT
        FROM (
            SELECT MAVATTU, MALOAIVATTU, MANHOMVATTU,SOLUONG, DONGIA,THANHTIEN,UNITCODE,MAKHO,MANHACUNGCAP,LOAICHUNGTU,NGAYCHUNGTU,NGAYDUYETPHIEU FROM XUATNHAPTON_TEMP)
            PIVOT ( SUM(SOLUONG) AS SUM_SOLUONG, SUM(NVL(THANHTIEN,0)) as SUM_THANHTIEN
              FOR LOAICHUNGTU
              IN (''1'' AS XUATBANLEQUAY,''2'' AS XUATBANLETRALAI,''3'' AS XUATBBQTN, ''NMUA'' AS NMUA, ''NHAPKIEMKE'' AS NHAPKIEMKE,''XUATKIEMKE'' AS XUATKIEMKE, ''NHAPCHUYENKHO'' AS NHAPCHUYENKHO, ''NHAPSTTHANHVIEN'' AS NHAPSTTHANHVIEN, ''XUATCHUYENKHO'' AS XUATCHUYENKHO, 
              ''XUATSTTHANHVIEN'' AS XUATSTTHANHVIEN, ''XBANLE'' AS XUATBANLE,''NHAPDIEUCHINH'' AS NHAPDIEUCHINH,''NHAPHANGAM'' AS NHAPHANGAM,''XUATHUYHANGHONG'' AS XUATHUYHANGHONG,''XUATHUY'' AS XUATHUY, ''XUATBANBUON'' AS XUATBANBUON,
              ''XUATTRANCC'' AS XUATTRANCC,''XUATDIEUCHINH'' AS XUATDIEUCHINH,''NHBANTL'' AS NHBANTL,''TONDAUKY'' AS TONDAUKY)
        ) a ORDER BY a.MAVATTU,a.MALOAIVATTU,a.MANHOMVATTU,a.NGAYDUYETPHIEU';



        --Group sau khi Pivot
        QUERY_STR  :=' SELECT U.MAVATTU,U.MALOAIVATTU, U.MANHOMVATTU, U.UNITCODE,U.MAKHO,U.MANHACUNGCAP,
        SUM(U.XBANLEQUAY_SL) AS XBANLEQUAY_SL , SUM(U.XBANLEQUAY_GT) AS XBANLEQUAY_GT,
        SUM(U.XBANLETL_SL) AS XBANLETL_SL  , SUM(U.XBANLETL_GT) AS XBANLETL_GT,
        SUM(U.XUATBBQTN_SL) AS XUATBBQTN_SL  , SUM(U.XUATBBQTN_GT) AS XUATBBQTN_GT,
        SUM(U.NMUA_SL) AS NMUA_SL , SUM(U.NMUA_GT) AS NMUA_GT,
        SUM(U.NHAPKIEMKE_SL) AS NHAPKIEMKE_SL, SUM(U.NHAPKIEMKE_GT) AS NHAPKIEMKE_GT,
        SUM(U.XUATKIEMKE_SL) AS XUATKIEMKE_SL, SUM(U.XUATKIEMKE_GT) AS XUATKIEMKE_GT,
        SUM(U.NHAPCHUYENKHO_SL) AS NHAPCHUYENKHO_SL, SUM(U.NHAPCHUYENKHO_GT) AS NHAPCHUYENKHO_GT,
        SUM(U.NHAPSTTHANHVIEN_SL) AS NHAPSTTHANHVIEN_SL, SUM(U.NHAPSTTHANHVIEN_GT) AS NHAPSTTHANHVIEN_GT,
        SUM(U.XUATCHUYENKHO_SL) AS XUATCHUYENKHO_SL, SUM(U.XUATCHUYENKHO_GT) AS XUATCHUYENKHO_GT,
        SUM(U.XUATSTTHANHVIEN_SL) AS XUATSTTHANHVIEN_SL, SUM(U.XUATSTTHANHVIEN_GT) AS XUATSTTHANHVIEN_GT,
        SUM(U.XBANLE_SL) AS XBANLE_SL, SUM(U.XBANLE_GT) AS XBANLE_GT,
        SUM(U.XUATBANBUON_SL) AS XUATBANBUON_SL, SUM(U.XUATBANBUON_GT) AS XUATBANBUON_GT,
        SUM(U.NHAPDIEUCHINH_SL) AS NHAPDIEUCHINH_SL, SUM(U.NHAPDIEUCHINH_GT) AS NHAPDIEUCHINH_GT,
        SUM(U.NHAPHANGAM_SL) AS NHAPHANGAM_SL, SUM(U.NHAPHANGAM_GT) AS NHAPHANGAM_GT,
        SUM(U.XUATHUYHH_SL) AS XUATHUYHH_SL, SUM(U.XUATHUYHH_GT) AS XUATHUYHH_GT,
        SUM(U.XUATHUY_SL) AS XUATHUY_SL, SUM(U.XUATHUY_GT) AS XUATHUY_GT,
        SUM(U.XUATTRANCC_SL) AS XUATTRANCC_SL, SUM(U.XUATTRANCC_GT) AS XUATTRANCC_GT,
        SUM(U.XUATDC_SL) AS XUATDC_SL, SUM(U.XUATDC_GT) AS XUATDC_GT,
        SUM(U.NHAPBANTL_SL) AS NHAPBANTL_SL, SUM(U.NHAPBANTL_GT) AS NHAPBANTL_GT,
        SUM(U.TONDAUKY_SL) AS TONDAUKY_SL, SUM(U.TONDAUKY_GT) AS TONDAUKY_GT
        FROM ('||QUERY_STR||') U 
        GROUP BY U.MAVATTU,U.MALOAIVATTU, U.MANHOMVATTU, U.UNITCODE, U.MAKHO,U.MANHACUNGCAP
        '; 


        --TÌM BẢNG XUẤT NHẬP TỒN CUỐI KỲ
        BEGIN

        SELECT KY, NAM INTO KY_KETTHUC, NAM_KETTHUC FROM DM_KYKETOAN WHERE TO_DATE(DENNGAY, 'dd/MM/yyyy') = TO_DATE(P_DENNGAY, 'dd/MM/yyyy') AND UNITCODE = P_UNITCODE AND TRANGTHAI = 10;
           EXCEPTION
                    WHEN NO_DATA_FOUND THEN
                    DBMS_OUTPUT.PUT_LINE(SQLERRM);   
        END;--End TÌM KỲ
        RESULT_STR := '
        SELECT H.MAVATTU,H.MALOAIVATTU, H.MANHOMVATTU, H.UNITCODE,H.MAKHO,H.MANHACUNGCAP,
        NVL(H.XBANLEQUAY_SL,0) AS XBANLEQUAY_SL, NVL(H.XBANLEQUAY_GT,0) AS XBANLEQUAY_GT,
        NVL(H.XBANLETL_SL,0) AS XBANLETL_SL , NVL(H.XBANLETL_GT,0) AS XBANLETL_GT,
        NVL(H.XUATBBQTN_SL,0) AS XUATBBQTN_SL , NVL(H.XUATBBQTN_GT,0) AS XUATBBQTN_GT,
        NVL(H.NMUA_SL,0) AS NMUA_SL, NVL(H.NMUA_GT,0) AS NMUA_GT,
        NVL(H.NHAPKIEMKE_SL,0) AS NHAPKIEMKE_SL, NVL(H.NHAPKIEMKE_GT,0) AS NHAPKIEMKE_GT,
        NVL(H.XUATKIEMKE_SL,0) AS XUATKIEMKE_SL, NVL(H.XUATKIEMKE_GT,0) AS XUATKIEMKE_GT ,
        NVL(H.NHAPCHUYENKHO_SL,0) AS NHAPCHUYENKHO_SL, NVL(H.NHAPCHUYENKHO_GT,0) AS NHAPCHUYENKHO_GT,
        NVL(H.NHAPSTTHANHVIEN_SL,0) AS NHAPSTTHANHVIEN_SL, NVL(H.NHAPSTTHANHVIEN_GT,0) AS NHAPSTTHANHVIEN_GT,
        NVL(H.XUATCHUYENKHO_SL,0) AS XUATCHUYENKHO_SL, NVL(H.XUATCHUYENKHO_GT,0) AS XUATCHUYENKHO_GT,
        NVL(H.XUATSTTHANHVIEN_SL,0) AS XUATSTTHANHVIEN_SL, NVL(H.XUATSTTHANHVIEN_GT,0) AS XUATSTTHANHVIEN_GT,
        NVL(H.XBANLE_SL,0) AS XBANLE_SL, NVL(H.XBANLE_GT,0) AS XBANLE_GT,
        NVL(H.XUATBANBUON_SL,0) AS XUATBANBUON_SL, NVL(H.XUATBANBUON_GT,0) AS XUATBANBUON_GT,
        NVL(H.NHAPDIEUCHINH_SL,0) AS NHAPDIEUCHINH_SL, NVL(H.NHAPDIEUCHINH_GT,0) AS NHAPDIEUCHINH_GT,
        NVL(H.NHAPHANGAM_SL,0) AS NHAPHANGAM_SL, NVL(H.NHAPHANGAM_GT,0) AS NHAPHANGAM_GT,
        NVL(H.XUATHUYHH_SL,0) AS XUATHUYHH_SL, NVL(H.XUATHUYHH_GT,0) AS XUATHUYHH_GT,
        NVL(H.XUATHUY_SL,0) AS XUATHUY_SL, NVL(H.XUATHUY_GT,0) AS XUATHUY_GT,
        NVL(H.XUATTRANCC_SL,0) AS XUATTRANCC_SL, NVL(H.XUATTRANCC_GT,0) AS XUATTRANCC_GT,
        NVL(H.XUATDC_SL,0) AS XUATDC_SL, NVL(H.XUATDC_GT,0) AS XUATDC_GT,
        NVL(H.NHAPBANTL_SL,0) AS NHAPBANTL_SL, NVL(H.NHAPBANTL_GT,0) AS NHAPBANTL_GT,
        NVL(H.TONDAUKY_SL,0) AS TONDAUKY_SL,NVL(H.TONDAUKY_GT,0) AS TONDAUKY_GT,NVL(C.TONCUOIKYSL,0) AS TONCUOIKY_SL,NVL(C.TONCUOIKYGT,0) AS TONCUOIKY_GT
        FROM ('||QUERY_STR||') H 
        LEFT JOIN XNT_'|| NAM_KETTHUC ||'_KY_'||KY_KETTHUC||' C ON H.MAVATTU = C.MAVATTU AND H.MAKHO = C.MAKHO AND H.UNITCODE = C.UNITCODE 
        ';
        --START RETURN RESULT...
        IF P_GROUPBY = 'MAKHO' THEN
        BEGIN
        P_COLUMNS_GROUPBY:= 'X.MAKHO, F.TENKHO,X.MAVATTU,G.TENVATTU';
        P_SELECT_COLUMNS_GROUPBY:= 'X.MAKHO AS MACHA, F.TENKHO AS TENCHA,X.MAVATTU AS MACON, G.TENVATTU AS TENCON';
        P_TABLE_GROUPBY:= ' LEFT JOIN DM_KHO F ON X.MAKHO = F.MAKHO AND F.UNITCODE = '''||P_UNITCODE||''' ';
        P_ORDERBY := 'X.MAKHO, F.TENKHO,X.MAVATTU,G.TENVATTU';
        END;

        ELSIF P_GROUPBY = 'MANHOMVATTU' THEN
        BEGIN
        P_COLUMNS_GROUPBY:= 'X.MANHOMVATTU, F.TENNHOMVT,X.MAVATTU,G.TENVATTU';
        P_SELECT_COLUMNS_GROUPBY:= ' X.MANHOMVATTU AS MACHA, F.TENNHOMVT AS TENCHA,X.MAVATTU AS MACON, G.TENVATTU AS TENCON';
        P_TABLE_GROUPBY:= ' LEFT JOIN DM_NHOMVATTU F ON X.MANHOMVATTU = F.MANHOMVTU AND F.UNITCODE = '''||P_UNITCODE||''' ';
        P_ORDERBY := 'X.MANHOMVATTU, F.TENNHOMVT,X.MAVATTU,G.TENVATTU';
        END;

        ELSIF P_GROUPBY = 'MALOAIVATTU' THEN
        BEGIN
        P_COLUMNS_GROUPBY:= 'X.MALOAIVATTU, F.TENLOAIVT,X.MAVATTU,G.TENVATTU';
        P_SELECT_COLUMNS_GROUPBY:= ' X.MALOAIVATTU AS MACHA, F.TENLOAIVT AS TENCHA,X.MAVATTU AS MACON, G.TENVATTU AS TENCON';
        P_TABLE_GROUPBY:= ' LEFT JOIN DM_LOAIVATTU F ON X.MALOAIVATTU = F.MALOAIVATTU AND F.UNITCODE = '''||P_UNITCODE||''' ';
        P_ORDERBY := 'X.MALOAIVATTU, F.TENLOAIVT,X.MAVATTU,G.TENVATTU';
        END;

        ELSIF P_GROUPBY = 'MAKHACHHANG' THEN
        BEGIN
        P_SELECT_COLUMNS_GROUPBY:= 'X.MANHACUNGCAP AS MACHA,F.TENNCC AS TENCHA,X.MAVATTU AS TENCON, G.TENVATTU AS TENCON';
        P_TABLE_GROUPBY:= 'LEFT JOIN DM_NHACUNGCAP F ON X.MANHACUNGCAP = F.MANCC AND F.UNITCODE = '''||P_UNITCODE||''' ';   
        P_COLUMNS_GROUPBY:= 'X.MANHACUNGCAP,F.TENNCC,X.MAVATTU,G.TENVATTU';
        P_ORDERBY := 'X.MANHACUNGCAP,F.TENNCC,X.MAVATTU,G.TENVATTU';
        END;
        ELSE 
        BEGIN
        P_COLUMNS_GROUPBY:= 'X.MAVATTU,G.TENVATTU';
        P_SELECT_COLUMNS_GROUPBY:= 'X.MAVATTU AS MACHA,G.TENVATTU AS TENCHA,X.MAVATTU AS MACON,G.TENVATTU AS TENCON';
        P_TABLE_GROUPBY:= '';   
        P_ORDERBY := 'X.MAVATTU,G.TENVATTU';
        END;
        END IF;  

         RESULT_STR:=' SELECT '||P_SELECT_COLUMNS_GROUPBY||',SUM(X.XBANLEQUAY_SL) AS XBANLEQUAY_SL,SUM(X.XBANLEQUAY_GT) AS XBANLEQUAY_GT,
         SUM(X.XBANLETL_SL) AS XBANLETL_SL, SUM(X.XBANLETL_GT) AS XBANLETL_GT,
         SUM(X.XUATBBQTN_SL) AS XUATBBQTN_SL, SUM(X.XUATBBQTN_GT) AS XUATBBQTN_GT,
         SUM(X.NMUA_SL) AS NMUA_SL,SUM(X.NMUA_GT) AS NMUA_GT,
         SUM(X.NHAPKIEMKE_SL) AS NHAPKIEMKE_SL,SUM(X.NHAPKIEMKE_GT) AS NHAPKIEMKE_GT,
         SUM(X.XUATKIEMKE_SL) AS XUATKIEMKE_SL,SUM(X.XUATKIEMKE_GT) AS XUATKIEMKE_GT,
         SUM(X.NHAPCHUYENKHO_SL) AS NHAPCHUYENKHO_SL,SUM(X.NHAPCHUYENKHO_GT) AS NHAPCHUYENKHO_GT,
         SUM(X.NHAPSTTHANHVIEN_SL) AS NHAPSTTHANHVIEN_SL,SUM(X.NHAPSTTHANHVIEN_GT) AS NHAPSTTHANHVIEN_GT,SUM(X.XUATCHUYENKHO_SL) AS XUATCHUYENKHO_SL,
         SUM(X.XUATCHUYENKHO_GT) AS XUATCHUYENKHO_GT,SUM(X.XUATSTTHANHVIEN_SL) AS XUATSTTHANHVIEN_SL,
         SUM(X.XUATSTTHANHVIEN_GT) AS XUATSTTHANHVIEN_GT,SUM(X.XBANLE_SL) AS XBANLE_SL,SUM(X.XBANLE_GT) AS XBANLE_GT,SUM(X.XUATBANBUON_SL) AS XUATBANBUON_SL,SUM(X.XUATBANBUON_GT) AS XUATBANBUON_GT,
         SUM(X.NHAPDIEUCHINH_SL) AS NHAPDIEUCHINH_SL,SUM(X.NHAPDIEUCHINH_GT) AS NHAPDIEUCHINH_GT,SUM(X.NHAPHANGAM_SL) AS NHAPHANGAM_SL,SUM(X.NHAPHANGAM_GT) AS NHAPHANGAM_GT,SUM(X.XUATHUYHH_SL) AS XUATHUYHH_SL,
         SUM(X.XUATHUYHH_GT) AS XUATHUYHH_GT,SUM(X.XUATHUY_SL) AS XUATHUY_SL,SUM(X.XUATHUY_GT) AS XUATHUY_GT,
         SUM(X.XUATTRANCC_SL) AS XUATTRANCC_SL,SUM(X.XUATTRANCC_GT) AS XUATTRANCC_GT,SUM(X.XUATDC_SL) AS XUATDC_SL,SUM(X.XUATDC_GT) AS XUATDC_GT,SUM(X.NHAPBANTL_SL) AS NHAPBANTL_SL,SUM(X.NHAPBANTL_GT) AS NHAPBANTL_GT,
         SUM(X.TONDAUKY_SL) AS TONDAUKY_SL, SUM(X.TONDAUKY_GT) AS TONDAUKY_GT, SUM(X.TONCUOIKY_SL) AS TONCUOIKY_SL, SUM(X.TONCUOIKY_GT) AS TONCUOIKY_GT
         FROM ('||RESULT_STR||') X  
         LEFT JOIN DM_VATTU G ON X.MAVATTU = G.MAVATTU AND G.UNITCODE = '''||P_UNITCODE||'''
         '||P_TABLE_GROUPBY||'
         GROUP BY '||P_COLUMNS_GROUPBY||' ORDER BY '||P_ORDERBY||'';      
          BEGIN
                DBMS_OUTPUT.put_line (RESULT_STR);
                OPEN XTNCOLLECTION FOR RESULT_STR;
                EXCEPTION
                   WHEN NO_DATA_FOUND
                   THEN
                      DBMS_OUTPUT.put_line ('<your message>' || SQLERRM);
                   WHEN OTHERS
                   THEN
                      DBMS_OUTPUT.put_line (RESULT_STR  || SQLERRM);
         END;
END BAOCAO_XNTNEW_CHITIET;
--------------------------------------------------------
--  DDL for Procedure BAOCAO_XNTNEW_CHITIET
--------------------------------------------------------
/